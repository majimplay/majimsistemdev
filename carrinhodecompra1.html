<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>üõí Carrinho de Compras</title>
    <style>
        /* Estilos CSS permanecem os mesmos */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid #eee;
        }
        .profile-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #007BFF;
            margin-right: 2rem;
        }
        .profile-info h1 {
            margin: 0;
            color: #333;
        }
        .profile-info p {
            color: #666;
            margin: 0.5rem 0;
        }
        .carrinho {
            margin: 40px 0;
        }
        .produto {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px; /* Aumentar padding vertical */
            border-bottom: 1px solid #eee;
            gap: 15px; /* Espa√ßo entre conte√∫do e bot√£o */
        }
        .produto-info {
             flex-grow: 1; /* Ocupa espa√ßo dispon√≠vel */
        }
        .produto-info h4 {
            margin: 0 0 5px 0; /* Espa√ßo abaixo do nome */
            color: #333;
        }
        .produto-info p {
            margin: 3px 0; /* Menos espa√ßo entre par√°grafos */
            font-size: 0.9em;
            color: #555;
        }
        .produto-info .subtotal-item {
            font-weight: bold;
            color: #007BFF;
            margin-top: 8px;
        }

        .total {
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: bold;
            text-align: right;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap; /* Evita quebra de linha no bot√£o */
        }
        .btn-primary {
            background: #007BFF;
            color: white;
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-danger { /* Estilo para bot√£o remover */
             background: #dc3545;
             color: white;
             padding: 0.5rem 1rem; /* Bot√£o menor */
             font-size: 0.9em;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .form-section {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        label { /* Estilo para labels */
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9em;
            color: #555;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc; /* Borda mais sutil */
            border-radius: 4px; /* Menos arredondado */
            font-size: 1em;
            box-sizing: border-box; /* Garante padding dentro da largura */
        }
        input:read-only { /* Estilo para campos somente leitura */
            background-color: #e9ecef;
            cursor: not-allowed;
        }
        .result-card {
            background: #fff; /* Fundo branco */
            padding: 15px; /* Menos padding */
            border-radius: 6px;
            margin: 10px 0; /* Menos margem */
            border: 1px solid #eee; /* Borda sutil */
            border-left: 4px solid #17a2b8; /* Cor informativa */
            transition: box-shadow 0.2s ease;
        }
        .result-card:hover {
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
        }
        .result-card p {
            margin: 5px 0;
            font-size: 0.95em;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 20px auto;
        }
        .selected-shipping {
            background: #e3f2fd;
            border-left-color: #2196F3;
            box-shadow: 0 0 8px rgba(33, 150, 243, 0.3);
        }
        .btn-select {
            background: #28a745; /* Verde sucesso */
            color: white;
            padding: 8px 16px;
            margin-top: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .btn-select:hover {
            background: #218838;
        }
        .final-price {
            font-size: 1.4em;
            color: #28a745; /* Verde sucesso */
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: right;
        }
        .checkout-btn {
            background: #28a745; /* Verde sucesso */
            margin-top: 20px;
            display: none; /* Come√ßa escondido */
            width: 100%;
            font-size: 1.1em;
            padding: 1rem; /* Bot√£o maior */
        }
        .checkout-btn:hover {
            background: #218838;
        }
        .emoji {
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script> <script src="https://unpkg.com/parse/dist/parse.min.js"></script> </head>
<body>
    <div class="container">
        <div class="profile-header">
            <div style="display: flex; align-items: center;">
                <img id="profilePhoto" class="profile-photo" src="https://placehold.co/120x120/eee/ccc?text=User" alt="Foto do Perfil">
                <div class="profile-info">
                    <h1 id="userName"><span class="emoji">üì±</span> Carregando...</h1>
                    <p id="userEmail"></p>
                    </div>
            </div>
            <button id="logoutBtn" class="btn btn-secondary"><span class="emoji">üö™</span> Sair</button>
        </div>

        <div class="carrinho">
            <h2><span class="emoji">üõí</span> Meu Carrinho</h2>
            <div id="carrinhoItens"><p>Carregando itens...</p></div>
            <div class="total"><span class="emoji">üì¶</span> Subtotal: R$ <span id="carrinhoTotal">0.00</span></div>
        </div>

        <div class="form-section">
            <h3><span class="emoji">üöö</span> Calcular Frete</h3>
            <div class="form-row">
                <div>
                    <label for="cep_loja">üìç CEP da Loja (Origem)</label>
                    <input type="text" id="cep_loja" placeholder="00000-000"
                           oninput="formatarCEP(this)" value="01001000"> </div>
                <div>
                    <label for="cep_destino">üìÆ Seu CEP (Destino)</label>
                    <input type="text" id="cep_destino" placeholder="Digite seu CEP"
                           oninput="formatarCEP(this)" onblur="buscarEndereco(this.value)">
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label for="logradouro">üè† Logradouro</label>
                    <input type="text" id="logradouro" readonly>
                </div>
                <div>
                    <label for="bairro">üèòÔ∏è Bairro</label>
                    <input type="text" id="bairro" readonly>
                </div>
                <div>
                    <label for="cidade">üåÜ Cidade</label>
                    <input type="text" id="cidade" readonly>
                </div>
                <div>
                    <label for="uf">üè≥Ô∏è Estado</label>
                    <input type="text" id="uf" readonly>
                </div>
            </div>
             <details>
                 <summary style="cursor: pointer; color: #007BFF; margin-bottom: 10px;">üì¶ Detalhes do Pacote (para frete)</summary>
                 <div class="form-row">
                    <div>
                        <label for="altura">üìè Altura (cm)</label>
                        <input type="number" id="altura" value="10" min="1">
                    </div>
                    <div>
                        <label for="largura">üìè Largura (cm)</label>
                        <input type="number" id="largura" value="15" min="1">
                    </div>
                    <div>
                        <label for="comprimento">üìê Comprimento (cm)</label>
                        <input type="number" id="comprimento" value="20" min="1">
                    </div>
                    <div>
                        <label for="peso">‚öñÔ∏è Peso Total (kg)</label>
                        <input type="number" id="peso" step="0.1" value="0.5" min="0.1">
                    </div>
                 </div>
            </details>

            <button class="btn btn-primary" onclick="calcularFrete()" style="margin-top: 15px;"><span class="emoji">üì¶</span> Calcular Frete</button>
            <div class="loader" id="mainLoader"></div>
            <div id="result" style="margin-top: 15px;"></div> </div>

        <div class="final-price" id="finalPriceContainer" style="display: none;">
            <span class="emoji">üí∞</span> Pre√ßo Final (Subtotal + Frete): R$ <span id="precoFinal">0.00</span>
        </div>

        <button id="checkoutBtn" class="btn checkout-btn" onclick="prosseguirCheckout()">
            <span class="emoji">‚úÖ</span> Prosseguir para Checkout
        </button>

        <button class="btn btn-secondary" onclick="voltarParaIndex()" style="margin-top: 15px; float: right;">
             <span class="emoji">üè†</span> Voltar para Loja
        </button>
    </div>

    <script>
        // --- Configura√ß√µes ---
        const firebaseConfig = {
            apiKey: "AIzaSyDlUQbbTP29VqBVmzOGHhfc67R1DTRPwxg", // Sua chave
            authDomain: "gitautenticatio.firebaseapp.com",
            databaseURL: "https://gitautenticatio-default-rtdb.firebaseio.com", // Mantido para CEP
            projectId: "gitautenticatio",
            storageBucket: "gitautenticatio.appspot.com",
            messagingSenderId: "21514234895",
            appId: "1:21514234895:web:d34dc4c44baf586d2cc77a"
        };

        // Inicializar Firebase (Apenas Auth e DB para CEP)
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database(); // Usado para buscar/salvar CEP

        // Inicializar Parse
        Parse.initialize("TYP8SUA8qxmHIRs1mHbiFalgRxCEf51sOiSWmNEY", "n4Gfko9sO7jiAUnWX5U5GGCDQ5QtPWX97K4TzB8I"); // Suas chaves
        Parse.serverURL = "https://parseapi.back4app.com/";

        // --- Vari√°veis Globais ---
        let firebaseUser = null; // Usu√°rio do Firebase (para ID e perfil)
        let totalCarrinho = 0; // Subtotal dos produtos
        let freteSelecionado = 0; // Custo do frete escolhido

        // --- Event Listeners e Inicializa√ß√£o ---

        // Monitorar estado de autentica√ß√£o do Firebase
        auth.onAuthStateChanged(async user => {
            if (user) {
                firebaseUser = user;
                console.log("Firebase user logado:", firebaseUser.uid);
                atualizarCabecalho(); // Atualiza nome/foto

                // Tenta pegar o usu√°rio Parse correspondente
                const parseUser = Parse.User.current();
                if (parseUser) {
                     console.log("Parse user logado:", parseUser.id);
                     await carregarCarrinho(); // Carrega carrinho do Parse
                     await carregarCEPSalvo(); // Carrega CEP do Firebase
                } else {
                     // Isso pode acontecer se o sync no index.html falhou ou ainda n√£o ocorreu
                     console.error("Usu√°rio Firebase logado, mas Parse.User.current() √© null!");
                     alert("Erro ao carregar dados da conta. Tente recarregar ou voltar √† p√°gina inicial.");
                     // Poderia tentar for√ßar o login Parse aqui se tiver o UID do Firebase
                     // mas idealmente o fluxo do index.html deve garantir isso.
                     document.getElementById('carrinhoItens').innerHTML = '<p style="color: red;">Erro ao carregar carrinho. Verifique seu login.</p>';
                }

            } else {
                // Se n√£o h√° usu√°rio Firebase, redireciona para o in√≠cio
                console.log("Nenhum usu√°rio Firebase logado. Redirecionando...");
                window.location.href = 'index.html'; // Ou p√°gina de login
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await auth.signOut(); // Logout Firebase
                await Parse.User.logOut(); // Logout Parse
                console.log("Logout realizado.");
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
                alert('‚ùå Erro ao fazer logout: ' + error.message);
            }
        });

        // --- Fun√ß√µes de Interface e Auxiliares ---

        // Atualizar cabe√ßalho do perfil (usa dados do Firebase)
        function atualizarCabecalho() {
            if (!firebaseUser) return;
            document.getElementById('profilePhoto').src = firebaseUser.photoURL || 'https://placehold.co/120x120/eee/ccc?text=:)';
            document.getElementById('userName').textContent = 'üë§ ' + (firebaseUser.displayName || 'Usu√°rio');
            document.getElementById('userEmail').textContent = 'üìß ' + firebaseUser.email;
        }

        // Formatar CEP enquanto digita
        function formatarCEP(input) {
            let cep = input.value.replace(/\D/g, ''); // Remove n√£o d√≠gitos
            if (cep.length > 5) {
                cep = cep.replace(/^(\d{5})(\d)/, '$1-$2'); // Adiciona h√≠fen
            }
            if (cep.length > 9) {
                cep = cep.substring(0, 9); // Limita a 9 caracteres (00000-000)
            }
            input.value = cep;
        }

        // Voltar para p√°gina inicial
        function voltarParaIndex() {
            window.location.href = 'index.html';
        }

        // --- Fun√ß√µes do Carrinho (Usando Parse) ---

        /**
         * Carrega os itens do carrinho a partir da classe Cliente no Parse.
         */
        async function carregarCarrinho() {
            const container = document.getElementById('carrinhoItens');
            container.innerHTML = '<p>üîÑ Carregando itens...</p>';
            totalCarrinho = 0; // Reseta o subtotal global
            document.getElementById('carrinhoTotal').textContent = '0.00';
            atualizarPrecoFinal(); // Reseta o pre√ßo final tamb√©m

            const parseUser = Parse.User.current();
            if (!parseUser) {
                console.error("carregarCarrinho: Parse User n√£o encontrado.");
                container.innerHTML = '<p style="color: red;">‚ö†Ô∏è Erro: Usu√°rio n√£o logado no sistema.</p>';
                return;
            }

            const Cliente = Parse.Object.extend("Cliente");
            const queryCliente = new Parse.Query(Cliente);
            queryCliente.equalTo("usuario", parseUser); // Link com o usu√°rio logado

            try {
                const cliente = await queryCliente.first(); // Busca o objeto Cliente

                if (!cliente) {
                    console.warn("Nenhum objeto Cliente encontrado para o usu√°rio:", parseUser.id);
                    container.innerHTML = '<p>üõçÔ∏è Seu carrinho est√° vazio.</p>';
                    return;
                }

                const productIds = cliente.get('carrinhoclient') || []; // Array de IDs no carrinho
                console.log("IDs no carrinho do Cliente:", productIds);

                if (productIds.length === 0) {
                    container.innerHTML = '<p>üõçÔ∏è Seu carrinho est√° vazio.</p>';
                    return;
                }

                // 1. Contar a quantidade de cada produto ID
                const quantityMap = productIds.reduce((map, id) => {
                    map[id] = (map[id] || 0) + 1;
                    return map;
                }, {});
                const uniqueProductIds = Object.keys(quantityMap);
                console.log("Quantidades:", quantityMap);
                console.log("IDs √∫nicos:", uniqueProductIds);

                // 2. Buscar os detalhes dos produtos √∫nicos no Parse
                const Produto = Parse.Object.extend("Produto");
                const queryProduto = new Parse.Query(Produto);
                queryProduto.containedIn("objectId", uniqueProductIds); // Busca s√≥ os produtos do carrinho
                queryProduto.select("nome", "preco", "imagens"); // Campos necess√°rios
                const produtos = await queryProduto.find();
                console.log("Produtos encontrados:", produtos.length);

                // 3. Mapear produtos encontrados por ID para acesso f√°cil
                const productDetailsMap = produtos.reduce((map, p) => {
                    map[p.id] = {
                        nome: p.get('nome') || "Produto sem nome",
                        preco: p.get('preco') || 0,
                        imagemUrl: (p.get('imagens') && p.get('imagens').length > 0) ? p.get('imagens')[0] : 'https://placehold.co/60x60/eee/ccc?text=Img'
                    };
                    return map;
                }, {});

                // 4. Gerar o HTML do carrinho
                let html = '';
                totalCarrinho = 0; // Recalcula o subtotal

                uniqueProductIds.forEach(produtoId => {
                    const details = productDetailsMap[produtoId];
                    const quantidade = quantityMap[produtoId];

                    if (details) {
                        const precoUnitario = details.preco;
                        const subtotalItem = precoUnitario * quantidade;
                        totalCarrinho += subtotalItem;

                        html += `
                            <div class="produto" id="item-${produtoId}">
                                <img src="${details.imagemUrl}" alt="${details.nome}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 15px;">
                                <div class="produto-info">
                                    <h4>${details.nome}</h4>
                                    <p>üî¢ Quantidade: ${quantidade}</p>
                                    <p>üí≤ Pre√ßo unit√°rio: R$ ${precoUnitario.toFixed(2)}</p>
                                    <p class="subtotal-item">üí∞ Subtotal: R$ ${subtotalItem.toFixed(2)}</p>
                                </div>
                                <button onclick="removerDoCarrinho('${produtoId}')" class="btn btn-danger">
                                    <span class="emoji">‚ùå</span> Remover 1
                                </button>
                            </div>
                        `;
                    } else {
                        console.warn(`Detalhes n√£o encontrados para o produto ID: ${produtoId}. Removendo do carrinho virtualmente.`);
                        // Poderia adicionar l√≥gica para remover IDs √≥rf√£os do 'carrinhoclient' aqui
                    }
                });

                container.innerHTML = html || '<p>üõçÔ∏è Seu carrinho est√° vazio.</p>'; // Caso todos os IDs sejam √≥rf√£os
                document.getElementById('carrinhoTotal').textContent = totalCarrinho.toFixed(2);
                atualizarPrecoFinal(); // Atualiza o pre√ßo final com o novo subtotal

            } catch (error) {
                console.error('Erro ao carregar carrinho do Parse:', error);
                container.innerHTML = `<p style="color: red;">‚ùå Erro ao carregar o carrinho: ${error.message}</p>`;
            }
        }

        /**
         * Remove UMA unidade do produto especificado do carrinho na classe Cliente.
         * @param {string} produtoId - O objectId do produto a ser removido.
         */
        window.removerDoCarrinho = async (produtoId) => {
             console.log("Tentando remover produto:", produtoId);
             const parseUser = Parse.User.current();
             if (!parseUser) {
                 alert("‚ö†Ô∏è Erro: Usu√°rio n√£o logado.");
                 return;
             }

             const Cliente = Parse.Object.extend("Cliente");
             const query = new Parse.Query(Cliente);
             query.equalTo("usuario", parseUser);

             try {
                 const cliente = await query.first();
                 if (!cliente) {
                     alert("‚ö†Ô∏è Erro: N√£o foi poss√≠vel encontrar os dados do seu carrinho.");
                     return;
                 }

                 let productIds = cliente.get('carrinhoclient') || [];
                 const indexToRemove = productIds.indexOf(produtoId); // Encontra o primeiro √≠ndice

                 if (indexToRemove > -1) {
                     productIds.splice(indexToRemove, 1); // Remove apenas um item
                     cliente.set('carrinhoclient', productIds); // Define o array modificado
                     await cliente.save(); // Salva no Parse
                     console.log("Produto removido. IDs restantes:", productIds);
                     await carregarCarrinho(); // Recarrega a lista do carrinho na UI
                     alert('üóëÔ∏è Uma unidade do item foi removida do carrinho!');
                 } else {
                     console.warn("Produto ID n√£o encontrado no array carrinhoclient:", produtoId);
                     alert("‚ö†Ô∏è Item n√£o encontrado no carrinho.");
                     // Pode ser √∫til recarregar o carrinho caso haja inconsist√™ncia
                     await carregarCarrinho();
                 }

             } catch (error) {
                 console.error("Erro ao remover item do Parse:", error);
                 alert('‚ùå Erro ao remover item: ' + error.message);
             }
         };


        // --- Fun√ß√µes de CEP e Frete (Usando Firebase para CEP e Cloud Function para Frete) ---

        /**
         * Carrega o CEP salvo no Firebase Realtime Database.
         */
        async function carregarCEPSalvo() {
            if (!firebaseUser) return;
            try {
                const cepSnapshot = await database.ref(`users/${firebaseUser.uid}/cepuser`).once('value');
                const cepSalvo = cepSnapshot.val();
                if (cepSalvo) {
                    const cepInput = document.getElementById('cep_destino');
                    cepInput.value = cepSalvo; // Preenche o campo
                    formatarCEP(cepInput); // Formata
                    await buscarEndereco(cepSalvo); // Busca endere√ßo automaticamente
                    console.log("CEP carregado do Firebase:", cepSalvo);
                } else {
                     console.log("Nenhum CEP salvo no Firebase encontrado.");
                }
            } catch (error) {
                console.error("Erro ao carregar CEP salvo:", error);
            }
        }

        /**
         * Busca o endere√ßo usando a API ViaCEP e preenche os campos.
         * Salva o CEP v√°lido no Firebase.
         * @param {string} cep - O CEP a ser buscado (com ou sem h√≠fen).
         */
        async function buscarEndereco(cep) {
            cep = cep.replace(/\D/g, ''); // Limpa o CEP
            if (cep.length !== 8) {
                // Limpa campos se o CEP for inv√°lido ou incompleto
                document.getElementById('logradouro').value = '';
                document.getElementById('bairro').value = '';
                document.getElementById('cidade').value = '';
                document.getElementById('uf').value = '';
                return;
            }

            console.log("Buscando endere√ßo para CEP:", cep);
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if (data.erro) {
                    console.warn('ViaCEP retornou erro para CEP:', cep);
                    alert('‚ùå CEP n√£o encontrado!');
                    // Limpa campos
                     document.getElementById('logradouro').value = '';
                     document.getElementById('bairro').value = '';
                     document.getElementById('cidade').value = '';
                     document.getElementById('uf').value = '';
                    return;
                }

                // Preenche os campos do formul√°rio
                document.getElementById('logradouro').value = data.logradouro || '';
                document.getElementById('bairro').value = data.bairro || '';
                document.getElementById('cidade').value = data.localidade || '';
                document.getElementById('uf').value = data.uf || '';
                console.log("Endere√ßo encontrado:", data);

                // Salva o CEP v√°lido no Firebase (se o usu√°rio estiver logado)
                if (firebaseUser) {
                    await database.ref(`users/${firebaseUser.uid}/cepuser`).set(cep);
                    console.log("CEP salvo no Firebase:", cep);
                }

            } catch (error) {
                console.error('Erro ao buscar CEP via ViaCEP:', error);
                alert('‚ùå Erro ao buscar endere√ßo. Verifique sua conex√£o ou o CEP digitado.');
            }
        }

        /**
         * Chama a Cloud Function 'calcularFrete' no Parse.
         */
        async function calcularFrete() {
            const cepOrigem = document.getElementById('cep_loja').value.replace(/\D/g, '');
            const cepDestino = document.getElementById('cep_destino').value.replace(/\D/g, '');

            if (cepOrigem.length !== 8 || cepDestino.length !== 8) {
                alert("‚ö†Ô∏è Por favor, preencha um CEP de origem e destino v√°lidos (8 d√≠gitos).");
                return;
            }

            const loader = document.getElementById('mainLoader');
            const resultDiv = document.getElementById('result');
            loader.style.display = 'block'; // Mostra o loader
            resultDiv.innerHTML = ''; // Limpa resultados anteriores
            freteSelecionado = 0; // Reseta frete
            document.getElementById('finalPriceContainer').style.display = 'none';
            document.getElementById('checkoutBtn').style.display = 'none';
            atualizarPrecoFinal();

            const params = {
                cepOrigem: cepOrigem,
                cepDestino: cepDestino,
                package: {
                    height: parseFloat(document.getElementById('altura').value) || 10, // Default values
                    width: parseFloat(document.getElementById('largura').value) || 15,
                    length: parseFloat(document.getElementById('comprimento').value) || 20,
                    weight: parseFloat(document.getElementById('peso').value) || 0.5
                }
            };
            console.log("Calculando frete com par√¢metros:", params);

            try {
                // Chama a Cloud Function do Parse
                const response = await Parse.Cloud.run("calcularFrete", params);
                console.log("Resposta da Cloud Function:", response);
                // A estrutura da resposta pode variar dependendo da sua Cloud Function
                // Ajuste 'response.data' conforme necess√°rio
                exibirFrete(response.data || response); // Tenta acessar response.data, sen√£o usa response direto

            } catch (error) {
                console.error('Erro ao chamar Cloud Function calcularFrete:', error);
                resultDiv.innerHTML = `<p style="color: red;">‚ùå Erro ao calcular frete: ${error.message}</p>`;
            } finally {
                loader.style.display = 'none'; // Esconde o loader
            }
        }

        /**
         * Exibe as op√ß√µes de frete retornadas pela Cloud Function.
         * @param {Array} servicos - Array de objetos de servi√ßo de frete.
         */
        function exibirFrete(servicos) {
            const resultDiv = document.getElementById('result');
            if (!Array.isArray(servicos) || servicos.length === 0) {
                 resultDiv.innerHTML = '<p>Nenhuma op√ß√£o de frete encontrada para este CEP.</p>';
                 return;
            }

            // Ordena por pre√ßo (mais barato primeiro) - opcional
            servicos.sort((a, b) => parseFloat(a.preco) - parseFloat(b.preco));

            resultDiv.innerHTML = '<h4>Selecione uma op√ß√£o de frete:</h4>' + servicos.map((servico, index) => {
                // Tratamento b√°sico de erros ou valores ausentes
                const nomeServico = `${servico.empresa || 'Empresa'} - ${servico.metodo || 'M√©todo'}`;
                const prazo = servico.prazo ? `${servico.prazo} dias √∫teis` : 'Prazo indispon√≠vel';
                const preco = parseFloat(servico.preco);
                const precoFormatado = !isNaN(preco) ? `R$ ${preco.toFixed(2)}` : 'Pre√ßo indispon√≠vel';

                return `
                    <div class="result-card" id="frete-opcao-${index}">
                        <p><strong><span class="emoji">üöö</span> ${nomeServico}</strong></p>
                        <p><span class="emoji">üìÖ</span> Prazo estimado: ${prazo}</p>
                        <p><strong><span class="emoji">üí≤</span> Pre√ßo: ${precoFormatado}</strong></p>
                        ${!isNaN(preco) ? // S√≥ mostra bot√£o se o pre√ßo for v√°lido
                            `<button class="btn-select"
                                    onclick="selecionarFrete(${preco}, this)">
                                <span class="emoji">‚úÖ</span> Selecionar Frete
                            </button>`
                            : '<p style="color: #888;">Op√ß√£o indispon√≠vel</p>'
                        }
                    </div>
                `;
            }).join('');
        }

        /**
         * Atualiza o valor do frete selecionado e a UI.
         * @param {number} preco - O pre√ßo do frete selecionado.
         * @param {HTMLElement} element - O bot√£o que foi clicado.
         */
        function selecionarFrete(preco, element) {
            // Remove a classe de sele√ß√£o de todos os cards
            document.querySelectorAll('.result-card').forEach(card => {
                card.classList.remove('selected-shipping');
            });
            // Adiciona a classe ao card pai do bot√£o clicado
            element.closest('.result-card').classList.add('selected-shipping');

            freteSelecionado = preco; // Atualiza a vari√°vel global
            console.log("Frete selecionado: R$", freteSelecionado.toFixed(2));

            // Mostra o pre√ßo final e o bot√£o de checkout
            document.getElementById('finalPriceContainer').style.display = 'block';
            document.getElementById('checkoutBtn').style.display = 'block';

            // N√£o salva mais o frete no Firebase aqui
            // database.ref(`users/${firebaseUser.uid}/carrinho/frete`).set(preco); // REMOVIDO

            atualizarPrecoFinal(); // Recalcula e exibe o pre√ßo final
        }

        /**
         * Atualiza o c√°lculo e a exibi√ß√£o do pre√ßo final (Subtotal + Frete).
         */
        function atualizarPrecoFinal() {
            const precoFinal = totalCarrinho + freteSelecionado;
            const finalPriceSpan = document.getElementById('precoFinal');
            if (finalPriceSpan) {
                finalPriceSpan.textContent = precoFinal.toFixed(2);
            }
             console.log(`Pre√ßo final atualizado: Subtotal(${totalCarrinho.toFixed(2)}) + Frete(${freteSelecionado.toFixed(2)}) = ${precoFinal.toFixed(2)}`);

            // N√£o salva mais o pre√ßo total no Firebase aqui
            // database.ref(`users/${firebaseUser.uid}/carrinho/precototal`).set(precoFinal); // REMOVIDO
        }

        /**
         * Redireciona ou inicia o processo de checkout.
         */
        function prosseguirCheckout() {
            // Verifica se um frete foi selecionado
            if (freteSelecionado <= 0) {
                alert("‚ö†Ô∏è Por favor, calcule e selecione uma op√ß√£o de frete antes de prosseguir.");
                return;
            }
            // Verifica se o carrinho n√£o est√° vazio
             if (totalCarrinho <= 0) {
                 alert("‚ö†Ô∏è Seu carrinho est√° vazio. Adicione produtos antes de prosseguir.");
                 return;
             }

            console.log("Prosseguindo para checkout...");
            // Aqui voc√™ pode:
            // 1. Salvar os dados relevantes (itens, subtotal, frete, endere√ßo)
            //    em uma nova classe no Parse (ex: "Pedido") antes de redirecionar.
            // 2. Passar os dados via localStorage/sessionStorage para a p√°gina de checkout.
            // 3. Redirecionar para a p√°gina de checkout.

            // Exemplo simples com localStorage (CUIDADO: localStorage tem limites e n√£o √© ideal para dados sens√≠veis)
             try {
                const checkoutData = {
                     subtotal: totalCarrinho,
                     frete: freteSelecionado,
                     total: totalCarrinho + freteSelecionado,
                     // Poderia adicionar IDs dos produtos e quantidades aqui se necess√°rio na pr√≥xima p√°gina
                     // itens: cliente.get('carrinhoclient') // Exemplo, buscaria o cliente novamente
                     cepDestino: document.getElementById('cep_destino').value,
                     endereco: {
                         logradouro: document.getElementById('logradouro').value,
                         bairro: document.getElementById('bairro').value,
                         cidade: document.getElementById('cidade').value,
                         uf: document.getElementById('uf').value
                     }
                 };
                 localStorage.setItem('checkoutData', JSON.stringify(checkoutData));
                 console.log("Dados salvos no localStorage para checkout:", checkoutData);
                 window.location.href = 'checkout.html'; // Redireciona

             } catch (e) {
                 console.error("Erro ao salvar dados para checkout no localStorage:", e);
                 alert("Ocorreu um erro ao preparar o checkout. Tente novamente.");
             }
        }

    </script>
</body>
</html>
