<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minha Loja</title>
  <style>
    /* Estilos permanecem os mesmos */
    /* Reset b√°sico e fontes */
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 20px;
      color: #333;
      line-height: 1.6;
    }

    /* Cabe√ßalho do Perfil */
    .profile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 2rem;
    }

    .profile-photo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #007BFF;
      margin-right: 1rem;
      background-color: #eee; /* Cor de fundo para placeholder */
    }

    .profile-info h1, .profile-info p {
        margin: 0;
        line-height: 1.3;
    }

    .profile-info h1 {
        font-size: 1.4rem;
        color: #1c1e21;
        word-break: break-word; /* Quebra nomes longos */
    }

     .profile-info p {
        font-size: 0.9rem;
        color: #606770;
        word-break: break-all; /* Quebra emails longos */
    }

    /* Cabe√ßalho da Loja */
     .store-header {
        background-color: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
        text-align: center;
    }

    .store-header h1 {
        margin: 0 0 0.5rem 0;
        color: #007BFF;
        font-size: 1.8rem;
    }

    .store-header p {
        margin: 0;
        color: #606770;
        font-size: 1rem;
    }

    /* Painel de Administra√ß√£o */
    .admin-panel {
      background-color: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      overflow-x: auto; /* Adiciona rolagem horizontal se necess√°rio */
    }

     .admin-panel h2 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 0.8rem;
    }

    /* Tabela de Produtos */
    table {
      width: 100%;
      min-width: 600px; /* Largura m√≠nima para evitar espremer demais */
      border-collapse: collapse;
      margin: 2rem 0;
      table-layout: fixed; /* Ajuda a controlar larguras */
    }

    th, td {
      padding: 1rem 0.8rem;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
      vertical-align: middle;
      overflow: hidden; /* Esconde estouro */
      text-overflow: ellipsis; /* Adiciona '...' se estourar */
     }

     /* C√©lula de Produto/Pre√ßo */
     td.product-details-cell {
        white-space: normal; /* Permite quebra de linha */
        line-height: 1.4;
        vertical-align: top; /* Alinha conte√∫do no topo */
        word-wrap: break-word; /* Garante quebra de palavras longas */
     }

    th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #495057;
      white-space: nowrap; /* Cabe√ßalho n√£o quebra linha */
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    /* Larguras das colunas (ajustadas) */
    .image-cell { width: 35%; } /* Aumentar espa√ßo para imagens */
    .product-details-cell { width: 30%; } /* Espa√ßo para nome e pre√ßo */
    .order-cell { width: 15%; text-align: center; } /* Espa√ßo para bot√µes de ordem */
    .actions-cell { width: 20%; text-align: center;} /* Espa√ßo para bot√µes de a√ß√£o */


    /* Estilo para o pre√ßo abaixo do nome */
    .product-price-inline {
        display: block;
        font-size: 0.9em;
        color: #555;
        margin-top: 4px;
    }


    /* Imagens na Tabela */
    .product-image {
      height: 50px;
      width: 50px;
      min-width: 50px; /* Garante tamanho m√≠nimo */
      border-radius: 6px;
      object-fit: cover;
      border: 1px solid #ddd;
      margin-right: 5px;
      vertical-align: middle;
      background-color: #eee; /* Cor de fundo para placeholder */
    }

    /* Cont√™iner de Imagens com Rolagem */
    .image-container {
      display: flex;
      flex-wrap: nowrap; /* Impede quebra de linha das imagens */
      overflow-x: auto; /* Permite rolagem horizontal */
      overflow-y: hidden; /* Esconde rolagem vertical */
      padding: 5px 0;
      gap: 8px; /* Espa√ßo entre as imagens */
      cursor: grab; /* Indica que pode ser arrastado */
      -webkit-overflow-scrolling: touch; /* Rolagem suave em iOS */
      scrollbar-width: thin; /* Barra de rolagem fina (Firefox) */
      scrollbar-color: #ccc #f0f0f0; /* Cores da barra (Firefox) */
    }
    /* Estilos da barra de rolagem (Webkit - Chrome, Safari) */
    .image-container::-webkit-scrollbar { height: 6px; }
    .image-container::-webkit-scrollbar-track { background: #f0f0f0; border-radius: 3px; }
    .image-container::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 3px; }
    .image-container::-webkit-scrollbar-thumb:hover { background-color: #aaa; }

     /* Cont√™iner de Ordem e A√ß√µes */
    .order-container, .actions-container {
      display: flex;
      flex-direction: column; /* Bot√µes um abaixo do outro */
      gap: 8px; /* Espa√ßo entre os bot√µes */
      align-items: center; /* Centraliza horizontalmente */
      justify-content: center; /* Centraliza verticalmente */
      height: 100%; /* Ocupa altura da c√©lula */
    }

    /* Bot√µes de Ordena√ß√£o */
    .btn-order {
      background-color: #6c757d; color: white; border: none;
      border-radius: 4px; padding: 4px 8px; cursor: pointer;
      font-size: 0.8rem; line-height: 1; transition: background-color 0.2s ease;
    }
    .btn-order:hover:not(:disabled) { background-color: #5a6268; }
    .btn-order:disabled { background-color: #adb5bd; cursor: not-allowed; opacity: 0.7; }


    /* Formul√°rio */
    #productForm {
        display: flex;
        flex-wrap: wrap; gap: 1rem; align-items: flex-end; /* Alinha itens na base */
        margin-bottom: 2rem; padding: 1.5rem; background-color: #f8f9fa;
        border-radius: 8px;
    }

    input[type="text"], input[type="number"] {
      padding: 10px 12px; border: 1px solid #ccc; border-radius: 6px;
      font-size: 0.95rem; flex-grow: 1; /* Permite crescer */ min-width: 150px; /* Largura m√≠nima */
    }

    /* Upload de Imagem */
    .image-upload { display: flex; align-items: center; gap: 0.8rem; }
    .image-upload input[type="file"] { display: none; } /* Esconde input real */
    .upload-label {
      background-color: #2196F3; color: white; padding: 10px 15px;
      border-radius: 6px; cursor: pointer; transition: background-color 0.3s ease;
      font-size: 0.9rem; display: inline-flex; align-items: center; gap: 5px;
      white-space: nowrap; /* Evita quebra de linha no bot√£o */
    }
    .upload-label:hover { background-color: #1976D2; }
    #imagePreview {
      max-height: 50px; max-width: 50px; margin: 0; border-radius: 4px;
      border: 1px solid #ddd; display: none; /* Come√ßa escondido */ object-fit: cover;
    }

    /* Bot√µes Gerais */
    .btn {
      padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer;
      transition: all 0.3s ease; font-size: 0.9rem; font-weight: 500;
      display: inline-flex; align-items: center; gap: 5px; /* √çcone + Texto */
      text-transform: uppercase; letter-spacing: 0.5px;
      white-space: nowrap; /* Evita quebra de linha nos bot√µes */
    }
     .btn:disabled { cursor: not-allowed; opacity: 0.6; }
    .btn-edit { background-color: #4CAF50; color: white; } /* Verde para adicionar/editar */
    .btn-edit:hover:not(:disabled) { background-color: #45a049; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .btn-delete { background-color: #f44336; color: white; } /* Vermelho para excluir */
    .btn-delete:hover:not(:disabled) { background-color: #e53935; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .btn-secondary { background-color: #6c757d; color: white; } /* Cinza para a√ß√µes secund√°rias (Sair) */
    .btn-secondary:hover:not(:disabled) { background-color: #5a6268; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

    /* Responsividade */
    @media (max-width: 768px) {
        body { padding: 10px; } /* Menos padding em telas pequenas */
        .profile-header { flex-direction: column; align-items: flex-start; gap: 1rem; padding: 1rem; }
        .admin-panel { padding: 1rem; }
        #productForm { flex-direction: column; align-items: stretch; padding: 1rem; }
        input[type="text"], input[type="number"], .image-upload, .btn { width: 100%; box-sizing: border-box; } /* Ocupa largura total */
        .actions-cell, .order-cell { text-align: center; } /* Centraliza bot√µes */
        /* Ajusta cont√™ineres de bot√µes para linha em telas menores */
        .actions-container, .order-container {
            flex-direction: row; /* Bot√µes lado a lado */
            flex-wrap: wrap; /* Permite quebra se n√£o couber */
            justify-content: center; /* Centraliza os bot√µes na linha */
            gap: 5px; /* Espa√ßo menor entre bot√µes */
        }

        th, td { padding: 0.8rem 0.5rem; } /* Menos padding nas c√©lulas */
        td.product-details-cell { vertical-align: middle; } /* Alinha melhor com bot√µes */
        /* Largura autom√°tica e remove nowrap para permitir quebra */
        .image-cell, .product-details-cell, .actions-cell, .order-cell { width: auto; white-space: normal; }
        table { min-width: 0; table-layout: auto; } /* Remove largura m√≠nima, layout autom√°tico */

        .order-container .btn-order { padding: 6px 10px; font-size: 0.9rem; }
        .actions-container .btn { padding: 8px 12px; }
    }
     @media (max-width: 480px) {
         .profile-info h1 { font-size: 1.2rem; }
         .store-header h1 { font-size: 1.5rem; }
         .btn { font-size: 0.8rem; padding: 8px 10px; } /* Bot√µes menores */
         .upload-label { padding: 8px 12px; font-size: 0.8rem; }
         .actions-container, .order-container { gap: 5px; } /* Menos espa√ßo entre bot√µes */
     }

  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
</head>
<body>
  <div class="profile-header">
    <div style="display: flex; align-items: center; min-width: 0;"> <img id="profilePhoto" class="profile-photo" src="avatar-padrao.jpeg" alt="Foto de Perfil" onerror="this.src='https://placehold.co/60x60/007BFF/FFF?text=:)'; this.onerror=null;">
      <div class="profile-info" style="min-width: 0;"> <h1 id="userName">Carregando...</h1>
        <p id="userEmail"></p>
      </div>
    </div>
    <button id="logoutBtn" class="btn btn-secondary">üö™ Sair</button>
  </div>

  <div class="store-header">
    <h1 id="nomeLoja">Carregando nome da loja...</h1>
	  <p id="reputacaoLoja">Reputa√ß√£o: 0</p>
  </div>

  <div class="admin-panel">
    <h2>Gerenciamento de Produtos</h2>

    <form id="productForm">
      <input type="text" id="productName" placeholder="Nome do Produto" required>
      <input type="number" id="productPrice" step="0.01" placeholder="Pre√ßo (R$)" required>
      <div class="image-upload">
        <img id="imagePreview" src="" alt="Miniatura">
        <label class="upload-label">
          üì∑ Escolher Imagem
          <input type="file" id="productImage" accept="image/*" required>
        </label>
      </div>
      <button type="submit" class="btn btn-edit">‚ûï Adicionar Produto</button>
    </form>

    <div style="overflow-x: auto;"> <table id="productsTable">
          <thead>
            <tr>
              <th class="image-cell">Imagens</th>
              <th class="product-details-cell">Produto</th>
              <th class="order-cell">Ordem</th>
              <th class="actions-cell">A√ß√µes</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="4" style="text-align:center; padding: 20px;">Carregando produtos...</td></tr>
          </tbody>
        </table>
    </div>
  </div>

  <script>
    // --- Configura√ß√µes ---
    // Mova estas chaves para um local seguro se poss√≠vel
    const firebaseConfig = {
      apiKey: "AIzaSyDlUQbbTP29VqBVmzOGHhfc67R1DTRPwxg", // Substitua pela sua chave real
      authDomain: "gitautenticatio.firebaseapp.com",
      projectId: "gitautenticatio",
      storageBucket: "gitautenticatio.appspot.com",
      messagingSenderId: "21514234895",
      appId: "1:21514234895:web:d34dc4c44baf586d2cc77a"
    };
    Parse.initialize("TYP8SUA8qxmHIRs1mHbiFalgRxCEf51sOiSWmNEY", "n4Gfko9sO7jiAUnWX5U5GGCDQ5QtPWX97K4TzB8I"); // Substitua pelas suas chaves
    Parse.serverURL = "https://parseapi.back4app.com/";

    // Defini√ß√£o das Classes Parse
    const Produto = Parse.Object.extend("Produto");
    const Loja = Parse.Object.extend("Loja");

    // --- Inicializa√ß√£o ---
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    let currentLoja = null; // Armazena o objeto Loja do usu√°rio atual
    let isLoadingProducts = false; // Flag para controle de carregamento

    // --- Fun√ß√µes Principais ---

    /**
     * Monitora o estado de autentica√ß√£o do Firebase.
     * Se logado, busca o usu√°rio Parse atual (assumindo que j√° foi sincronizado),
     * verifica/cria a loja e carrega os produtos.
     * Se deslogado, redireciona para a p√°gina inicial (index.html).
     */
    auth.onAuthStateChanged(async (firebaseUser) => {
      if (firebaseUser) {
        console.log("[MinhaLoja Auth] Firebase: Usu√°rio autenticado:", firebaseUser.uid);
        updateHeader(firebaseUser); // Atualiza cabe√ßalho com dados do Firebase

        // **MUDAN√áA PRINCIPAL:** Assume que o usu√°rio Parse j√° est√° logado
        const parseUser = Parse.User.current();

        if (parseUser) {
          console.log("[MinhaLoja Auth] Parse: Usu√°rio logado encontrado:", parseUser.id);
          // Verifica/Cria a loja associada ao usu√°rio Parse
          await checkOrCreateLoja(parseUser);
          if (currentLoja) {
             loadProducts(); // Carrega os produtos da loja
          } else {
             console.warn("[MinhaLoja Auth] Loja n√£o encontrada ou criada. Produtos n√£o ser√£o carregados.");
             // Poderia exibir uma mensagem mais clara na interface aqui
             document.querySelector('#productsTable tbody').innerHTML = `<tr><td colspan='4' style='text-align:center; padding: 20px;'>‚ö†Ô∏è Loja n√£o configurada. Tente recarregar ou contate o suporte.</td></tr>`;
          }
        } else {
          // **CEN√ÅRIO INESPERADO:** Usu√°rio Firebase logado, mas Parse n√£o.
          console.error("[MinhaLoja Auth] ERRO CR√çTICO: Usu√°rio Firebase logado, mas sess√£o Parse n√£o encontrada!");
          alert("‚ùå Erro de sincroniza√ß√£o de conta. Por favor, saia e fa√ßa login novamente pela p√°gina inicial.");
          // Limpa a tabela e talvez desabilite funcionalidades
          document.querySelector('#productsTable tbody').innerHTML = `<tr><td colspan='4' style='text-align:center; color:red; padding: 20px;'>Erro de Sincroniza√ß√£o. Recarregue a p√°gina inicial.</td></tr>`;
          setTableLoading(true); // Desabilita intera√ß√µes
          // Considerar deslogar do Firebase aqui tamb√©m para for√ßar o fluxo
          // await auth.signOut(); // Descomentar se quiser for√ßar logout
        }

      } else {
        // Usu√°rio n√£o est√° logado no Firebase
        console.log("[MinhaLoja Auth] Firebase: Usu√°rio n√£o autenticado. Redirecionando para index.html.");
        // Redireciona para a p√°gina inicial onde o login deve ocorrer
        window.location.href = 'index.html';
      }
    });

    /**
     * Verifica se o usu√°rio Parse fornecido possui uma loja.
     * Se n√£o possuir, solicita um nome e cria uma nova loja.
     * Garante que o campo 'produtos' seja um array.
     * Atualiza as informa√ß√µes da loja na interface.
     * @param {Parse.User} currentUser - O usu√°rio Parse logado.
     */
    const checkOrCreateLoja = async (currentUser) => {
      // N√£o precisa mais verificar currentUser aqui, j√° foi feito antes
      console.log("[Loja Check] Verificando/Criando loja para usu√°rio Parse:", currentUser.id);
      const query = new Parse.Query(Loja);
      query.equalTo("dono", currentUser); // Busca loja cujo dono √© o usu√°rio Parse atual

      try {
          currentLoja = await query.first(); // Tenta encontrar a loja

          // Se n√£o encontrou loja, cria uma nova
          if (!currentLoja) {
            console.log("[Loja Check] Nenhuma loja encontrada. Solicitando cria√ß√£o.");
            const nomeLoja = prompt("üì¢ Bem-vindo! Parece que voc√™ ainda n√£o tem uma loja.\nDigite um nome para sua nova loja:");
            if (!nomeLoja || nomeLoja.trim() === "") {
                alert("‚ùå Nome da loja inv√°lido. A cria√ß√£o foi cancelada.");
                document.getElementById('nomeLoja').textContent = "Crie uma loja para come√ßar!";
                document.getElementById('reputacaoLoja').textContent = "";
                currentLoja = null; // Garante que currentLoja √© nulo
                return; // Sai da fun√ß√£o se a cria√ß√£o for cancelada
            }
            console.log("[Loja Check] Criando nova loja:", nomeLoja);
            currentLoja = new Loja();
            currentLoja.set("nome", nomeLoja.trim());
            currentLoja.set("dono", currentUser); // Associa ao usu√°rio Parse
            currentLoja.set("produtos", []); // Inicializa array de produtos VAZIO
            currentLoja.set("reputacao", 0); // Reputa√ß√£o inicial
            await currentLoja.save();
            console.log("[Loja Check] Loja criada com sucesso:", currentLoja.id);
            alert(`üéâ Loja "${nomeLoja}" criada com sucesso!`);
          } else {
              console.log("[Loja Check] Loja encontrada:", currentLoja.id, "Nome:", currentLoja.get("nome"));
              // Garante que 'produtos' √© um array (importante para consist√™ncia)
              if (!Array.isArray(currentLoja.get("produtos"))) {
                  console.warn("[Loja Check] Campo 'produtos' da loja n√£o era um array. Corrigindo para array vazio.");
                  currentLoja.set("produtos", []);
                  await currentLoja.save(); // Salva a corre√ß√£o
              }
          }
          // Atualiza nome e reputa√ß√£o na interface (se a loja existe ou foi criada)
          document.getElementById('nomeLoja').textContent = currentLoja.get("nome");
          document.getElementById('reputacaoLoja').textContent = "Reputa√ß√£o: " + currentLoja.get("reputacao");

      } catch (error) {
          console.error("[Loja Check] Erro ao verificar ou criar loja:", error);
          alert("Erro ao carregar ou criar sua loja: " + error.message);
          document.getElementById('nomeLoja').textContent = "Erro ao carregar loja";
          document.getElementById('reputacaoLoja').textContent = "";
          currentLoja = null; // Define como nulo em caso de erro
      }
    };

    /**
     * Carrega os produtos da loja atual (currentLoja), respeitando a ordem dos IDs
     * armazenados no array 'produtos' do objeto Loja.
     */
    const loadProducts = async () => {
       // Evita carregamento se n√£o houver loja ou se j√° estiver carregando
       if (!currentLoja) {
           console.warn("[Load Products] A√ß√£o ignorada: Loja atual n√£o definida.");
           document.querySelector('#productsTable tbody').innerHTML = `<tr><td colspan='4' style='text-align:center; padding: 20px;'>‚ö†Ô∏è Selecione ou crie uma loja primeiro.</td></tr>`;
           return;
       }
       if (isLoadingProducts) {
           console.warn("[Load Products] A√ß√£o ignorada: Carregamento j√° em andamento.");
           return;
       }

       isLoadingProducts = true; // Sinaliza in√≠cio do carregamento
       console.log("[Load Products] Iniciando carregamento de produtos para loja:", currentLoja.id);
       setTableLoading(true); // Desabilita bot√µes da tabela e mostra carregando

       // Obt√©m o array de IDs da loja atual, garantindo que seja um array
       const productIds = currentLoja.get("produtos") || [];

       // Se n√£o houver IDs, mostra tabela vazia imediatamente
       if (productIds.length === 0) {
          console.log("[Load Products] Nenhum produto associado √† loja.");
          updateTable([]); // Chama updateTable com array vazio
          isLoadingProducts = false; // Finaliza carregamento
          setTableLoading(false); // Habilita bot√µes (embora n√£o haja produtos)
          return;
       }

       console.log("[Load Products] Carregando produtos com IDs (na ordem do array):", productIds);

       // Busca os produtos cujos IDs est√£o no array 'productIds'
       const query = new Parse.Query(Produto);
       query.containedIn("objectId", productIds);
       // N√ÉO adicionar ordena√ß√£o aqui (ex: query.ascending) para tentar manter a ordem original

       try {
         const results = await query.find(); // Busca os objetos Produto
         console.log("[Load Products] Produtos encontrados no Parse:", results.length);

         // Reordena os resultados para GARANTIR que sigam a ordem do array 'productIds'
         const orderedResults = productIds
            .map(id => results.find(p => p.id === id)) // Mapeia cada ID para o objeto Produto correspondente
            .filter(p => p); // Remove quaisquer resultados nulos (IDs √≥rf√£os)

         // Log de verifica√ß√£o (opcional)
         if (orderedResults.length !== productIds.length) {
             console.warn(`[Load Products] Discrep√¢ncia: ${productIds.length} IDs no array da loja, ${orderedResults.length} produtos encontrados/reordenados.`);
             // TODO: Considerar limpar IDs √≥rf√£os do array da loja aqui
             // currentLoja.set("produtos", orderedResults.map(p => p.id));
             // await currentLoja.save();
         }

         console.log("[Load Products] Produtos reordenados para exibi√ß√£o:", orderedResults.map(p => p.id));
         updateTable(orderedResults); // Atualiza a tabela com os produtos na ordem correta

       } catch (error) {
         console.error("[Load Products] Erro ao carregar objetos Produto:", error);
         alert("Erro ao carregar produtos da loja: " + error.message);
         // Mostra erro na tabela
         document.querySelector('#productsTable tbody').innerHTML = `<tr><td colspan='4' style='text-align:center; color: red; padding: 20px;'>Erro ao carregar produtos: ${error.message}</td></tr>`;
       } finally {
           isLoadingProducts = false; // Sinaliza fim do carregamento
           setTableLoading(false); // Reabilita bot√µes da tabela
           console.log("[Load Products] Carregamento finalizado.");
       }
    };

    /**
     * Atualiza o conte√∫do da tabela HTML com os produtos fornecidos.
     * @param {Parse.Object[]} produtos Array de objetos Parse.Object (Produto) na ordem correta.
     */
    const updateTable = (produtos) => {
      const tbody = document.querySelector('#productsTable tbody');
      tbody.innerHTML = ""; // Limpa conte√∫do anterior

      // Se n√£o houver produtos, exibe mensagem
      if (!produtos || produtos.length === 0) {
          tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; padding: 20px;'>üõí Sua loja ainda n√£o tem produtos cadastrados.</td></tr>";
          return;
      }

      // Itera sobre os produtos (j√° na ordem correta) para criar as linhas
      produtos.forEach((produto, index) => {
        const tr = document.createElement('tr');
        tr.dataset.productId = produto.id; // Armazena ID no elemento TR

        // --- C√©lula de Imagens ---
        const imagens = produto.get("imagens") || [];
        const imagensHtml = imagens.length > 0
            ? imagens.map(url => `<img src="${url}" class="product-image" alt="Imagem do produto ${produto.get('nome') || ''}" onerror="this.style.display='none';">`).join('')
            : '<span style="font-size: 0.8em; color: #888; display: block; text-align: center;">Sem imagem</span>'; // Mensagem se n√£o houver imagem

        // --- C√©lula Combinada: Produto e Pre√ßo ---
        const preco = produto.get("preco");
        const precoFormatado = typeof preco === 'number' ? preco.toFixed(2) : 'N/D'; // Formata ou mostra N/D
        const productDetailsHtml = `
            <span style="font-weight: 500;">${produto.get("nome") || 'Produto sem nome'}</span>
            <span class="product-price-inline">R$ ${precoFormatado}</span>
        `;

        // --- C√©lula de Bot√µes de Ordem ---
        const isFirst = index === 0;
        const isLast = index === produtos.length - 1;
        const orderButtonsHtml = `
          <div class="order-container">
            <button class="btn-order btn-move-up" title="Mover para cima" onclick="moveProduct('${produto.id}', 'up')" ${isFirst ? 'disabled' : ''}>‚ñ≤</button>
            <button class="btn-order btn-move-down" title="Mover para baixo" onclick="moveProduct('${produto.id}', 'down')" ${isLast ? 'disabled' : ''}>‚ñº</button>
          </div>
        `;

        // --- C√©lula de Bot√µes de A√ß√µes ---
        const actionButtonsHtml = `
          <div class="actions-container">
            <button class="btn btn-edit" title="Editar produto" onclick="editProduct('${produto.id}')">‚úèÔ∏è Editar</button>
            <button class="btn btn-delete" title="Excluir produto" onclick="deleteProduct('${produto.id}')">üóëÔ∏è Excluir</button>
          </div>
        `;

        // --- Monta a linha (TR) com as 4 c√©lulas (TD) ---
        tr.innerHTML = `
          <td class="image-cell"><div class="image-container">${imagensHtml}</div></td>
          <td class="product-details-cell">${productDetailsHtml}</td>
          <td class="order-cell">${orderButtonsHtml}</td>
          <td class="actions-cell">${actionButtonsHtml}</td>
        `;
        tbody.appendChild(tr);
      });

      enableDragToScroll(); // Reativa funcionalidade de arrastar imagens ap√≥s renderizar
    };

    /**
     * Move um produto para cima ou para baixo na lista de produtos da loja.
     * Atualiza o array 'produtos' no objeto Loja e salva no Parse.
     * Recarrega a tabela para refletir a nova ordem.
     * @param {string} productId ID do produto a ser movido.
     * @param {'up' | 'down'} direction Dire√ß√£o do movimento.
     */
    window.moveProduct = async (productId, direction) => {
        if (!currentLoja || isLoadingProducts) {
            console.warn("[Move Product] A√ß√£o ignorada (sem loja ou opera√ß√£o em andamento).");
            return;
        }
        console.log(`[Move Product] Tentando mover produto ${productId} para ${direction}`);
        setOrderButtonsLoading(true); // Desabilita bot√µes de ordem visualmente

        let productIds = currentLoja.get("produtos") || [];
        const currentIndex = productIds.indexOf(productId);

        if (currentIndex === -1) {
            console.error("[Move Product] ID do produto n√£o encontrado no array da loja. Recarregando...");
            alert("Ocorreu um erro de sincronia. A lista ser√° recarregada.");
            setOrderButtonsLoading(false);
            loadProducts();
            return;
        }

        let newIndex;
        if (direction === 'up' && currentIndex > 0) {
            newIndex = currentIndex - 1;
        } else if (direction === 'down' && currentIndex < productIds.length - 1) {
            newIndex = currentIndex + 1;
        } else {
            console.log("[Move Product] Movimento inv√°lido (limite atingido).");
            setOrderButtonsLoading(false);
            return; // N√£o faz nada se for inv√°lido
        }

        // Realiza a troca (swap) no array
        const newProductIds = [...productIds];
        [newProductIds[currentIndex], newProductIds[newIndex]] = [newProductIds[newIndex], newProductIds[currentIndex]];

        console.log("[Move Product] Nova ordem de IDs a ser salva:", newProductIds);
        currentLoja.set("produtos", newProductIds); // Atualiza localmente

        try {
            await currentLoja.save(); // Salva a altera√ß√£o no Parse
            console.log("[Move Product] Nova ordem salva com sucesso no Parse.");
            // Recarrega a lista para refletir a nova ordem salva
            // loadProducts() reabilitar√° os bot√µes ao final
            await loadProducts();
        } catch (error) {
            console.error("[Move Product] Erro ao salvar nova ordem no Parse:", error);
            alert("Erro ao salvar a nova ordem: " + error.message + "\nA lista ser√° recarregada.");
            // Reverte a mudan√ßa local em caso de erro? Ou recarrega? Recarregar √© mais seguro.
            await loadProducts(); // Tenta recarregar para sincronizar com o servidor
        }
        // N√£o precisa de finally para reabilitar bot√µes, loadProducts faz isso.
    };

    /**
     * Deleta um produto: remove seu ID do array na Loja, salva a Loja,
     * e ent√£o deleta o objeto Produto do Parse. Recarrega a tabela.
     * @param {string} id ID do produto a ser deletado.
     */
    window.deleteProduct = async (id) => {
      if (!confirm("‚ùì Tem certeza que deseja excluir este produto permanentemente?")) return;
      if (!currentLoja) { alert("‚ùå Erro: Loja n√£o encontrada."); return; }
      console.log("[Delete Product] Iniciando exclus√£o do produto:", id);
      setTableLoading(true); // Desabilita todos os bot√µes da tabela

      try {
        // 1. Remove o ID do produto do array 'produtos' na Loja
        currentLoja.remove("produtos", id); // M√©todo 'remove' para arrays
        await currentLoja.save(); // Salva a loja com o array atualizado
        console.log("[Delete Product] ID removido do array da loja.");

        // 2. Encontra e deleta o objeto Produto correspondente
        const query = new Parse.Query(Produto);
        const produto = await query.get(id);
        await produto.destroy();
        console.log("[Delete Product] Objeto Produto destru√≠do:", id);

        alert("‚úÖ Produto exclu√≠do com sucesso!");
        // 3. Recarrega a lista de produtos
        await loadProducts(); // loadProducts j√° reabilita os bot√µes

      } catch (error) {
        console.error("[Delete Product] Erro na exclus√£o:", error);
        // Verifica se o erro foi "Object not found" (talvez j√° exclu√≠do ou problema de sincronia)
        if (error.code === Parse.Error.OBJECT_NOT_FOUND) {
            console.warn("[Delete Product] Produto n√£o encontrado no Parse (c√≥digo 101). Pode j√° ter sido exclu√≠do.");
            alert("‚ö†Ô∏è O produto n√£o foi encontrado para exclus√£o (pode j√° ter sido removido). A lista ser√° atualizada.");
        } else {
            alert("‚ùå Erro ao excluir o produto: " + error.message);
        }
        // Mesmo em caso de erro, tenta recarregar para sincronizar
        setTableLoading(false); // Reabilita bot√µes se a exclus√£o falhou antes de recarregar
        await loadProducts();
      }
    };

    /**
     * Redireciona para a p√°gina de edi√ß√£o do produto.
     * @param {string} id ID do produto a ser editado.
     */
    window.editProduct = (id) => {
        console.log("[Edit Product] Redirecionando para editar produto:", id);
        // Idealmente, passar o ID da loja tamb√©m para garantir o contexto
        if (currentLoja) {
            window.location.href = `editar.html?id=${id}&lojaId=${currentLoja.id}`;
        } else {
            alert("‚ö†Ô∏è Erro: N√£o foi poss√≠vel determinar a loja atual para edi√ß√£o.");
            window.location.href = `editar.html?id=${id}`; // Tenta ir mesmo sem lojaId
        }
    }

    // --- Event Listeners ---

    /**
     * Listener para o formul√°rio de adicionar novo produto.
     * Faz upload da imagem, cria o objeto Produto, adiciona o ID ao
     * IN√çCIO do array 'produtos' da Loja e recarrega a tabela.
     */
    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentLoja) { alert("‚ö†Ô∏è Voc√™ precisa ter uma loja ativa para adicionar produtos!"); return; }

      const nomeInput = document.getElementById('productName');
      const precoInput = document.getElementById('productPrice');
      const imagemInput = document.getElementById('productImage');
      const submitButton = e.target.querySelector('button[type="submit"]');

      const productData = {
        nome: nomeInput.value.trim(),
        preco: parseFloat(precoInput.value),
        imagemFile: imagemInput.files[0]
      };

      if (!productData.nome || isNaN(productData.preco) || productData.preco <= 0 || !productData.imagemFile) {
          alert("‚ùå Por favor, preencha todos os campos corretamente (nome, pre√ßo v√°lido e imagem).");
          return;
      }

      console.log("[Add Product] Adicionando novo produto:", productData.nome);
      submitButton.disabled = true;
      submitButton.textContent = 'Enviando...';

      try {
        // 1. Upload da imagem para o Parse
        console.log("[Add Product] Fazendo upload da imagem...");
        const parseFile = new Parse.File(productData.imagemFile.name, productData.imagemFile);
        await parseFile.save();
        const imageUrl = parseFile.url();
        console.log("[Add Product] Upload da imagem conclu√≠do:", imageUrl);

        // 2. Cria o novo objeto Produto no Parse
        const novoProduto = new Produto();
        novoProduto.set("nome", productData.nome);
        novoProduto.set("preco", productData.preco);
        novoProduto.set("imagens", [imageUrl]); // Salva URL em um array
        novoProduto.set("dono", Parse.User.current()); // Associa ao usu√°rio Parse atual
        novoProduto.set("loja", currentLoja); // **NOVO:** Associa diretamente √† Loja
        await novoProduto.save();
        console.log("[Add Product] Novo produto salvo no Parse:", novoProduto.id);

        // 3. Adiciona o ID do novo produto ao IN√çCIO do array 'produtos' na Loja
        currentLoja.addUnique("produtos", novoProduto.id); // Usa addUnique para evitar duplicatas
        // Para adicionar no in√≠cio (se addUnique n√£o garantir):
        let currentIds = currentLoja.get("produtos") || [];
        currentIds = currentIds.filter(id => id !== novoProduto.id); // Remove se existir
        currentIds.unshift(novoProduto.id); // Adiciona no in√≠cio
        currentLoja.set("produtos", currentIds);

        await currentLoja.save();
        console.log("[Add Product] ID do produto adicionado/atualizado na loja.");

        // 4. Limpa o formul√°rio e recarrega a lista
        document.getElementById('productForm').reset();
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('imagePreview').src = '';
        alert(`‚úÖ Produto "${productData.nome}" adicionado com sucesso!`);
        await loadProducts(); // Recarrega a tabela

      } catch (error) {
        console.error("[Add Product] Erro ao adicionar produto:", error);
        alert("‚ùå Erro ao adicionar produto: " + error.message);
      } finally {
          submitButton.disabled = false;
          submitButton.innerHTML = '‚ûï Adicionar Produto'; // Restaura √≠cone e texto
      }
    });

    /**
     * Listener para o bot√£o de logout.
     * Desloga do Firebase (o que deve deslogar do Parse via onAuthStateChanged em index.html)
     * e redireciona para index.html.
     */
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      console.log("[MinhaLoja Logout] Bot√£o Sair clicado.");
      try {
        await auth.signOut(); // Logout Firebase
        console.log("[MinhaLoja Logout] Firebase signOut conclu√≠do. Redirecionando...");
        // N√£o precisa deslogar do Parse aqui, index.html deve cuidar disso.
        // window.location.href = 'index.html'; // O onAuthStateChanged j√° redireciona
      } catch (error) {
        console.error('[MinhaLoja Logout] Erro no logout:', error);
        alert('‚ùå Erro ao tentar sair: ' + error.message + "\nRedirecionando para a p√°gina inicial.");
        window.location.href = 'index.html'; // For√ßa redirecionamento em caso de erro
      }
    });

    /**
     * Listener para o input de imagem, mostra preview.
     */
    document.getElementById('productImage').addEventListener('change', function(event) {
      const file = event.target.files[0];
      const preview = document.getElementById('imagePreview');
      if (file && file.type.startsWith('image/')) { // Verifica se √© imagem
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = 'block'; // Mostra preview
        };
        reader.onerror = function() {
            console.error("Erro ao ler o arquivo de imagem.");
            preview.style.display = 'none';
            preview.src = '';
            alert("Erro ao carregar a pr√©-visualiza√ß√£o da imagem.");
        }
        reader.readAsDataURL(file);
      } else {
          preview.style.display = 'none';
          preview.src = '';
          if (file) { // Se um arquivo foi selecionado mas n√£o √© imagem
              alert("Por favor, selecione um arquivo de imagem v√°lido (JPG, PNG, GIF, etc.).");
              event.target.value = null; // Limpa a sele√ß√£o inv√°lida
          }
      }
    });

    // --- Fun√ß√µes Auxiliares ---

    /**
     * Atualiza o cabe√ßalho da p√°gina com informa√ß√µes do usu√°rio Firebase.
     * @param {firebase.User} user Objeto do usu√°rio Firebase.
     */
    function updateHeader(user) {
      if (!user) return;
      const photoURL = user.photoURL || 'https://placehold.co/60x60/007BFF/FFF?text=:)'; // Placeholder
      const displayName = user.displayName || (user.email ? user.email.split('@')[0] : 'Usu√°rio');
      const email = user.email || 'Email n√£o dispon√≠vel';

      document.getElementById('profilePhoto').src = photoURL;
      document.getElementById('userName').textContent = displayName;
      document.getElementById('userEmail').textContent = email;
      console.log("[Update Header] Cabe√ßalho atualizado para:", displayName);
    }

    /**
     * Habilita/desabilita os bot√µes da tabela e o formul√°rio
     * para dar feedback visual durante opera√ß√µes ass√≠ncronas.
     * @param {boolean} isLoading True para desabilitar, false para habilitar.
     */
    function setTableLoading(isLoading) {
        const buttons = document.querySelectorAll('#productsTable .btn, #productsTable .btn-order, #productForm button, #productForm input');
        buttons.forEach(el => el.disabled = isLoading);

        const tableBody = document.querySelector('#productsTable tbody');
        if (isLoading && tableBody.rows.length === 0) { // Mostra carregando apenas se a tabela estiver vazia
             tableBody.innerHTML = `<tr><td colspan='4' style='text-align:center; padding: 20px; font-style: italic;'>Carregando produtos...</td></tr>`;
        } else if (!isLoading && tableBody.innerHTML.includes('Carregando produtos...')) {
            // Limpa a mensagem de carregando se n√£o for mais necess√°rio (ser√° preenchido por updateTable)
            // tableBody.innerHTML = ""; // updateTable far√° isso
        }
        // A reabilita√ß√£o espec√≠fica dos bot√µes de ordem √© feita em updateTable
    }

    /**
     * Habilita/desabilita APENAS os bot√µes de ordem (‚ñ≤/‚ñº).
     * Usado especificamente durante a opera√ß√£o de mover.
     * @param {boolean} isLoading True para desabilitar, false para habilitar.
     */
    function setOrderButtonsLoading(isLoading) {
        const orderButtons = document.querySelectorAll('#productsTable .btn-order');
        orderButtons.forEach(btn => { btn.disabled = isLoading; });
    }


    /**
     * Habilita a funcionalidade de arrastar para rolar horizontalmente
     * nos containers de imagem da tabela.
     */
    function enableDragToScroll() {
        document.querySelectorAll('.image-container').forEach(enableDragToScrollForElement);
    }
    function enableDragToScrollForElement(container) {
        if (!container) return;
        let isDown = false, startX, scrollLeft;
        // Remove listeners antigos para evitar duplica√ß√£o
        container.onmousedown = null; container.onmouseleave = null;
        container.onmouseup = null; container.onmousemove = null;

        container.style.cursor = 'grab'; // Cursor inicial

        container.onmousedown = (e) => {
            // Ignora se clicar em um bot√£o ou link dentro do container
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A') return;
            isDown = true; container.style.cursor = 'grabbing';
            startX = e.pageX - container.offsetLeft; scrollLeft = container.scrollLeft;
            container.style.userSelect = 'none'; // Previne sele√ß√£o de texto durante o arraste
        };
        container.onmouseleave = () => {
            if (!isDown) return;
            isDown = false; container.style.cursor = 'grab';
            container.style.userSelect = '';
        };
        container.onmouseup = () => {
             if (!isDown) return;
            isDown = false; container.style.cursor = 'grab';
            container.style.userSelect = '';
        };
        container.onmousemove = (e) => {
            if (!isDown) return;
            e.preventDefault(); // Previne comportamento padr√£o (como sele√ß√£o)
            const x = e.pageX - container.offsetLeft;
            const walk = (x - startX) * 1.5; // Multiplicador para sensibilidade
            container.scrollLeft = scrollLeft - walk;
        };
    }

    // Inicializa a funcionalidade de arrastar ao carregar a p√°gina
    enableDragToScroll();

  </script>
</body>
</html>
