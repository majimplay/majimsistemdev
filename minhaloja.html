<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Minha Loja</title>
  <style>
    /* Reset b√°sico e fontes */
    body {
      font-family: 'Segoe UI', sans-serif; /* Fonte mais moderna */
      background-color: #f0f2f5; /* Fundo suave */
      margin: 0;
      padding: 20px;
      color: #333; /* Cor de texto padr√£o */
      line-height: 1.6; /* Espa√ßamento entre linhas */
    }

    /* Cabe√ßalho do Perfil */
    .profile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem; /* Mais padding */
      background-color: white;
      border-radius: 12px; /* Bordas mais arredondadas */
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); /* Sombra mais suave */
      margin-bottom: 2rem;
    }

    .profile-photo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #007BFF; /* Borda mais destacada */
      margin-right: 1rem;
    }

    .profile-info h1, .profile-info p {
        margin: 0; /* Remove margens padr√£o */
        line-height: 1.3;
    }

    .profile-info h1 {
        font-size: 1.4rem; /* Tamanho do nome */
        color: #1c1e21; /* Cor mais escura */
    }

     .profile-info p {
        font-size: 0.9rem; /* Tamanho do email */
        color: #606770; /* Cor cinza para o email */
    }

    /* Cabe√ßalho da Loja */
     .store-header {
        background-color: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
        text-align: center; /* Centraliza o conte√∫do */
    }

    .store-header h1 {
        margin: 0 0 0.5rem 0; /* Espa√ßamento abaixo do nome */
        color: #007BFF; /* Cor azul */
        font-size: 1.8rem;
    }

    .store-header p {
        margin: 0;
        color: #606770; /* Cor cinza para reputa√ß√£o */
        font-size: 1rem;
    }

    /* Painel de Administra√ß√£o */
    .admin-panel {
      background-color: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

     .admin-panel h2 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #333;
        border-bottom: 1px solid #eee; /* Linha separadora */
        padding-bottom: 0.8rem;
    }

    /* Tabela de Produtos */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 2rem 0;
      table-layout: fixed; /* Ajuda a controlar largura das colunas */
    }

    th, td {
      padding: 1rem 0.8rem; /* Ajuste no padding */
      text-align: left;
      border-bottom: 1px solid #e0e0e0; /* Linha mais suave */
      vertical-align: middle; /* Alinha conte√∫do verticalmente */
       /* Evita quebra de linha e adiciona '...' */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    th {
      background-color: #f8f9fa; /* Fundo leve para cabe√ßalho */
      font-weight: 600; /* Fonte mais forte */
      color: #495057;
    }

    tr:hover {
      background-color: #f1f1f1; /* Destaque suave ao passar o mouse */
    }

    /* Larguras das colunas */
    .image-cell { width: 55%; } /* Mais espa√ßo para imagens */
    .text-cell { width: 15%; }
    .actions-cell { width: 15%; text-align: center;} /* A√ß√µes centralizadas */

    /* Imagens na Tabela */
    .product-image {
      height: 50px;
      width: 50px;
      min-width: 50px; /* Garante largura m√≠nima */
      border-radius: 6px; /* Bordas arredondadas */
      object-fit: cover;
      border: 1px solid #ddd;
      margin-right: 5px; /* Espa√ßo entre imagens */
      vertical-align: middle; /* Alinha com o texto */
    }

    /* Cont√™iner de Imagens com Rolagem */
    .image-container {
      display: flex; /* Organiza imagens lado a lado */
      flex-wrap: nowrap; /* Impede quebra de linha */
      overflow-x: auto; /* Habilita rolagem horizontal */
      overflow-y: hidden; /* Esconde rolagem vertical */
      padding: 5px 0; /* Pequeno padding vertical */
      gap: 8px; /* Espa√ßo entre as imagens */
      cursor: grab; /* Indica que pode arrastar */
      -webkit-overflow-scrolling: touch; /* Rolagem suave em iOS */
      scrollbar-width: thin; /* Barra de rolagem fina (Firefox) */
      scrollbar-color: #ccc #f0f0f0; /* Cor da barra de rolagem (Firefox) */
    }

    /* Estilo da barra de rolagem (Webkit - Chrome, Safari) */
    .image-container::-webkit-scrollbar {
      height: 6px; /* Altura da barra */
    }
    .image-container::-webkit-scrollbar-track {
      background: #f0f0f0; /* Fundo da barra */
      border-radius: 3px;
    }
    .image-container::-webkit-scrollbar-thumb {
      background-color: #ccc; /* Cor do 'polegar' da barra */
      border-radius: 3px;
    }
     .image-container::-webkit-scrollbar-thumb:hover {
        background-color: #aaa; /* Cor ao passar o mouse */
    }

    /* Cont√™iner de A√ß√µes */
    .actions-container {
      display: flex;
      flex-direction: column; /* Bot√µes empilhados */
      gap: 8px; /* Espa√ßo entre bot√µes */
      align-items: center; /* Centraliza bot√µes */
    }

    /* Formul√°rio */
    #productForm {
        display: flex;
        flex-wrap: wrap; /* Permite quebra de linha em telas menores */
        gap: 1rem; /* Espa√ßamento entre elementos */
        align-items: flex-end; /* Alinha itens na base */
        margin-bottom: 2rem;
        padding: 1.5rem; /* Padding interno */
        background-color: #f8f9fa; /* Fundo leve */
        border-radius: 8px;
    }

    input[type="text"], input[type="number"] {
      padding: 10px 12px; /* Mais padding interno */
      border: 1px solid #ccc;
      border-radius: 6px; /* Bordas arredondadas */
      font-size: 0.95rem;
      flex-grow: 1; /* Permite que campos cres√ßam */
      min-width: 150px; /* Largura m√≠nima */
    }

    /* Upload de Imagem */
    .image-upload {
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }

    .image-upload input[type="file"] {
      display: none; /* Esconde o input original */
    }

    .upload-label {
      background-color: #2196F3; /* Azul */
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-size: 0.9rem;
      display: inline-flex; /* Para alinhar √≠cone e texto */
      align-items: center;
      gap: 5px;
    }

    .upload-label:hover {
      background-color: #1976D2; /* Azul mais escuro */
    }

    #imagePreview {
      max-height: 50px; /* Altura da miniatura */
      max-width: 50px;
      margin: 0; /* Remove margem padr√£o */
      border-radius: 4px;
      border: 1px solid #ddd;
      display: none; /* Come√ßa escondida */
      object-fit: cover;
    }

    /* Bot√µes */
    .btn {
      padding: 10px 18px; /* Mais padding */
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease; /* Transi√ß√£o suave */
      font-size: 0.9rem;
      font-weight: 500; /* Peso da fonte */
      display: inline-flex;
      align-items: center;
      gap: 5px; /* Espa√ßo entre √≠cone e texto */
      text-transform: uppercase; /* Texto em mai√∫sculas */
      letter-spacing: 0.5px; /* Espa√ßamento entre letras */
    }

    .btn-edit {
      background-color: #4CAF50; /* Verde */
      color: white;
    }
    .btn-edit:hover {
      background-color: #45a049; /* Verde mais escuro */
      box-shadow: 0 2px 5px rgba(0,0,0,0.2); /* Sombra no hover */
    }

    .btn-delete {
      background-color: #f44336; /* Vermelho */
      color: white;
    }
    .btn-delete:hover {
      background-color: #e53935; /* Vermelho mais escuro */
       box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .btn-secondary { /* Bot√£o Sair */
      background-color: #6c757d; /* Cinza */
      color: white;
    }
    .btn-secondary:hover {
      background-color: #5a6268; /* Cinza mais escuro */
       box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Responsividade b√°sica */
    @media (max-width: 768px) {
        .profile-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        #productForm {
            flex-direction: column;
            align-items: stretch; /* Estica itens no modo coluna */
        }
        input[type="text"], input[type="number"], .image-upload, .btn {
            width: 100%; /* Ocupa largura total */
            box-sizing: border-box; /* Inclui padding na largura */
        }
        .actions-cell {
            text-align: left; /* Alinha a√ß√µes √† esquerda em telas pequenas */
        }
        .actions-container {
            flex-direction: row; /* Bot√µes lado a lado se couber */
            flex-wrap: wrap; /* Quebra linha se n√£o couber */
             align-items: center;
             justify-content: flex-start;
        }
        th, td {
            white-space: normal; /* Permite quebra de linha */
            overflow: visible;
            text-overflow: clip;
        }
        .image-cell { width: auto; } /* Remove largura fixa */
        .text-cell { width: auto; }
        .actions-cell { width: auto;}
    }

  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
</head>
<body>
  <div class="profile-header">
    <div style="display: flex; align-items: center;">
      <img id="profilePhoto" class="profile-photo" src="avatar-padrao.jpeg" alt="Foto de Perfil">
      <div class="profile-info">
        <h1 id="userName">Carregando...</h1>
        <p id="userEmail"></p>
      </div>
    </div>
    <button id="logoutBtn" class="btn btn-secondary">üö™ Sair</button>
  </div>

  <div class="store-header">
    <h1 id="nomeLoja">Carregando nome da loja...</h1>
	  <p id="reputacaoLoja">Reputa√ß√£o: 0</p>
  </div>

  <div class="admin-panel">
    <h2>Gerenciamento de Produtos</h2>

    <form id="productForm">
      <input type="text" id="productName" placeholder="Nome do Produto" required>
      <input type="number" id="productPrice" step="0.01" placeholder="Pre√ßo (R$)" required>
      <div class="image-upload">
         <img id="imagePreview" src="" alt="Miniatura">
        <label class="upload-label">
          üì∑ Escolher Imagem
          <input type="file" id="productImage" accept="image/*" required>
        </label>
      </div>
      <button type="submit" class="btn btn-edit">‚ûï Adicionar Produto</button>
    </form>

    <table id="productsTable">
      <thead>
        <tr>
          <th class="image-cell">Imagens</th>
          <th class="text-cell">Produto</th>
          <th class="text-cell">Pre√ßo</th>
          <th class="actions-cell">A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>

  <script>
    // --- Configura√ß√µes ---
    const firebaseConfig = {
      apiKey: "AIzaSyDlUQbbTP29VqBVmzOGHhfc67R1DTRPwxg", // ATEN√á√ÉO: Considere mover para vari√°veis de ambiente
      authDomain: "gitautenticatio.firebaseapp.com",
      projectId: "gitautenticatio",
      storageBucket: "gitautenticatio.appspot.com",
      messagingSenderId: "21514234895",
      appId: "1:21514234895:web:d34dc4c44baf586d2cc77a"
    };

    // Chaves do Back4App (Parse)
    // ATEN√á√ÉO: Considere mover para vari√°veis de ambiente ou Cloud Code
    Parse.initialize("TYP8SUA8qxmHIRs1mHbiFalgRxCEf51sOiSWmNEY", "n4Gfko9sO7jiAUnWX5U5GGCDQ5QtPWX97K4TzB8I");
    Parse.serverURL = "https://parseapi.back4app.com/";

    // Defini√ß√£o das Classes (Tabelas) do Parse
    const Produto = Parse.Object.extend("Produto");
    const Loja = Parse.Object.extend("Loja");

    // --- Inicializa√ß√£o ---
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    let currentLoja = null; // Vari√°vel para armazenar a loja atual do usu√°rio

    // --- L√≥gica Principal ---

    // Monitora o estado de autentica√ß√£o do Firebase
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        // Usu√°rio est√° logado
        console.log("Usu√°rio autenticado:", user.uid);
        try {
          // Tenta logar no Parse usando o UID do Firebase como username e password
          // Isso assume que voc√™ criou usu√°rios no Parse com UID do Firebase
          // Se for a primeira vez, pode precisar registrar ou usar outro m√©todo de link
          if (!Parse.User.current()) {
             console.log("Tentando login no Parse...");
             // Tenta fazer login. Se falhar (usu√°rio n√£o existe), tenta cadastrar.
            try {
                await Parse.User.logIn(user.uid, user.uid);
                console.log("Login no Parse bem-sucedido.");
            } catch (loginError) {
                // Se o login falhar (provavelmente usu√°rio n√£o existe no Parse)
                if (loginError.code === Parse.Error.OBJECT_NOT_FOUND) {
                    console.log("Usu√°rio n√£o encontrado no Parse. Tentando cadastrar...");
                    const newUser = new Parse.User();
                    newUser.set("username", user.uid);
                    newUser.set("password", user.uid); // Use o UID como senha inicial
                    newUser.set("email", user.email); // Opcional: salvar email
                    // Adicione outros campos se necess√°rio (ex: nome do Firebase)
                    newUser.set("firebaseUID", user.uid); // Link expl√≠cito

                    try {
                        await newUser.signUp();
                        console.log("Novo usu√°rio cadastrado e logado no Parse.");
                    } catch (signUpError) {
                        console.error("Erro ao cadastrar usu√°rio no Parse:", signUpError);
                        alert("Erro cr√≠tico ao sincronizar contas. Tente novamente mais tarde.");
                        // For√ßar logout se n√£o conseguir sincronizar
                        await auth.signOut();
                        return; // Interrompe a execu√ß√£o
                    }
                } else {
                    // Outro erro de login no Parse
                    console.error("Erro ao fazer login no Parse:", loginError);
                    alert("Erro ao acessar sua conta no sistema. Tente novamente.");
                     await auth.signOut(); // For√ßa logout em caso de erro inesperado
                    return; // Interrompe
                }
            }
          } else {
            console.log("Sess√£o Parse j√° existente.");
          }

          // Ap√≥s garantir login no Parse, verifica/cria a loja
          await checkOrCreateLoja();
          // Atualiza o cabe√ßalho da p√°gina com dados do usu√°rio
          updateHeader(user);
          // Carrega os produtos da loja atual
          if (currentLoja) { // S√≥ carrega produtos se a loja foi definida
             loadProducts();
          }

        } catch (error) {
          // Captura erros gerais durante o processo de login/verifica√ß√£o
          console.error("Erro durante a inicializa√ß√£o do usu√°rio:", error);
          alert("Ocorreu um erro ao carregar seus dados: " + error.message);
          // Redireciona para a p√°gina de login em caso de erro grave
          window.location.href = 'index.html';
        }
      } else {
        // Usu√°rio n√£o est√° logado, redireciona para a p√°gina de login
        console.log("Usu√°rio n√£o autenticado. Redirecionando para login.");
        window.location.href = 'index.html';
      }
    });

    // Verifica se o usu√°rio atual j√° tem uma loja; se n√£o, pede para criar uma
    const checkOrCreateLoja = async () => {
      const currentUser = Parse.User.current();
      if (!currentUser) {
          console.error("Tentativa de verificar loja sem usu√°rio Parse logado.");
          // Idealmente, isso n√£o deveria acontecer por causa da l√≥gica em onAuthStateChanged
          alert("Erro: Usu√°rio n√£o sincronizado. Por favor, recarregue a p√°gina.");
          return; // Interrompe
      }

      const query = new Parse.Query(Loja);
      // Busca a loja onde o campo 'dono' √© um ponteiro para o usu√°rio atual
      query.equalTo("dono", currentUser);

      try {
          currentLoja = await query.first(); // Tenta encontrar a loja

          if (!currentLoja) {
            // Se n√£o encontrou a loja, pede um nome e cria uma nova
            console.log("Nenhuma loja encontrada para o usu√°rio. Solicitando cria√ß√£o.");
            const nomeLoja = prompt("üì¢ Bem-vindo! Parece que voc√™ ainda n√£o tem uma loja.\nDigite um nome para sua nova loja:");

            if (!nomeLoja || nomeLoja.trim() === "") {
                alert("‚ùå Nome da loja inv√°lido. A cria√ß√£o foi cancelada.");
                // Poderia for√ßar logout ou dar outra chance, mas por ora s√≥ avisa.
                // Sem loja, o usu√°rio n√£o poder√° adicionar produtos.
                document.getElementById('nomeLoja').textContent = "Crie uma loja para come√ßar!";
                document.getElementById('reputacaoLoja').textContent = "";
                return; // Sai da fun√ß√£o se o nome for inv√°lido ou cancelado
            }

            console.log("Criando nova loja:", nomeLoja);
            currentLoja = new Loja();
            currentLoja.set("nome", nomeLoja.trim());
            currentLoja.set("dono", currentUser); // Associa a loja ao usu√°rio logado
            currentLoja.set("produtos", []); // Inicializa a lista de produtos vazia
            currentLoja.set("reputacao", 0); // Reputa√ß√£o inicial
            await currentLoja.save(); // Salva a nova loja no Back4App
            console.log("Loja criada com sucesso:", currentLoja.id);
            alert(`üéâ Loja "${nomeLoja}" criada com sucesso!`);
          } else {
              console.log("Loja encontrada:", currentLoja.id, "Nome:", currentLoja.get("nome"));
          }

          // Atualiza o nome e a reputa√ß√£o da loja na p√°gina
          document.getElementById('nomeLoja').textContent = currentLoja.get("nome");
          document.getElementById('reputacaoLoja').textContent = "Reputa√ß√£o: " + currentLoja.get("reputacao");

      } catch (error) {
          console.error("Erro ao verificar ou criar loja:", error);
          alert("Erro ao carregar ou criar sua loja: " + error.message);
          // Considerar o que fazer aqui - talvez redirecionar ou mostrar mensagem de erro persistente
      }
    };

    // Carrega os produtos associados √† loja atual
    const loadProducts = async () => {
       if (!currentLoja) {
        console.warn("Tentativa de carregar produtos sem uma loja definida.");
        // Limpa a tabela caso n√£o haja loja (ou tenha ocorrido erro)
        document.querySelector('#productsTable tbody').innerHTML = "<tr><td colspan='4'>Crie ou selecione uma loja para ver os produtos.</td></tr>";
        return;
       }

      // Pega a lista de IDs de produtos da loja atual
      const productRelation = currentLoja.relation("produtos"); // Usando Relation
      const query = productRelation.query(); // Cria uma query a partir da Relation

      // Opcional: Ordenar produtos, por exemplo, por data de cria√ß√£o
      query.descending("createdAt");

      console.log("Carregando produtos da loja:", currentLoja.id);

      try {
        const results = await query.find(); // Busca os produtos relacionados
        console.log("Produtos carregados:", results.length);
        updateTable(results); // Atualiza a tabela HTML com os produtos encontrados
      } catch (error) {
        console.error("Erro ao carregar produtos:", error);
        alert("Erro ao carregar produtos da loja: " + error.message);
         document.querySelector('#productsTable tbody').innerHTML = `<tr><td colspan='4'>Erro ao carregar produtos: ${error.message}</td></tr>`;
      }
    };

    // Atualiza a tabela HTML com a lista de produtos
    const updateTable = (produtos) => {
      const tbody = document.querySelector('#productsTable tbody');
      tbody.innerHTML = ""; // Limpa a tabela antes de adicionar as novas linhas

      if (produtos.length === 0) {
          tbody.innerHTML = "<tr><td colspan='4' style='text-align:center; padding: 20px;'>üõí Sua loja ainda n√£o tem produtos cadastrados.</td></tr>";
          return;
      }

      produtos.forEach(produto => {
        const tr = document.createElement('tr');
        tr.dataset.productId = produto.id; // Adiciona ID ao elemento TR para refer√™ncia

        // Coluna de Imagens
        const imagens = produto.get("imagens") || []; // Pega array de URLs ou array vazio
        const imagensHtml = imagens.length > 0
            ? imagens.map(url => `<img src="${url}" class="product-image" alt="Imagem do produto" onerror="this.src='placeholder-imagem.png'; this.alt='Imagem indispon√≠vel'">`).join('')
            : '<span>Sem imagem</span>'; // Mensagem se n√£o houver imagens

        // Coluna de A√ß√µes
        const acoesHtml = `
          <div class="actions-container">
            <button class="btn btn-edit" onclick="editProduct('${produto.id}')">‚úèÔ∏è Editar</button>
            <button class="btn btn-delete" onclick="deleteProduct('${produto.id}')">üóëÔ∏è Excluir</button>
          </div>
        `;

        tr.innerHTML = `
          <td class="image-cell">
            <div class="image-container">${imagensHtml}</div>
          </td>
          <td class="text-cell">${produto.get("nome") || 'Sem nome'}</td>
          <td class="text-cell">R$ ${(produto.get("preco") || 0).toFixed(2)}</td>
          <td class="actions-cell">${acoesHtml}</td>
        `;
        tbody.appendChild(tr);
      });

      // Reativar funcionalidade de arrastar para rolar ap√≥s atualizar a tabela
      enableDragToScroll();
    };

    // Fun√ß√£o para deletar um produto
    window.deleteProduct = async (id) => {
      if (!confirm("‚ùì Tem certeza que deseja excluir este produto? Esta a√ß√£o n√£o pode ser desfeita.")) {
          return; // Cancela se o usu√°rio n√£o confirmar
      }

      if (!currentLoja) {
          alert("‚ùå Erro: Loja n√£o encontrada para remover o produto.");
          return;
      }

      console.log("Tentando excluir produto:", id);

      try {
        // 1. Encontra o objeto do produto a ser deletado
        const query = new Parse.Query(Produto);
        const produto = await query.get(id);

        // 2. Remove a rela√ß√£o do produto com a loja
        const relation = currentLoja.relation("produtos");
        relation.remove(produto); // Remove o objeto Produto da rela√ß√£o
        await currentLoja.save(); // Salva a loja com a rela√ß√£o atualizada
        console.log("Rela√ß√£o do produto removida da loja.");

        // 3. Deleta o objeto do produto permanentemente
        await produto.destroy();
        console.log("Objeto do produto destru√≠do:", id);

        // 4. Remove a linha da tabela na interface
        const rowToRemove = document.querySelector(`tr[data-product-id="${id}"]`);
        if (rowToRemove) {
            rowToRemove.remove();
             console.log("Linha da tabela removida.");
        }
         // Opcional: Recarregar a lista completa para garantir consist√™ncia
         // loadProducts();
         alert("‚úÖ Produto exclu√≠do com sucesso!");


      } catch (error) {
        console.error("Erro na exclus√£o do produto:", error);
        alert("‚ùå Erro ao excluir o produto: " + error.message);
      }
    };

    // Fun√ß√£o para redirecionar para a p√°gina de edi√ß√£o
    window.editProduct = (id) => {
        console.log("Redirecionando para editar produto:", id);
        // Passa o ID do produto como par√¢metro na URL
        window.location.href = `editar.html?id=${id}`;
    }

    // --- Event Listeners ---

    // Listener para o envio do formul√°rio de adicionar produto
    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault(); // Impede o envio padr√£o do formul√°rio

      if (!currentLoja) {
       alert("‚ö†Ô∏è Aten√ß√£o: Voc√™ precisa ter uma loja definida para adicionar produtos!");
       console.warn("Tentativa de adicionar produto sem loja definida.");
       return; // Interrompe se n√£o houver loja
      }

      const nomeInput = document.getElementById('productName');
      const precoInput = document.getElementById('productPrice');
      const imagemInput = document.getElementById('productImage');
      const submitButton = e.target.querySelector('button[type="submit"]');

      const productData = {
        nome: nomeInput.value.trim(),
        preco: parseFloat(precoInput.value),
        imagemFile: imagemInput.files[0] // Pega o arquivo de imagem
      };

      // Valida√ß√µes b√°sicas
      if (!productData.nome) {
          alert("‚ùå Por favor, insira o nome do produto.");
          nomeInput.focus();
          return;
      }
       if (isNaN(productData.preco) || productData.preco <= 0) {
          alert("‚ùå Por favor, insira um pre√ßo v√°lido maior que zero.");
          precoInput.focus();
          return;
      }
       if (!productData.imagemFile) {
          alert("‚ùå Por favor, escolha uma imagem para o produto.");
          return;
      }

      console.log("Adicionando novo produto:", productData.nome);
      submitButton.disabled = true; // Desabilita bot√£o para evitar cliques duplos
      submitButton.textContent = 'Enviando...'; // Feedback visual

      try {
        // 1. Faz upload da imagem para o Back4App
        console.log("Fazendo upload da imagem...");
        const parseFile = new Parse.File(productData.imagemFile.name, productData.imagemFile);
        await parseFile.save(); // Salva o arquivo no Parse
        const imageUrl = parseFile.url(); // Obt√©m a URL p√∫blica do arquivo salvo
        console.log("Upload da imagem conclu√≠do:", imageUrl);

        // 2. Cria o novo objeto Produto no Back4App
        const novoProduto = new Produto();
        novoProduto.set("nome", productData.nome);
        novoProduto.set("preco", productData.preco);
        novoProduto.set("imagens", [imageUrl]); // Salva a URL da imagem num array
        // Associa o produto ao usu√°rio dono da loja (opcional, mas pode ser √∫til)
        novoProduto.set("dono", Parse.User.current());

        // Salva o objeto Produto
        await novoProduto.save();
        console.log("Novo produto salvo no Parse:", novoProduto.id);

        // 3. Adiciona a rela√ß√£o entre a Loja e o novo Produto
        const relation = currentLoja.relation("produtos");
        relation.add(novoProduto); // Adiciona o objeto Produto √† rela√ß√£o
        await currentLoja.save(); // Salva a loja com a nova rela√ß√£o
        console.log("Produto adicionado √† rela√ß√£o da loja.");

        // 4. Limpa o formul√°rio e atualiza a interface
        document.getElementById('productForm').reset(); // Limpa os campos
        document.getElementById('imagePreview').style.display = 'none'; // Esconde a miniatura
        document.getElementById('imagePreview').src = ''; // Limpa a miniatura
        submitButton.disabled = false; // Reabilita o bot√£o
        submitButton.innerHTML = '‚ûï Adicionar Produto'; // Restaura texto do bot√£o

        // Adiciona o novo produto √† tabela imediatamente (melhor UX que recarregar tudo)
        addProductToTable(novoProduto);

        alert(`‚úÖ Produto "${productData.nome}" adicionado com sucesso!`);

      } catch (error) {
        console.error("Erro ao adicionar produto:", error);
        alert("‚ùå Erro ao adicionar produto: " + error.message);
        submitButton.disabled = false; // Reabilita bot√£o em caso de erro
        submitButton.innerHTML = '‚ûï Adicionar Produto';
      }
    });

    // Adiciona uma linha de produto √† tabela (usado ap√≥s adicionar novo produto)
    function addProductToTable(produto) {
        const tbody = document.querySelector('#productsTable tbody');
        // Remove mensagem de "sem produtos" se existir
        const noProductRow = tbody.querySelector("td[colspan='4']");
        if (noProductRow) {
            noProductRow.parentElement.remove();
        }

        const tr = document.createElement('tr');
        tr.dataset.productId = produto.id;

        const imagens = produto.get("imagens") || [];
        const imagensHtml = imagens.length > 0
            ? imagens.map(url => `<img src="${url}" class="product-image" alt="Imagem do produto" onerror="this.src='placeholder-imagem.png'; this.alt='Imagem indispon√≠vel'">`).join('')
            : '<span>Sem imagem</span>';

        const acoesHtml = `
          <div class="actions-container">
            <button class="btn btn-edit" onclick="editProduct('${produto.id}')">‚úèÔ∏è Editar</button>
            <button class="btn btn-delete" onclick="deleteProduct('${produto.id}')">üóëÔ∏è Excluir</button>
          </div>
        `;

        tr.innerHTML = `
          <td class="image-cell">
            <div class="image-container">${imagensHtml}</div>
          </td>
          <td class="text-cell">${produto.get("nome") || 'Sem nome'}</td>
          <td class="text-cell">R$ ${(produto.get("preco") || 0).toFixed(2)}</td>
          <td class="actions-cell">${acoesHtml}</td>
        `;
        // Adiciona a nova linha no in√≠cio da tabela (ou no final com appendChild)
        tbody.prepend(tr);

        // Reativa o drag-to-scroll para o novo container de imagem
        enableDragToScrollForElement(tr.querySelector('.image-container'));
    }


    // Listener para o bot√£o de logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      console.log("Iniciando processo de logout...");
      try {
        await auth.signOut(); // Faz logout do Firebase
        console.log("Logout do Firebase conclu√≠do.");
        await Parse.User.logOut(); // Faz logout do Parse
        console.log("Logout do Parse conclu√≠do.");
        // Redireciona para a p√°gina de login ap√≥s logout bem-sucedido
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Erro no logout:', error);
        alert('‚ùå Erro ao tentar sair: ' + error.message);
      }
    });

    // Listener para mostrar a pr√©-visualiza√ß√£o da imagem ao escolher um arquivo
    document.getElementById('productImage').addEventListener('change', function(event) {
      const file = event.target.files[0];
      const preview = document.getElementById('imagePreview');
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result; // Define o src da img com o Data URL
          preview.style.display = 'block'; // Mostra a imagem de preview
        };
        reader.readAsDataURL(file); // L√™ o arquivo como Data URL
      } else {
          // Se nenhum arquivo for selecionado (ou sele√ß√£o cancelada)
          preview.style.display = 'none'; // Esconde a preview
          preview.src = ''; // Limpa o src
      }
    });

    // --- Fun√ß√µes Auxiliares ---

    // Atualiza o cabe√ßalho da p√°gina com informa√ß√µes do usu√°rio Firebase
    function updateHeader(user) {
      if (!user) return; // N√£o faz nada se o usu√°rio for nulo
      document.getElementById('profilePhoto').src = user.photoURL || 'avatar-padrao.jpeg'; // Usa foto do perfil ou padr√£o
      document.getElementById('userName').textContent = user.displayName || user.email || 'Usu√°rio An√¥nimo'; // Nome, email ou gen√©rico
      document.getElementById('userEmail').textContent = user.email || ''; // Email
    }

    // Habilita a funcionalidade de arrastar para rolar nos cont√™ineres de imagem
    function enableDragToScroll() {
        const containers = document.querySelectorAll('.image-container');
        containers.forEach(container => {
            enableDragToScrollForElement(container);
        });
    }

    // Aplica a l√≥gica de arrastar para rolar a um elemento espec√≠fico
    function enableDragToScrollForElement(container) {
        if (!container) return;
        let isDown = false;
        let startX;
        let scrollLeft;

        container.addEventListener('mousedown', (e) => {
            isDown = true;
            container.style.cursor = 'grabbing'; // Muda cursor ao clicar
            startX = e.pageX - container.offsetLeft;
            scrollLeft = container.scrollLeft;
        });

        container.addEventListener('mouseleave', () => {
            if (!isDown) return;
            isDown = false;
            container.style.cursor = 'grab'; // Restaura cursor
        });

        container.addEventListener('mouseup', () => {
             if (!isDown) return;
            isDown = false;
            container.style.cursor = 'grab'; // Restaura cursor
        });

        container.addEventListener('mousemove', (e) => {
            if (!isDown) return;
            e.preventDefault(); // Previne sele√ß√£o de texto ao arrastar
            const x = e.pageX - container.offsetLeft;
            const walk = (x - startX) * 1.5; // Multiplicador para sensibilidade do arraste
            container.scrollLeft = scrollLeft - walk;
        });
    }

    // Habilita o arraste para rolar inicialmente
    enableDragToScroll();

  </script>
</body>
</html>
