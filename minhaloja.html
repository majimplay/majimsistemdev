<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Minha Loja</title>
  <style>
    /* Reset b√°sico e fontes */
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f2f5;
      margin: 0;
      padding: 20px;
      color: #333;
      line-height: 1.6;
    }

    /* Cabe√ßalho do Perfil */
    .profile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      background-color: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 2rem;
    }

    .profile-photo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #007BFF;
      margin-right: 1rem;
    }

    .profile-info h1, .profile-info p {
        margin: 0;
        line-height: 1.3;
    }

    .profile-info h1 {
        font-size: 1.4rem;
        color: #1c1e21;
    }

     .profile-info p {
        font-size: 0.9rem;
        color: #606770;
    }

    /* Cabe√ßalho da Loja */
     .store-header {
        background-color: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        margin-bottom: 2rem;
        text-align: center;
    }

    .store-header h1 {
        margin: 0 0 0.5rem 0;
        color: #007BFF;
        font-size: 1.8rem;
    }

    .store-header p {
        margin: 0;
        color: #606770;
        font-size: 1rem;
    }

    /* Painel de Administra√ß√£o */
    .admin-panel {
      background-color: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

     .admin-panel h2 {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 0.8rem;
    }

    /* Tabela de Produtos */
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 2rem 0;
      table-layout: fixed;
    }

    th, td {
      padding: 1rem 0.8rem;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
      vertical-align: middle;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    th {
      background-color: #f8f9fa;
      font-weight: 600;
      color: #495057;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    /* Larguras das colunas */
    .image-cell { width: 60%; } /* Ajustado */
    .text-cell { width: 10%; }
    .order-cell { width: 10%; text-align: center; } /* Nova coluna Ordem */
    .actions-cell { width: 10%; text-align: center;}

    /* Imagens na Tabela */
    .product-image {
      height: 50px;
      width: 50px;
      min-width: 50px;
      border-radius: 6px;
      object-fit: cover;
      border: 1px solid #ddd;
      margin-right: 5px;
      vertical-align: middle;
    }

    /* Cont√™iner de Imagens com Rolagem */
    .image-container {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      padding: 5px 0;
      gap: 8px;
      cursor: grab;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: #ccc #f0f0f0;
    }
    .image-container::-webkit-scrollbar { height: 6px; }
    .image-container::-webkit-scrollbar-track { background: #f0f0f0; border-radius: 3px; }
    .image-container::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 3px; }
    .image-container::-webkit-scrollbar-thumb:hover { background-color: #aaa; }

     /* Cont√™iner de Ordem e A√ß√µes */
    .order-container, .actions-container {
      display: flex;
      flex-direction: column; /* Itens empilhados */
      gap: 8px;
      align-items: center; /* Centraliza itens */
      justify-content: center; /* Centraliza verticalmente */
      height: 100%; /* Ocupa altura da c√©lula */
    }

    /* Bot√µes de Ordena√ß√£o */
    .btn-order {
      background-color: #6c757d; /* Cinza */
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px; /* Menor padding */
      cursor: pointer;
      font-size: 0.8rem; /* Tamanho menor */
      line-height: 1; /* Ajuste linha */
      transition: background-color 0.2s ease;
    }
    .btn-order:hover:not(:disabled) {
       background-color: #5a6268;
    }
    .btn-order:disabled {
        background-color: #adb5bd; /* Cinza mais claro para desabilitado */
        cursor: not-allowed;
        opacity: 0.7;
    }


    /* Formul√°rio */
    #productForm {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        align-items: flex-end;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background-color: #f8f9fa;
        border-radius: 8px;
    }

    input[type="text"], input[type="number"] {
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 0.95rem;
      flex-grow: 1;
      min-width: 150px;
    }

    /* Upload de Imagem */
    .image-upload {
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }

    .image-upload input[type="file"] { display: none; }

    .upload-label {
      background-color: #2196F3;
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .upload-label:hover { background-color: #1976D2; }

    #imagePreview {
      max-height: 50px;
      max-width: 50px;
      margin: 0;
      border-radius: 4px;
      border: 1px solid #ddd;
      display: none;
      object-fit: cover;
    }

    /* Bot√µes Gerais */
    .btn {
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
     .btn:disabled {
        cursor: not-allowed;
        opacity: 0.6;
    }

    .btn-edit { background-color: #4CAF50; color: white; }
    .btn-edit:hover:not(:disabled) { background-color: #45a049; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

    .btn-delete { background-color: #f44336; color: white; }
    .btn-delete:hover:not(:disabled) { background-color: #e53935; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

    .btn-secondary { background-color: #6c757d; color: white; }
    .btn-secondary:hover:not(:disabled) { background-color: #5a6268; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

    /* Responsividade */
    @media (max-width: 768px) {
        .profile-header { flex-direction: column; align-items: flex-start; gap: 1rem; }
        #productForm { flex-direction: column; align-items: stretch; }
        input[type="text"], input[type="number"], .image-upload, .btn { width: 100%; box-sizing: border-box; }
        .actions-cell, .order-cell { text-align: left; } /* Alinha √† esquerda */
        .actions-container, .order-container { flex-direction: row; flex-wrap: wrap; justify-content: flex-start; } /* Lado a lado */
        th, td { white-space: normal; overflow: visible; text-overflow: clip; }
        .image-cell, .text-cell, .actions-cell, .order-cell { width: auto; } /* Largura autom√°tica */

        /* Ajuste fino para bot√µes em telas pequenas */
        .order-container .btn-order { padding: 6px 10px; font-size: 0.9rem; }
        .actions-container .btn { padding: 8px 12px; }
    }

  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
</head>
<body>
  <div class="profile-header">
    <div style="display: flex; align-items: center;">
      <img id="profilePhoto" class="profile-photo" src="avatar-padrao.jpeg" alt="Foto de Perfil">
      <div class="profile-info">
        <h1 id="userName">Carregando...</h1>
        <p id="userEmail"></p>
      </div>
    </div>
    <button id="logoutBtn" class="btn btn-secondary">üö™ Sair</button>
  </div>

  <div class="store-header">
    <h1 id="nomeLoja">Carregando nome da loja...</h1>
	  <p id="reputacaoLoja">Reputa√ß√£o: 0</p>
  </div>

  <div class="admin-panel">
    <h2>Gerenciamento de Produtos</h2>

    <form id="productForm">
      <input type="text" id="productName" placeholder="Nome do Produto" required>
      <input type="number" id="productPrice" step="0.01" placeholder="Pre√ßo (R$)" required>
      <div class="image-upload">
        <img id="imagePreview" src="" alt="Miniatura">
        <label class="upload-label">
          üì∑ Escolher Imagem
          <input type="file" id="productImage" accept="image/*" required>
        </label>
      </div>
      <button type="submit" class="btn btn-edit">‚ûï Adicionar Produto</button>
    </form>

    <table id="productsTable">
      <thead>
        <tr>
          <th class="image-cell">Imagens</th>
          <th class="text-cell">Produto</th>
          <th class="text-cell">Pre√ßo</th>
          <th class="order-cell">Ordem</th> <th class="actions-cell">A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>

  <script>
    // --- Configura√ß√µes ---
    const firebaseConfig = {
      apiKey: "AIzaSyDlUQbbTP29VqBVmzOGHhfc67R1DTRPwxg", // ATEN√á√ÉO: Mover para vari√°veis de ambiente
      authDomain: "gitautenticatio.firebaseapp.com",
      projectId: "gitautenticatio",
      storageBucket: "gitautenticatio.appspot.com",
      messagingSenderId: "21514234895",
      appId: "1:21514234895:web:d34dc4c44baf586d2cc77a"
    };
    Parse.initialize("TYP8SUA8qxmHIRs1mHbiFalgRxCEf51sOiSWmNEY", "n4Gfko9sO7jiAUnWX5U5GGCDQ5QtPWX97K4TzB8I"); // ATEN√á√ÉO: Mover para vari√°veis de ambiente
    Parse.serverURL = "https://parseapi.back4app.com/";

    const Produto = Parse.Object.extend("Produto");
    const Loja = Parse.Object.extend("Loja");

    // --- Inicializa√ß√£o ---
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    let currentLoja = null;
    let isLoadingProducts = false; // Flag para evitar m√∫ltiplas chamadas

    // --- L√≥gica Principal ---
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        console.log("Usu√°rio autenticado:", user.uid);
        try {
          if (!Parse.User.current()) {
             console.log("Tentando login no Parse...");
            try {
                await Parse.User.logIn(user.uid, user.uid);
                console.log("Login no Parse bem-sucedido.");
            } catch (loginError) {
                if (loginError.code === Parse.Error.OBJECT_NOT_FOUND) {
                    console.log("Usu√°rio n√£o encontrado no Parse. Tentando cadastrar...");
                    const newUser = new Parse.User();
                    newUser.set("username", user.uid);
                    newUser.set("password", user.uid);
                    newUser.set("email", user.email);
                    newUser.set("firebaseUID", user.uid);
                    try {
                        await newUser.signUp();
                        console.log("Novo usu√°rio cadastrado e logado no Parse.");
                    } catch (signUpError) {
                        console.error("Erro ao cadastrar usu√°rio no Parse:", signUpError);
                        alert("Erro cr√≠tico ao sincronizar contas.");
                        await auth.signOut(); return;
                    }
                } else {
                    console.error("Erro ao fazer login no Parse:", loginError);
                    alert("Erro ao acessar sua conta no sistema.");
                     await auth.signOut(); return;
                }
            }
          } else {
            console.log("Sess√£o Parse j√° existente.");
          }

          await checkOrCreateLoja();
          updateHeader(user);
          if (currentLoja) {
             loadProducts();
          }

        } catch (error) {
          console.error("Erro durante a inicializa√ß√£o do usu√°rio:", error);
          alert("Ocorreu um erro ao carregar seus dados: " + error.message);
          window.location.href = 'index.html';
        }
      } else {
        console.log("Usu√°rio n√£o autenticado. Redirecionando para login.");
        window.location.href = 'index.html';
      }
    });

    const checkOrCreateLoja = async () => {
      const currentUser = Parse.User.current();
      if (!currentUser) {
          console.error("Tentativa de verificar loja sem usu√°rio Parse logado.");
          alert("Erro: Usu√°rio n√£o sincronizado."); return;
      }
      const query = new Parse.Query(Loja);
      query.equalTo("dono", currentUser);
      try {
          currentLoja = await query.first();
          if (!currentLoja) {
            console.log("Nenhuma loja encontrada. Solicitando cria√ß√£o.");
            const nomeLoja = prompt("üì¢ Bem-vindo! Digite um nome para sua nova loja:");
            if (!nomeLoja || nomeLoja.trim() === "") {
                alert("‚ùå Nome da loja inv√°lido.");
                document.getElementById('nomeLoja').textContent = "Crie uma loja!";
                document.getElementById('reputacaoLoja').textContent = ""; return;
            }
            console.log("Criando nova loja:", nomeLoja);
            currentLoja = new Loja();
            currentLoja.set("nome", nomeLoja.trim());
            currentLoja.set("dono", currentUser);
            currentLoja.set("produtos", []); // Inicializa array de produtos
            currentLoja.set("reputacao", 0);
            await currentLoja.save();
            console.log("Loja criada:", currentLoja.id);
            alert(`üéâ Loja "${nomeLoja}" criada!`);
          } else {
              console.log("Loja encontrada:", currentLoja.id, "Nome:", currentLoja.get("nome"));
              // Garante que o campo 'produtos' existe e √© um array
              if (!Array.isArray(currentLoja.get("produtos"))) {
                  console.warn("Campo 'produtos' n√£o √© um array. Inicializando.");
                  currentLoja.set("produtos", []);
                  await currentLoja.save(); // Salva a corre√ß√£o
              }
          }
          document.getElementById('nomeLoja').textContent = currentLoja.get("nome");
          document.getElementById('reputacaoLoja').textContent = "Reputa√ß√£o: " + currentLoja.get("reputacao");
      } catch (error) {
          console.error("Erro ao verificar/criar loja:", error);
          alert("Erro ao carregar/criar sua loja: " + error.message);
      }
    };

    // Carrega os produtos BASEADO NA ORDEM DO ARRAY 'produtos' da loja
    const loadProducts = async () => {
       if (!currentLoja || isLoadingProducts) {
           console.warn("Carregamento de produtos pulado (sem loja ou j√° em andamento).");
           return;
       }
       isLoadingProducts = true; // Define a flag
       console.log("Iniciando carregamento de produtos...");
       setTableLoading(true); // Mostra feedback de carregamento na tabela

       const productIds = currentLoja.get("produtos") || [];

       if (productIds.length === 0) {
          console.log("Nenhum ID de produto na loja.");
          updateTable([]); // Mostra tabela vazia
          isLoadingProducts = false; // Reseta a flag
          setTableLoading(false);
          return;
       }

       console.log("Carregando produtos com IDs (na ordem do array):", productIds);

       const query = new Parse.Query(Produto);
       query.containedIn("objectId", productIds);
       // N√ÉO ordene aqui (query.ascending/descending)
       // A ordem vir√° do array productIds

       try {
         const results = await query.find();
         console.log("Produtos encontrados:", results.length);

         // Reordena os resultados para GARANTIR a ordem do array 'productIds'
         const orderedResults = productIds.map(id => results.find(p => p.id === id)).filter(p => p); // Encontra cada produto na ordem e filtra nulos

         if (orderedResults.length !== results.length) {
             console.warn("Alguns produtos do array n√£o foram encontrados na busca.");
             // Poderia adicionar l√≥gica para limpar IDs √≥rf√£os do array aqui
         }

         console.log("Produtos reordenados conforme array:", orderedResults.map(p => p.id));
         updateTable(orderedResults); // Atualiza a tabela com os produtos na ordem correta

       } catch (error) {
         console.error("Erro ao carregar produtos:", error);
         alert("Erro ao carregar produtos da loja: " + error.message);
         document.querySelector('#productsTable tbody').innerHTML = `<tr><td colspan='5'>Erro ao carregar produtos: ${error.message}</td></tr>`; // Colspan 5 agora
       } finally {
           isLoadingProducts = false; // Reseta a flag
           setTableLoading(false); // Remove feedback de carregamento
       }
    };

    // Atualiza a tabela HTML com a lista de produtos (na ordem recebida)
    const updateTable = (produtos) => {
      const tbody = document.querySelector('#productsTable tbody');
      tbody.innerHTML = ""; // Limpa tabela

      // Pega a ordem atual dos IDs diretamente da loja para refer√™ncia dos bot√µes
      const currentProductIds = currentLoja.get("produtos") || [];

      if (!produtos || produtos.length === 0) {
          tbody.innerHTML = "<tr><td colspan='5' style='text-align:center; padding: 20px;'>üõí Sua loja ainda n√£o tem produtos.</td></tr>"; // Colspan 5
          return;
      }

      produtos.forEach((produto, index) => { // Usa o √≠ndice da lista ordenada recebida
        const tr = document.createElement('tr');
        tr.dataset.productId = produto.id;

        // Imagens
        const imagens = produto.get("imagens") || [];
        const imagensHtml = imagens.length > 0
            ? imagens.map(url => `<img src="${url}" class="product-image" alt="Imagem" onerror="this.src='placeholder.png';">`).join('')
            : '<span>Sem imagem</span>';

        // Bot√µes de Ordem
        // O √≠ndice aqui √© o da lista 'produtos' recebida, que deve espelhar currentProductIds
        const isFirst = index === 0;
        const isLast = index === produtos.length - 1;
        const orderButtonsHtml = `
          <div class="order-container">
            <button class="btn-order btn-move-up" onclick="moveProduct('${produto.id}', 'up')" ${isFirst ? 'disabled' : ''}>‚ñ≤</button>
            <button class="btn-order btn-move-down" onclick="moveProduct('${produto.id}', 'down')" ${isLast ? 'disabled' : ''}>‚ñº</button>
          </div>
        `;

        // Bot√µes de A√ß√µes
        const actionButtonsHtml = `
          <div class="actions-container">
            <button class="btn btn-edit" onclick="editProduct('${produto.id}')">‚úèÔ∏è Editar</button>
            <button class="btn btn-delete" onclick="deleteProduct('${produto.id}')">üóëÔ∏è Excluir</button>
          </div>
        `;

        tr.innerHTML = `
          <td class="image-cell"><div class="image-container">${imagensHtml}</div></td>
          <td class="text-cell">${produto.get("nome") || 'Sem nome'}</td>
          <td class="text-cell">R$ ${(produto.get("preco") || 0).toFixed(2)}</td>
          <td class="order-cell">${orderButtonsHtml}</td> <td class="actions-cell">${actionButtonsHtml}</td>
        `;
        tbody.appendChild(tr);
      });

      enableDragToScroll(); // Reativa drag-scroll para imagens
    };

    // Fun√ß√£o para MOVER um produto para cima ou para baixo na ordem
    window.moveProduct = async (productId, direction) => {
        if (!currentLoja || isLoadingProducts) return; // Impede a√ß√£o se n√£o houver loja ou estiver carregando

        console.log(`Tentando mover produto ${productId} para ${direction}`);
        setOrderButtonsLoading(true); // Desabilita bot√µes de ordem durante a opera√ß√£o

        let productIds = currentLoja.get("produtos") || [];
        const currentIndex = productIds.indexOf(productId);

        if (currentIndex === -1) {
            console.error("ID do produto n√£o encontrado no array da loja.");
            setOrderButtonsLoading(false);
            return;
        }

        let newIndex;
        if (direction === 'up' && currentIndex > 0) {
            newIndex = currentIndex - 1;
        } else if (direction === 'down' && currentIndex < productIds.length - 1) {
            newIndex = currentIndex + 1;
        } else {
            console.log("Movimento inv√°lido (j√° no topo ou na base).");
            setOrderButtonsLoading(false);
            return; // Movimento inv√°lido
        }

        // Cria novo array com a ordem trocada
        const newProductIds = [...productIds]; // Copia o array
        [newProductIds[currentIndex], newProductIds[newIndex]] = [newProductIds[newIndex], newProductIds[currentIndex]]; // Troca os elementos

        console.log("Nova ordem de IDs:", newProductIds);

        // Atualiza a loja no Parse
        currentLoja.set("produtos", newProductIds);
        try {
            await currentLoja.save();
            console.log("Ordem salva no Parse.");
            // Recarrega a lista para refletir a nova ordem salva
            await loadProducts();
        } catch (error) {
            console.error("Erro ao salvar nova ordem:", error);
            alert("Erro ao salvar a nova ordem: " + error.message);
            // Poderia tentar reverter a mudan√ßa localmente, mas recarregar √© mais seguro
            await loadProducts(); // Recarrega mesmo em caso de erro para garantir consist√™ncia visual
        } finally {
             // Bot√µes ser√£o reabilitados pelo loadProducts que chama setTableLoading(false) -> setOrderButtonsLoading(false)
             // setOrderButtonsLoading(false); // Reabilita bot√µes (feito pelo finally do loadProducts)
        }
    };


    // Fun√ß√£o para deletar um produto
    window.deleteProduct = async (id) => {
      if (!confirm("‚ùì Tem certeza que deseja excluir este produto?")) return;
      if (!currentLoja) { alert("‚ùå Erro: Loja n√£o encontrada."); return; }
      console.log("Tentando excluir produto:", id);
      setTableLoading(true); // Desabilita bot√µes durante a exclus√£o

      try {
        // Remove ID do array na Loja
        currentLoja.remove("produtos", id);
        await currentLoja.save();
        console.log("ID removido do array da loja.");

        // Deleta o objeto Produto
        const query = new Parse.Query(Produto);
        const produto = await query.get(id);
        await produto.destroy();
        console.log("Objeto produto destru√≠do:", id);

        // Remove linha da tabela (ou recarrega)
        // const rowToRemove = document.querySelector(`tr[data-product-id="${id}"]`);
        // if (rowToRemove) rowToRemove.remove();
        alert("‚úÖ Produto exclu√≠do!");
        await loadProducts(); // Recarrega para atualizar a tabela e ordem

      } catch (error) {
        console.error("Erro na exclus√£o:", error);
        alert("‚ùå Erro ao excluir: " + error.message);
        setTableLoading(false); // Reabilita bot√µes se houve erro
      }
       // finally n√£o √© necess√°rio aqui pois loadProducts j√° chama setTableLoading(false)
    };

    // Fun√ß√£o para redirecionar para a p√°gina de edi√ß√£o
    window.editProduct = (id) => {
        console.log("Redirecionando para editar:", id);
        window.location.href = `editar.html?id=${id}`;
    }

    // --- Event Listeners ---

    // Listener para o formul√°rio de adicionar produto
    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentLoja) { alert("‚ö†Ô∏è Crie uma loja primeiro!"); return; }

      const nomeInput = document.getElementById('productName');
      const precoInput = document.getElementById('productPrice');
      const imagemInput = document.getElementById('productImage');
      const submitButton = e.target.querySelector('button[type="submit"]');

      const productData = {
        nome: nomeInput.value.trim(),
        preco: parseFloat(precoInput.value),
        imagemFile: imagemInput.files[0]
      };

      if (!productData.nome || isNaN(productData.preco) || productData.preco <= 0 || !productData.imagemFile) {
          alert("‚ùå Preencha todos os campos corretamente (nome, pre√ßo > 0, imagem)."); return;
      }

      console.log("Adicionando produto:", productData.nome);
      submitButton.disabled = true; submitButton.textContent = 'Enviando...';

      try {
        // Upload imagem
        console.log("Fazendo upload...");
        const parseFile = new Parse.File(productData.imagemFile.name, productData.imagemFile);
        await parseFile.save();
        const imageUrl = parseFile.url();
        console.log("Upload conclu√≠do:", imageUrl);

        // Cria Produto
        const novoProduto = new Produto();
        novoProduto.set("nome", productData.nome);
        novoProduto.set("preco", productData.preco);
        novoProduto.set("imagens", [imageUrl]);
        novoProduto.set("dono", Parse.User.current());
        await novoProduto.save();
        console.log("Produto salvo:", novoProduto.id);

        // Adiciona ID ao IN√çCIO do array da Loja
        currentLoja.addUnique("produtos", novoProduto.id); // Adiciona normalmente
        // Pega o array atual, remove o ID e adiciona no in√≠cio
        let currentIds = currentLoja.get("produtos") || [];
        currentIds = currentIds.filter(id => id !== novoProduto.id); // Remove se j√° existir (caso addUnique falhe)
        currentIds.unshift(novoProduto.id); // Adiciona no in√≠cio
        currentLoja.set("produtos", currentIds); // Define o novo array ordenado

        await currentLoja.save();
        console.log("ID adicionado ao in√≠cio do array da loja.");

        // Limpa form e recarrega
        document.getElementById('productForm').reset();
        document.getElementById('imagePreview').style.display = 'none';
        document.getElementById('imagePreview').src = '';
        alert(`‚úÖ Produto "${productData.nome}" adicionado!`);
        await loadProducts(); // Recarrega para mostrar na nova ordem

      } catch (error) {
        console.error("Erro ao adicionar:", error);
        alert("‚ùå Erro ao adicionar: " + error.message);
      } finally {
          submitButton.disabled = false; submitButton.innerHTML = '‚ûï Adicionar Produto';
      }
    });

    // Listener para o bot√£o de logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      console.log("Iniciando logout...");
      try {
        await auth.signOut(); console.log("Logout Firebase ok.");
        await Parse.User.logOut(); console.log("Logout Parse ok.");
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Erro no logout:', error);
        alert('‚ùå Erro ao sair: ' + error.message);
      }
    });

    // Listener para preview da imagem
    document.getElementById('productImage').addEventListener('change', function(event) {
      const file = event.target.files[0];
      const preview = document.getElementById('imagePreview');
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
          preview.style.display = 'none'; preview.src = '';
      }
    });

    // --- Fun√ß√µes Auxiliares ---

    // Atualiza cabe√ßalho com dados do usu√°rio
    function updateHeader(user) {
      if (!user) return;
      document.getElementById('profilePhoto').src = user.photoURL || 'avatar-padrao.jpeg';
      document.getElementById('userName').textContent = user.displayName || user.email || 'Usu√°rio';
      document.getElementById('userEmail').textContent = user.email || '';
    }

    // Habilita/desabilita bot√µes da tabela durante carregamento/a√ß√µes
    function setTableLoading(isLoading) {
        const buttons = document.querySelectorAll('#productsTable .btn, #productsTable .btn-order');
        buttons.forEach(btn => btn.disabled = isLoading);
        // Poderia adicionar um spinner/overlay na tabela tamb√©m
        console.log(`Table buttons ${isLoading ? 'disabled' : 'enabled'}`);
        // Garante que os bot√µes de ordem sejam especificamente controlados
        setOrderButtonsLoading(isLoading);
    }

    // Habilita/desabilita APENAS os bot√µes de ordem
    function setOrderButtonsLoading(isLoading) {
        const orderButtons = document.querySelectorAll('#productsTable .btn-order');
        orderButtons.forEach(btn => {
            // Mant√©m desabilitado se j√° estiver (ex: primeiro/√∫ltimo item)
            if (!isLoading && (btn.classList.contains('btn-move-up') || btn.classList.contains('btn-move-down'))) {
                 // Reavalia se deve estar desabilitado com base na nova ordem (feito em updateTable)
            } else {
                btn.disabled = isLoading;
            }
        });
         console.log(`Order buttons ${isLoading ? 'disabled' : 'enabled'}`);
    }


    // Habilita drag-scroll para containers de imagem
    function enableDragToScroll() {
        document.querySelectorAll('.image-container').forEach(enableDragToScrollForElement);
    }
    function enableDragToScrollForElement(container) {
        if (!container) return;
        let isDown = false, startX, scrollLeft;
        container.addEventListener('mousedown', (e) => { isDown = true; container.style.cursor = 'grabbing'; startX = e.pageX - container.offsetLeft; scrollLeft = container.scrollLeft; });
        container.addEventListener('mouseleave', () => { if (!isDown) return; isDown = false; container.style.cursor = 'grab'; });
        container.addEventListener('mouseup', () => { if (!isDown) return; isDown = false; container.style.cursor = 'grab'; });
        container.addEventListener('mousemove', (e) => { if (!isDown) return; e.preventDefault(); const x = e.pageX - container.offsetLeft; const walk = (x - startX) * 1.5; container.scrollLeft = scrollLeft - walk; });
    }
    enableDragToScroll(); // Inicializa

  </script>
</body>
</html>
