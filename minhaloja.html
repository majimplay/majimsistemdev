<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Minha Loja</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
    }

    .profile-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
    }

    .profile-photo {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #007BFF;
      margin-right: 1rem;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .admin-panel {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      margin: 2rem 0;
    }

    th, td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #ddd;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    th { background: #f8f9fa; }
    tr:hover { background: #f9f9f9; }

   /* Definindo larguras proporcionais */
.image-cell { width: 70%; }
.text-cell  { width: 8%; }
.setas-cell { width: 4%;  }
.actions-cell { width: 8%; }

    input[type="text"], input[type="number"] {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 150px;
    }
     .setas-cell button {
      margin: 2px;
      padding: 4px 8px;
      }
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: 0.3s;
    }

    .btn-edit { background: #4CAF50; color: white; }
    .btn-delete { background: #f44336; color: white; }
    .btn:hover { opacity: 0.9; }

    .image-upload input[type="file"] { display: none; }
    .upload-label {
      background: #2196F3;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    #imagePreview {
      max-height: 100px;
      margin: 10px 0;
      border-radius: 4px;
      display: block !important;
    }

    .product-image {
      height: 50px;
      width: 50px;
      min-width: 50px;
      border-radius: 4px;
      object-fit: cover;
      border: 1px solid #ddd;
    }

 .image-container {
  display: flex;
  flex-direction: row;
  gap: 8px;
  overflow-x: auto;      /* rolagem horizontal */
  overflow-y: hidden;    /* esconde rolagem vertical */
  padding: 4px 0;
  white-space: nowrap;    /* garante uma linha única */
  cursor: grab;          /* cursor de arraste */
}
.btn-up { 
  background: #ffc107; 
  color: black; 
  margin: 2px;
  padding: 4px 8px;
}
.btn-down { 
  background: #17a2b8; 
  color: white; 
  margin: 2px;
  padding: 4px 8px;
}
	 
  .actions-container {
  display: flex;
  flex-direction: column; /* empilha verticalmente */
  gap: 8px;

}
	   .setas-cell {
  display: flex;
  flex-direction: column; /* empilha verticalmente */
  gap: 8px;
  align-items: flex-start; /* alinha à esquerda */
}
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
</head>
<body>
  <div class="profile-header">
    <div style="display: flex; align-items: center;">
      <img id="profilePhoto" class="profile-photo" src="avatar-padrao.jpeg">
      <div class="profile-info">
        <h1 id="userName">Carregando...</h1>
        <p id="userEmail"></p>
      </div>
    </div>
    <button id="logoutBtn" class="btn btn-secondary">🚪 Sair</button>
  </div>

  <div class="store-header">
    <h1 id="nomeLoja">Carregando nome da loja...</h1>
	    <p id="reputacaoLoja">Reputação: 0</p>
  </div>

  <div class="admin-panel">
    <h2>Gerenciamento de Produtos</h2>
    
    <form id="productForm">
      <div style="display: flex; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap;">
        <input type="text" id="productName" placeholder="Nome do Produto" required>
        <input type="number" id="productPrice" step="0.01" placeholder="Preço" required>
        <div class="image-upload">
          <img id="imagePreview" src="" alt="Miniatura">
          <label class="upload-label">
            📷 Escolher Imagem
            <input type="file" id="productImage" accept="image/*" required>
          </label>
        </div>
        <button type="submit" class="btn btn-edit">➕ Adicionar</button>
      </div>
    </form>

    <table id="productsTable">
    <thead>
  <tr>
    <th class="image-cell">Imagem</th>
    <th class="text-cell">Produto</th>
    <th class="text-cell">Preço</th>
    <th class="setas-cell">Posição</th>
    <th class="actions-cell">Ações</th>
  </tr>
</thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    // Configurações Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDlUQbbTP29VqBVmzOGHhfc67R1DTRPwxg",
      authDomain: "gitautenticatio.firebaseapp.com",
      projectId: "gitautenticatio",
      storageBucket: "gitautenticatio.appspot.com",
      messagingSenderId: "21514234895",
      appId: "1:21514234895:web:d34dc4c44baf586d2cc77a"
    };

    // Configurações Parse
    Parse.initialize("TYP8SUA8qxmHIRs1mHbiFalgRxCEf51sOiSWmNEY", "n4Gfko9sO7jiAUnWX5U5GGCDQ5QtPWX97K4TzB8I");
    Parse.serverURL = "https://parseapi.back4app.com/";
    const Produto = Parse.Object.extend("Produto");
    const Loja = Parse.Object.extend("Loja");

    // Inicialização Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    let currentLoja = null;

   // Monitorar estado de autenticação
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        try {
          // Sincronizar com Parse usando credenciais do Firebase
          if (!Parse.User.current()) {
            await Parse.User.logIn(user.uid, user.uid);
          }
          await checkOrCreateLoja();
          updateHeader(user);
          loadProducts();
        } catch (error) {
          alert("Erro de acesso: " + error.message);
          window.location.href = 'index.html';
        }
      } else {
        window.location.href = 'index.html';
      }
    });

  // Verificar/Criar Loja
    const checkOrCreateLoja = async () => {
      const query = new Parse.Query(Loja);
      query.equalTo("dono", Parse.User.current());
      
      currentLoja = await query.first();
      
      if (!currentLoja) {
        const nomeLoja = prompt("📢 Bem-vindo ao criador de lojas!\nDigite o nome da sua nova loja:");
        if (!nomeLoja) return;

        currentLoja = new Loja();
        currentLoja.set("nome", nomeLoja);
        currentLoja.set("dono", Parse.User.current());
        currentLoja.set("produtos", []);
        currentLoja.set("reputacao", 0);
        await currentLoja.save();
      }
      
      document.getElementById('nomeLoja').textContent = currentLoja.get("nome");
      document.getElementById('reputacaoLoja').textContent = "Reputação: " + currentLoja.get("reputacao");
    };

    // Carregar Produtos
 const loadProducts = async () => {
  const productIds = currentLoja.get("produtos");
  if(productIds.length === 0) return;

  const query = new Parse.Query(Produto);
  query.containedIn("objectId", productIds);
  
  try {
    const results = await query.find();
    // Ordena os resultados conforme o array de IDs
    results.sort((a, b) => productIds.indexOf(a.id) - productIds.indexOf(b.id));
    updateTable(results);
  } catch(error) {
    alert("Erro ao carregar produtos: " + error.message);
  }
};
const updateTable = (produtos) => {
  const tbody = document.querySelector('#productsTable tbody');
  tbody.innerHTML = "";
  
  produtos.forEach(produto => {
    const tr = document.createElement('tr');
    tr.innerHTML = `

      <td class="image-cell">
        <div class="image-container">
          ${produto.get("imagens").map(url => 
            `<img src="${url}" class="product-image">`
          ).join('')}
        </div>
      </td>
      <td class="text-cell">${produto.get("nome")}</td>
      <td class="text-cell">R$ ${produto.get("preco").toFixed(2)}</td>
     
      <!-- Coluna das setas -->
      <td class="setas-cell">
        <button class="btn-up"   onclick="moveProductUp('${produto.id}')">↑</button>
        <button class="btn-down" onclick="moveProductDown('${produto.id}')">↓</button>
      </td>

      <!-- Coluna de editar/excluir -->
      <td class="actions-cell">
        <button class="btn btn-edit"   onclick="editProduct('${produto.id}')">Editar</button>
        <button class="btn btn-delete" onclick="deleteProduct('${produto.id}')">Excluir</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
};

    // Deletar Produto
    window.deleteProduct = async (id) => {
      if (!confirm("Confirmar exclusão?")) return;
      
      try {
        // Remover da lista da loja
        currentLoja.remove("produtos", id);
        await currentLoja.save();
        
        // Deletar objeto do produto
        const query = new Parse.Query(Produto);
        const produto = await query.get(id);
        await produto.destroy();
        
        loadProducts();
      } catch (error) {
        alert("Erro na exclusão: " + error.message);
      }
    };


window.moveProductUp = async (productId) => {
  const produtos = currentLoja.get("produtos");
  const index = produtos.indexOf(productId);
  
  if(index > 0) {
    // Swap positions
    [produtos[index], produtos[index - 1]] = [produtos[index - 1], produtos[index]];
    currentLoja.set("produtos", produtos);
    await currentLoja.save();
    loadProducts();
  }
};

window.moveProductDown = async (productId) => {
  const produtos = currentLoja.get("produtos");
  const index = produtos.indexOf(productId);
  
  if(index < produtos.length - 1 && index !== -1) {
    // Swap positions
    [produtos[index], produtos[index + 1]] = [produtos[index + 1], produtos[index]];
    currentLoja.set("produtos", produtos);
    await currentLoja.save();
    loadProducts();
  }
};
	  
async function editProduct(id) {
	window.location.href = `editar.html?id=${id}`;
	}
    // Evento de Formulário
    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();
       if (!currentLoja) {
       alert("❌ Você precisa criar uma loja antes de adicionar produtos!");
       return;
       }
      const productData = {
        nome: document.getElementById('productName').value,
        preco: parseFloat(document.getElementById('productPrice').value),
        imagem: document.getElementById('productImage').files[0]
      };

      try {
        // Upload da imagem
        const parseFile = new Parse.File(productData.imagem.name, productData.imagem);
        await parseFile.save();
        const imageUrl = parseFile.url();
        // Criar novo produto
        const novoProduto = new Produto();
        novoProduto.set("nome", productData.nome);
        novoProduto.set("preco", productData.preco);
        novoProduto.set("imagens", [imageUrl]);
        novoProduto.set("loja", currentLoja);
        await novoProduto.save();

        // Atualizar loja
        currentLoja.add("produtos", novoProduto.id);
        await currentLoja.save();

        // Resetar formulário
        document.getElementById('productForm').reset();
        document.getElementById('imagePreview').style.display = 'none';
        loadProducts();
      } catch (error) {
        alert("Erro ao adicionar produto: " + error.message);
      }
    });

    // Monitorar Estado de Autenticação
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        await syncAuth(user);
        updateHeader(user);
      } else {
        window.location.href = 'index.html';
      }
    });

    // Atualizar Cabeçalho
    function updateHeader(user) {
      document.getElementById('profilePhoto').src = user.photoURL || 'avatar-padrao.jpeg';
      document.getElementById('userName').textContent = user.displayName || 'Usuário';
      document.getElementById('userEmail').textContent = user.email;
    }

  // Logout atualizado
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await auth.signOut();
        await Parse.User.logOut();
        window.location.href = 'index.html';
      } catch (error) {
        alert('Erro no logout: ' + error.message);
      }
    });

    // Pré-visualização de Imagem
    document.getElementById('productImage').addEventListener('change', function(event) {
      const file = event.target.files[0];
      const preview = document.getElementById('imagePreview');
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    });
	// drag-to-scroll dragging active
  const containers = document.querySelectorAll('.image-container');
  containers.forEach(container => {
    let isDown = false, startX, scrollLeft;

    container.addEventListener('mousedown', e => {
      isDown = true;
      container.classList.add('dragging'); // opcional para styling
      startX = e.pageX - container.offsetLeft;
      scrollLeft = container.scrollLeft;
    });
    container.addEventListener('mouseleave', () => {
      isDown = false;
      container.classList.remove('dragging');
    });
    container.addEventListener('mouseup', () => {
      isDown = false;
      container.classList.remove('dragging');
    });
    container.addEventListener('mousemove', e => {
      if (!isDown) return;
      e.preventDefault();
      const x = e.pageX - container.offsetLeft;
      const walk = (x - startX) * 1; // 1 = sensibilidade
      container.scrollLeft = scrollLeft - walk;
    });
  });
  </script>
</body>
</html>
