<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>🛒 Base Sincronização - Multi-Loja com Recompensas (Cloud)</title>
    <style>
        /* Estilos CSS (mantidos e adicionados) */
        body {
            font-family: 'Arial', sans-serif;
            margin: 2rem;
            padding: 0;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #eee;
            flex-wrap: wrap;
        }
        .profile-left {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        .profile-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #007BFF;
            margin-right: 1rem;
        }
        .profile-info h1 { margin: 0; color: #333; font-size: 1.2em; }
        .profile-info p { color: #666; margin: 0.2rem 0; font-size: 0.9em; }
        .profile-money {
            margin-left: 1.5rem;
            font-size: 1.1em;
            font-weight: bold;
            color: #28a745;
        }
        .user-details, .daily-reward {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .user-details h3, .daily-reward h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.1em;
            color: #0056b3;
            border-bottom: 1px solid #ddd;
            padding-bottom: 0.5rem;
        }
        .user-details p {
            margin: 0.4rem 0;
            font-size: 0.95em;
        }
        .user-details span.label {
            font-weight: bold;
            color: #555;
            display: inline-block;
            min-width: 100px;
        }
        .user-details span.value {
            color: #333;
        }
        .user-details span.status-loja {
            font-style: italic;
        }
        .btn {
            padding: 0.7rem 1.4rem;
            border: none; border-radius: 6px; cursor: pointer;
            font-weight: 600; transition: all 0.3s ease; white-space: nowrap;
            font-size: 0.95em;
            margin-left: 10px;
        }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn:disabled {
            background-color: #cccccc;
            color: #666666;
            cursor: not-allowed;
        }
        .emoji { margin-right: 8px; }

        /* Daily Reward Styles */
        .reward-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        .reward-table th, .reward-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            font-size: 0.9em;
        }
        .reward-table th {
            background-color: #e9ecef;
            color: #495057;
        }
        .reward-status {
            margin-top: 0.5rem;
            font-style: italic;
            color: #666;
        }
        .loading-spinner {
            display: inline-block;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin-left: 5px;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .streak-photo {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
            margin-left: 6px;
            vertical-align: middle;
        }
        .reward-table .claimed {
            background-color: #d4edda;
            color: #155724;
        }

        @media (max-width: 600px) {
            .profile-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .profile-money {
                margin-left: 0;
                margin-top: 0.5rem;
            }
            .profile-header > button {
                margin-top: 1rem;
                align-self: flex-start;
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
</head>
<body>

    <div class="container">
        <div class="profile-header">
            <div class="profile-left">
                <img id="profilePhoto" class="profile-photo" src="https://placehold.co/80x80/eee/ccc?text=User" alt="Foto do Perfil">
                <div class="profile-info">
                    <h1 id="userName"><span class="emoji">👤</span> Carregando...</h1>
                    <p id="userEmail"></p>
                </div>
                <div id="userMoney" class="profile-money">
                    <span class="emoji">💳</span> Grana: <span id="moneyValue">💸💰 --</span>
                </div>
            </div>
            <button id="logoutBtn" class="btn btn-secondary"><span class="emoji">🚪</span> Sair</button>
        </div>

        <div class="user-details">
            <h3><span class="emoji">🆔</span> Detalhes da Conta</h3>
            <p><span class="label">Firebase User:</span> <span id="firebaseUserInfo" class="value">Aguardando login...</span></p>
            <p><span class="label">Parse User:</span> <span id="parseUserInfo" class="value">Aguardando login...</span></p>
            <p><span class="label">Status Loja:</span> <span id="lojaStatus" class="value status-loja">Verificando...</span></p>
        </div>

        <div class="daily-reward">
            <h3><span class="emoji">🎁</span> Recompensa Diária</h3>
            <p>Faça login todos os dias para ganhar recompensas crescentes!</p>
            <table class="reward-table">
                <thead>
                    <tr>
                        <th>Dia Consecutivo</th>
                        <th>Recompensa (Grana)</th>
                    </tr>
                </thead>
                <tbody id="rewardTableBody">
                    <tr><td>1</td><td>10</td></tr>
                    <tr><td>2</td><td>11</td></tr>
                    <tr><td>3</td><td>11</td></tr>
                    <tr><td>4</td><td>12</td></tr>
                    <tr><td>5</td><td>15</td></tr>
                    <tr><td>6</td><td>16</td></tr>
                    <tr><td>7</td><td>20</td></tr>
                </tbody>
            </table>
            <button id="claimRewardBtn" class="btn btn-primary" disabled><span class="emoji">🖐️</span> Resgatar Recompensa</button>
            <span id="claimSpinner" class="loading-spinner" style="display: none;"></span>
            <p id="rewardStatus" class="reward-status">Verificando status da recompensa...</p>
        </div>

    </div>

    <script>
       // --- Configurações ---
        const firebaseConfig = {
            apiKey: "AIzaSyDlUQbbTP29VqBVmzOGHhfc67R1DTRPwxg",
            authDomain: "gitautenticatio.firebaseapp.com",
            databaseURL: "https://gitautenticatio-default-rtdb.firebaseio.com",
            projectId: "gitautenticatio",
            storageBucket: "gitautenticatio.appspot.com",
            messagingSenderId: "21514234895",
            appId: "1:21514234895:web:d34dc4c44baf586d2cc77a"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        Parse.initialize("TYP8SUA8qxmHIRs1mHbiFalgRxCEf51sOiSWmNEY", "n4Gfko9sO7jiAUnWX5U5GGCDQ5QtPWX97K4TzB8I");
        Parse.serverURL = "https://parseapi.back4app.com/";

        const profilePhotoElem = document.getElementById('profilePhoto');
        const userNameElem = document.getElementById('userName');
        const userEmailElem = document.getElementById('userEmail');
        const moneyValueElem = document.getElementById('moneyValue');
        const firebaseUserInfoElem = document.getElementById('firebaseUserInfo');
        const parseUserInfoElem = document.getElementById('parseUserInfo');
        const lojaStatusElem = document.getElementById('lojaStatus');
        const logoutButton = document.getElementById('logoutBtn');
        const claimRewardBtn = document.getElementById('claimRewardBtn');
        const rewardStatusElem = document.getElementById('rewardStatus');
        const claimSpinner = document.getElementById('claimSpinner');

        let firebaseUser = null;
        let currentParseUser = null;
        const dailyRewards = [0, 10, 11, 11, 12, 15, 16, 20];

        auth.onAuthStateChanged(async user => {
            if (user) {
                firebaseUser = user;
                atualizarCabecalhoUI(firebaseUser);
                atualizarDetalhesFirebaseUI(firebaseUser);
                currentParseUser = Parse.User.current();
                if (currentParseUser) {
                    try {
                        await currentParseUser.fetch();
                        atualizarDetalhesParseUI(currentParseUser);
                        await verificarLojaParse(currentParseUser);
                        atualizarGranaUI(currentParseUser);
                        await verificarStatusRecompensaInicial(currentParseUser);
+                       markClaimedDays();
+                       highlightCurrentStreak();
                    } catch (error) {
                        parseUserInfoElem.textContent = 'Erro ao buscar dados do Parse.';
                        moneyValueElem.textContent = '💸💰 Erro';
                        rewardStatusElem.textContent = 'Erro ao verificar status.';
                        claimRewardBtn.disabled = true;
                    }
                } else {
                    parseUserInfoElem.textContent = 'Erro: Usuário Parse não sincronizado.';
                    lojaStatusElem.textContent = 'Não verificado (Erro Parse)';
                    moneyValueElem.textContent = '💸💰 --';
                    rewardStatusElem.textContent = 'Faça login com Parse para ver recompensas.';
                    claimRewardBtn.disabled = true;
                }
            } else {
                limparUI();
            }
        });

        logoutButton.addEventListener('click', async () => {
            await auth.signOut();
            await Parse.User.logOut();
            limparUI();
        });

        claimRewardBtn.addEventListener('click', async () => {
            if (!currentParseUser) return;
            claimRewardBtn.disabled = true;
            claimSpinner.style.display = 'inline-block';
            rewardStatusElem.textContent = 'Processando resgate...';
            try {
                const result = await Parse.Cloud.run("claimDailyReward");
                claimSpinner.style.display = 'none';
                if (result && result.success) {
                    moneyValueElem.textContent = `💸💰 ${result.newGrana}`;
                    rewardStatusElem.textContent = `✅ ${result.message} Volte amanhã.`;
                } else {
                    rewardStatusElem.textContent = `❌ ${(result && result.message) ? result.message : 'Erro desconhecido.'}`;
                    await verificarStatusRecompensaInicial(currentParseUser);
                }
            } catch (error) {
                claimSpinner.style.display = 'none';
                rewardStatusElem.textContent = `⚠️ Erro de comunicação: ${error.message}`;
                await verificarStatusRecompensaInicial(currentParseUser);
            }
        });

        function highlightCurrentStreak() {
            if (!currentParseUser) return;
            const streak = currentParseUser.get("loginStreak") || 0;
            if (streak < 1 || streak > 7) return;
            const photoSrc = profilePhotoElem.src;
            const tbody = document.getElementById("rewardTableBody");
            const rows = tbody.querySelectorAll("tr");
            const targetRow = rows[streak - 1];
            const rewardCell = targetRow.querySelector("td:nth-child(2)");
            const img = document.createElement("img");
            img.src = photoSrc;
            img.alt = `Dia ${streak}`;
            img.className = "streak-photo";
            rewardCell.appendChild(img);
        }

    function markClaimedDays() {
            if (!currentParseUser) return;
            const streak = currentParseUser.get("loginStreak") || 0;
            const last = currentParseUser.get("lastClaimed");
            const now = new Date();
            const today = new Date(now.getFullYear(),now.getMonth(),now.getDate());
            let claimedToday = false;
            if (last instanceof Date) {
                const ld = new Date(last.getFullYear(),last.getMonth(),last.getDate());
                claimedToday = ld.getTime() === today.getTime();
            }
            const max = claimedToday ? streak : streak - 1;
            const rows = document.querySelectorAll("#rewardTableBody tr");
            rows.forEach((row,i) => {
                const day = i+1;
                if (day <= max) {
                    row.classList.add("claimed");
                    const cell = row.querySelector("td:nth-child(2)");
                    cell.textContent = `${dailyRewards[day]} ✅ já resgatou`;
                }
            });
        }

        function atualizarCabecalhoUI(fbUser) {
            if (!fbUser) return;
            profilePhotoElem.src = fbUser.photoURL || "https://placehold.co/80x80/eee/ccc?text=User";
            userNameElem.innerHTML = `<span class="emoji">👤</span> ${fbUser.displayName || fbUser.email}`;
            userEmailElem.innerHTML = `<span class="emoji">📧</span> ${fbUser.email}`;
        }

        function atualizarDetalhesFirebaseUI(fbUser) {
            firebaseUserInfoElem.textContent = `Nome: ${fbUser.displayName || '(não definido)'}, ID: ${fbUser.uid}`;
        }

        function atualizarDetalhesParseUI(pUser) {
            const parseName = pUser.get("username") || pUser.get("name") || '(não definido)';
            parseUserInfoElem.textContent = `Nome: ${parseName}, ID: ${pUser.id}`;
        }

        function atualizarGranaUI(pUser) {
            const grana = pUser.get("grana") || 0;
            moneyValueElem.textContent = `💸💰 ${grana}`;
        }

        function limparUI() {
            profilePhotoElem.src = "https://placehold.co/80x80/eee/ccc?text=User";
            userNameElem.innerHTML = '<span class="emoji">👤</span> Não conectado';
            userEmailElem.textContent = '';
            moneyValueElem.textContent = '💸💰 --';
            firebaseUserInfoElem.textContent = 'Desconectado';
            parseUserInfoElem.textContent = 'Desconectado';
            lojaStatusElem.textContent = 'Desconectado';
            rewardStatusElem.textContent = 'Desconectado';
            claimRewardBtn.disabled = true;
            claimSpinner.style.display = 'none';
        }

        async function verificarLojaParse(parseUser) {
            lojaStatusElem.textContent = 'Verificando loja...';
            const Loja = Parse.Object.extend("Loja");
            const query = new Parse.Query(Loja);
            query.equalTo("dono", parseUser);
            query.select("nome");
            try {
                const loja = await query.first();
                lojaStatusElem.textContent = loja ? `✅ Sim, possui loja: ${loja.get("nome")}` : '❌ Não possui loja registrada.';
            } catch {
                lojaStatusElem.textContent = '⚠️ Erro ao verificar loja.';
            }
        }

        async function verificarStatusRecompensaInicial(pUser) {
            claimRewardBtn.disabled = true;
            rewardStatusElem.textContent = 'Verificando status...';
            try {
                const { canClaim, nextStreak } = checkCanClaimClientSideForUI(pUser);
                if (canClaim) {
                    const rewardAmount = dailyRewards[nextStreak] || '??';
                    rewardStatusElem.textContent = `🎁 Pronto para resgatar a recompensa do Dia ${nextStreak} (${rewardAmount} grana)!`;
                    claimRewardBtn.disabled = false;
                } else {
                    const today = new Date();
                    const tomorrow = new Date(today);
                    tomorrow.setDate(today.getDate() + 1);
                    tomorrow.setHours(0,0,0,0);
                    const diff = tomorrow - today;
                    const hours = Math.floor(diff / 36e5);
                    const minutes = Math.floor((diff % 36e5) / 6e4);
                    rewardStatusElem.textContent = `✅ Recompensa de hoje já resgatada. Próxima em aprox. ${hours}h ${minutes}m.`;
                }
            } catch {
                rewardStatusElem.textContent = '⚠️ Erro ao verificar status da recompensa.';
            }
        }

        function checkCanClaimClientSideForUI(pUser) {
            const lastClaimedDate = pUser.get("lastClaimed");
            const currentStreak = pUser.get("loginStreak") || 0;
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            let canClaim = false;
            let nextStreak = 1;
            if (lastClaimedDate instanceof Date) {
                const lastDay = new Date(lastClaimedDate.getFullYear(), lastClaimedDate.getMonth(), lastClaimedDate.getDate());
                const yesterday = new Date(today);
                yesterday.setDate(today.getDate() - 1);
                if (lastDay < today) {
                    canClaim = true;
                    nextStreak = (lastDay.getTime() === yesterday.getTime()) ? ((currentStreak % 7) + 1) : 1;
                }
            } else {
                canClaim = true;
            }
            return { canClaim, nextStreak };
        }
    </script>
</body>
</html>
