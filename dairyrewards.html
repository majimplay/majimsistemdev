<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>üõí Base Sincroniza√ß√£o - Multi-Loja (Corrigido)</title>
    <style>
        /* Estilos CSS (mantidos do original) */
        body {
            font-family: 'Arial', sans-serif;
            margin: 2rem; /* Added margin for better visibility */
            padding: 0;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem; /* Reduced margin */
            padding-bottom: 1rem; /* Reduced padding */
            border-bottom: 2px solid #eee;
        }
        .profile-photo {
            width: 80px; /* Smaller photo */
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #007BFF;
            margin-right: 1rem;
        }
        .profile-info h1 { margin: 0; color: #333; font-size: 1.2em; } /* Smaller title */
        .profile-info p { color: #666; margin: 0.2rem 0; font-size: 0.9em; }
        .user-details {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .user-details h3 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-size: 1.1em;
            color: #0056b3;
        }
         .user-details p {
            margin: 0.3rem 0;
            font-size: 0.95em;
        }
         .user-details span.label {
            font-weight: bold;
            color: #555;
         }
          .user-details span.value {
            color: #333;
         }
         .user-details span.status-loja {
             font-style: italic;
         }
        .btn {
            padding: 0.6rem 1.2rem; /* Smaller button */
            border: none; border-radius: 6px; cursor: pointer;
            font-weight: 600; transition: all 0.3s ease; white-space: nowrap;
            font-size: 0.9em;
        }
        .btn-success { 
         background: #28a745; 
         color: white; 
         }
        
        .btn-secondary { background: #6c757d; color: white; }
        .emoji { margin-right: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script> <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
</head>
<body>

    <div class="container">
        <div class="profile-header">
            <div style="display: flex; align-items: center;">
                <img id="profilePhoto" class="profile-photo" src="https://placehold.co/80x80/eee/ccc?text=User" alt="Foto do Perfil">
                <div class="profile-info">
                    <h1 id="userName"><span class="emoji">üë§</span> Carregando...</h1>
                    <p id="userEmail"></p>
                </div>
            </div>
            <button id="logoutBtn" class="btn btn-secondary"><span class="emoji">üö™</span> Sair</button>
        </div>

        <div class="user-details">
            <h3><span class="emoji">üÜî</span> Detalhes da Conta</h3>
            <p><span class="label">Firebase User:</span> <span id="firebaseUserInfo" class="value">Aguardando login...</span></p>
            <p><span class="label">Parse User:</span> <span id="parseUserInfo" class="value">Aguardando login...</span></p>
            <p><span class="label">Status Loja:</span> <span id="lojaStatus" class="value status-loja">Verificando...</span></p>
            <h3><span class="emoji">üéÆ</span> Jogo de Recompensas</h3>
            <p><span class="label">Saldo:</span> <span id="userMoney" class="value">üí≥ 0</span></p>
            <p><span class="label">Sequ√™ncia:</span> <span id="dailyStreak" class="value">üî• 0 dias</span> 
            <button id="claimRewardBtn" class="btn btn-success" disabled><span class="emoji">üéÅ</span> Resgatar Recompensa</button>
            <p id="rewardMessage" style="margin-top: 0.5rem; color: #666; font-size: 0.9em;"></p>
            </div>

    </div>
    <script>
        // --- Configurations ---
        const firebaseConfig = {
            apiKey: "AIzaSyDlUQbbTP29VqBVmzOGHhfc67R1DTRPwxg", // Sua chave
            authDomain: "gitautenticatio.firebaseapp.com",
            databaseURL: "https://gitautenticatio-default-rtdb.firebaseio.com", // Necess√°rio se usar database()
            projectId: "gitautenticatio",
            storageBucket: "gitautenticatio.appspot.com",
            messagingSenderId: "21514234895",
            appId: "1:21514234895:web:d34dc4c44baf586d2cc77a"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database(); // Agora deve funcionar
        // Initialize Parse
        Parse.initialize("TYP8SUA8qxmHIRs1mHbiFalgRxCEf51sOiSWmNEY", "n4Gfko9sO7jiAUnWX5U5GGCDQ5QtPWX97K4TzB8I"); // Suas chaves
        Parse.serverURL = "https://parseapi.back4app.com/";

        // --- Elementos da UI ---
        const profilePhotoElem = document.getElementById('profilePhoto');
        const userNameElem = document.getElementById('userName');
        const userEmailElem = document.getElementById('userEmail');
        const firebaseUserInfoElem = document.getElementById('firebaseUserInfo');
        const parseUserInfoElem = document.getElementById('parseUserInfo');
        const lojaStatusElem = document.getElementById('lojaStatus');
        const logoutButton = document.getElementById('logoutBtn');
        
        const claimRewardBtn = document.getElementById('claimRewardBtn');
        const userMoneyElem = document.getElementById('userMoney');
        const dailyStreakElem = document.getElementById('dailyStreak');
        const rewardMessageElem = document.getElementById('rewardMessage');

        // --- Global Variables ---
        let firebaseUser = null; // Firebase user object
        let parseUser = null;
        const REWARD_SCHEDULE = [10, 11, 11, 12, 15, 16, 20]; // Recompensas para 7 dias
        // --- Event Listeners and Initialization ---

        // Monitor Firebase auth state (Essential for Sync/Login)
        auth.onAuthStateChanged(async user => {
            if (user) {
                firebaseUser = user;
                console.log("Firebase user logged in:", firebaseUser.uid);
                atualizarCabecalhoUI(firebaseUser); // Atualiza cabe√ßalho
                atualizarDetalhesFirebaseUI(firebaseUser); // Atualiza detalhes Firebase

               // const parseUser = Parse.User.current();
                   parseUser = await Parse.User.currentAsync(); 
                if (parseUser) {
                     await initializeUserData(); // Novo m√©todo
                    console.log("Parse user logged in:", parseUser.id);
                    atualizarDetalhesParseUI(parseUser); // Atualiza detalhes Parse
                    await verificarLojaParse(parseUser); // Verifica e atualiza status da loja
                     updateRewardUI(); // Novo m√©todo
                } else {
                    console.warn("Firebase user logged in, but Parse.User.current() is null!");
                    parseUserInfoElem.textContent = 'Erro: Usu√°rio Parse n√£o sincronizado.';
                    lojaStatusElem.textContent = 'N√£o verificado (Erro Parse)';
                    // Considerar tentar login/link Parse aqui se necess√°rio
                }

            } else {
                firebaseUser = null;
                console.log("No Firebase user logged in.");
                limparUI(); // Limpa toda a UI
                // Poderia redirecionar para login: window.location.href = 'login.html';
            }
        });

        // Logout Button
        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                try {
                    await auth.signOut(); // Logout Firebase
                    await Parse.User.logOut(); // Logout Parse
                    console.log("Logout successful.");
                    limparUI();
                    // window.location.href = 'login.html'; // Opcional: redirecionar
                } catch (error) {
                    console.error('Error during logout:', error);
                    alert('‚ùå Error logging out: ' + error.message);
                }
            });
        } else {
            console.warn("Logout button not found.");
        }
        // --- UI Update Functions ---
        function atualizarCabecalhoUI(fbUser) {
            if (!fbUser) return;
            if (profilePhotoElem) profilePhotoElem.src = fbUser.photoURL || 'https://placehold.co/80x80/eee/ccc?text=:)';
            if (userNameElem) userNameElem.textContent = 'üë§ ' + (fbUser.displayName || fbUser.email || 'Usu√°rio'); // Mostra nome ou email
            if (userEmailElem) userEmailElem.textContent = 'üìß ' + fbUser.email;
        }

        function atualizarDetalhesFirebaseUI(fbUser) {
             if (!fbUser) return;
             if (firebaseUserInfoElem) {
                 firebaseUserInfoElem.textContent = `Nome: ${fbUser.displayName || '(n√£o definido)'}, ID: ${fbUser.uid}`;
             }
        }

         function atualizarDetalhesParseUI(pUser) {
             if (!pUser) return;
             if (parseUserInfoElem) {
                  // Use get("username") ou outro campo relevante como 'name' ou 'email'
                 const parseName = pUser.get("username") || pUser.get("name") || pUser.get("email") || '(n√£o definido)';
                 parseUserInfoElem.textContent = `Nome: ${parseName}, ID: ${pUser.id}`;
             }
         }

        function limparUI() {
            if (profilePhotoElem) profilePhotoElem.src = 'https://placehold.co/80x80/eee/ccc?text=?';
            if (userNameElem) userNameElem.textContent = 'üë§ N√£o conectado';
            if (userEmailElem) userEmailElem.textContent = '';
            if (firebaseUserInfoElem) firebaseUserInfoElem.textContent = 'Desconectado';
            if (parseUserInfoElem) parseUserInfoElem.textContent = 'Desconectado';
            if (lojaStatusElem) lojaStatusElem.textContent = 'Desconectado';
        }
        //funcoes do jogo 
async function initializeUserData() {
    if (!parseUser.get('grana')) {
        parseUser.set('grana', 0);
    }
    if (!parseUser.get('dailyStreak')) {
        parseUser.set('dailyStreak', 0);
    }
    if (!parseUser.get('lastRewardDate')) {
        parseUser.set('lastRewardDate', new Date(0)); // Data antiga
    }
    await parseUser.save();
}

function updateRewardUI() {
    // Atualiza saldo
    userMoneyElem.textContent = `üí≥ ${parseUser.get('grana') || 0}`;
    
    // Atualiza streak
    dailyStreakElem.textContent = `üî• ${parseUser.get('dailyStreak') || 0} dias`;
    
    // Verifica se pode resgatar
    const lastClaim = parseUser.get('lastRewardDate');
    const canClaim = canClaimReward(lastClaim);
    claimRewardBtn.disabled = !canClaim;
    rewardMessageElem.textContent = canClaim ? 
        "Recompensa di√°ria dispon√≠vel!" : 
        `Volte amanh√£ para mais! √öltimo resgate: ${formatDate(lastClaim)}`;
}

function canClaimReward(lastDate) {
    const now = new Date();
    const lastClaimDate = new Date(lastDate);
    
    // Verifica se j√° passou 24 horas
    return (now - lastClaimDate) > 24 * 60 * 60 * 1000;
}

function formatDate(date) {
    return date.toLocaleDateString('pt-BR');
}

// Event Listener para o bot√£o de recompensa
claimRewardBtn.addEventListener('click', async () => {
    try {
        const reward = calculateDailyReward();
        
        // Atualiza dados do usu√°rio
        parseUser.increment('grana', reward);
        parseUser.increment('dailyStreak', 1);
        parseUser.set('lastRewardDate', new Date());
        
        await parseUser.save();
        updateRewardUI();
        
        rewardMessageElem.textContent = `üéâ +${reward} moedas resgatadas!`;
    } catch (error) {
        console.error('Erro ao resgatar:', error);
        rewardMessageElem.textContent = '‚ùå Erro ao resgatar recompensa';
    }
});

function calculateDailyReward() {
    const streak = parseUser.get('dailyStreak') || 0;
    const dayIndex = Math.min(streak % 7, REWARD_SCHEDULE.length - 1);
    return REWARD_SCHEDULE[dayIndex];
}
        
        // --- Parse Logic Functions ---

        /**
         * Verifica se o usu√°rio Parse logado tem uma loja associada na classe 'Loja'.
         * Atualiza o elemento lojaStatusElem na UI.
         * @param {Parse.User} parseUser - O objeto Parse.User logado.
         */
        async function verificarLojaParse(parseUser) {
            if (!parseUser || !lojaStatusElem) return;

            lojaStatusElem.textContent = 'Verificando loja...'; // Estado inicial

            const Loja = Parse.Object.extend("Loja"); // Nome da sua classe Parse para lojas
            const query = new Parse.Query(Loja);
            query.equalTo("dono", parseUser); // Filtra pela coluna 'dono' que √© um ponteiro para _User
            query.select("nome"); // Seleciona apenas o nome da loja para otimizar (use o nome real do seu campo)

            try {
                const loja = await query.first(); // Tenta encontrar a primeira loja associada

                if (loja) {
                    const nomeLoja = loja.get("nome"); // Pega o nome da loja (use o nome real do seu campo)
                    console.log(`Loja encontrada para o usu√°rio ${parseUser.id}: ${nomeLoja}`);
                    lojaStatusElem.textContent = `‚úÖ Sim, possui loja: ${nomeLoja}`;
                } else {
                    console.log(`Nenhuma loja encontrada para o usu√°rio ${parseUser.id}.`);
                    lojaStatusElem.textContent = '‚ùå N√£o possui loja registrada.';
                }
            } catch (error) {
                console.error("Erro ao buscar loja no Parse:", error);
                lojaStatusElem.textContent = '‚ö†Ô∏è Erro ao verificar loja.';
            }
        }
    </script>
</body>
</html>
