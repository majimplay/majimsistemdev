<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Loja Virtual de Teste</title>
  <script src="https://www.paypal.com/sdk/js?client-id=Af7i4HgLoBa3MKob6w_aIklV2bSaeZZlN1jstVM9ZyNvGDLwv2w8DVK2eOo5e4YNLXClbVmQ4oL8l_ei&currency=BRL"></script>
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .alert-test {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px;
      margin-bottom: 20px;
    }

    .carrinho-section, .user-info {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #eee;
      border-radius: 8px;
    }

    .produto-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #eee;
    }

    .total-section {
      text-align: right;
      font-size: 1.3em;
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
    }

    .payment-instructions {
      background: #e9f5ff;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #0056b3;
    }

    #paypal-button-container {
      margin-top: 30px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="alert-test">
      <h3>Modo de Teste Ativo</h3>
      <p>Use estas credenciais para testes:</p>
      <ul>
        <li>Email: teste.comprador@example.com</li>
        <li>Senha: Teste12345</li>
        <li>Cartão: 4032 0347 1850 7894</li>
        <li>CVV: 123 | Validade: 12/2030</li>
      </ul>
    </div>

    <div class="user-info">
      <h2>Dados do Usuário</h2>
      <form id="userForm">
        <input type="text" placeholder="Nome completo" id="fullName" required>
        <input type="email" placeholder="Email" id="email" required>
        <input type="text" placeholder="CPF" id="cpf" required>
        <button type="submit">Atualizar Dados</button>
      </form>
    </div>

    <div class="carrinho-section">
      <h2>Carrinho de Compras</h2>
      <div id="carrinhoItens"></div>
      <div class="total-section">
        Total: R$ <span id="totalCarrinho">0.00</span>
      </div>
      
      <div class="payment-instructions">
        <h3>Instruções para Pagamento:</h3>
        <ol>
          <li>Clique no botão do PayPal abaixo</li>
          <li>Use o email: sb-abc123@personal.example.com</li>
          <li>Senha: TestePaypal123</li>
          <li>Complete o pagamento com o cartão de teste</li>
        </ol>
      </div>

      <div id="paypal-button-container"></div>
    </div>

    <div class="order-history">
      <h2>Histórico de Pedidos</h2>
      <div id="pedidosList"></div>
    </div>
  </div>

  <script>
    // Configuração do Parse
    Parse.initialize("TYP8SUA8qxmHIRs1mHbiFalgRxCEf51sOiSWmNEY", "n4Gfko9sO7jiAUnWX5U5GGCDQ5QtPWX97K4TzB8I");
    Parse.serverURL = "https://parseapi.back4app.com";

    let currentUser = null;

    // Funções principais
    const initApp = async () => {
      currentUser = Parse.User.current();
      
      if (!currentUser) {
        // Cria usuário de teste temporário
        const user = new Parse.User();
        user.set('username', 'teste.comprador@example.com');
        user.set('email', 'teste.comprador@example.com');
        user.set('password', 'Teste12345');
        user.set('carrinho', []);
        user.set('pedidos', []);
        
        try {
          currentUser = await user.signUp();
          loadUserData();
          loadCarrinho();
          loadPedidos();
        } catch (error) {
          console.error('Erro ao criar usuário:', error);
        }
      } else {
        loadUserData();
        loadCarrinho();
        loadPedidos();
      }
    };

    const loadUserData = () => {
      document.getElementById('fullName').value = currentUser.get('fullName') || '';
      document.getElementById('email').value = currentUser.get('email') || '';
      document.getElementById('cpf').value = currentUser.get('cpf') || '';
    };

    const loadCarrinho = async () => {
      const carrinho = currentUser.get('carrinho') || [];
      const Produto = Parse.Object.extend('Produto');
      const query = new Parse.Query(Produto);
      
      try {
        const produtos = await query.find();
        const carrinhoItens = produtos.filter(p => carrinho.includes(p.id));
        const total = carrinhoItens.reduce((sum, p) => sum + (p.get('preco') || 0), 0);

        document.getElementById('carrinhoItens').innerHTML = carrinhoItens
          .map(p => `
            <div class="produto-item">
              <span>${p.get('nome')} - R$ ${p.get('preco').toFixed(2)}</span>
              <button onclick="removerItem('${p.id}')">Remover</button>
            </div>
          `).join('');

        document.getElementById('totalCarrinho').textContent = total.toFixed(2);
      } catch (error) {
        console.error('Erro ao carregar carrinho:', error);
      }
    };

    const loadPedidos = () => {
      const pedidos = currentUser.get('pedidos') || [];
      document.getElementById('pedidosList').innerHTML = pedidos
        .map(p => `
          <div class="pedido-item">
            <p>ID: ${p.id} | Valor: R$ ${p.valor} | Status: ${p.status}</p>
          </div>
        `).join('');
    };

    // Integração PayPal
    paypal.Buttons({
      createOrder: async (data, actions) => {
        const carrinho = currentUser.get('carrinho') || [];
        const Produto = Parse.Object.extend('Produto');
        const query = new Parse.Query(Produto);
        
        const produtos = await query.find();
        const total = produtos
          .filter(p => carrinho.includes(p.id))
          .reduce((sum, p) => sum + (p.get('preco') || 0), 0);

        return actions.order.create({
          purchase_units: [{
            amount: {
              value: total.toFixed(2),
              currency_code: 'BRL'
            }
          }]
        });
      },

      onApprove: async (data, actions) => {
        const details = await actions.order.capture();
        
        const novoPedido = {
          id: details.id,
          valor: details.purchase_units[0].amount.value,
          data: new Date().toISOString(),
          status: 'Completo'
        };

        currentUser.add('pedidos', novoPedido);
        currentUser.set('carrinho', []);
        await currentUser.save();

        loadCarrinho();
        loadPedidos();
        
        alert(`Pagamento concluído!\nID: ${details.id}`);
      }
    }).render('#paypal-button-container');

    // Event Listeners
    document.getElementById('userForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      currentUser.set('fullName', document.getElementById('fullName').value);
      currentUser.set('email', document.getElementById('email').value);
      currentUser.set('cpf', document.getElementById('cpf').value);
      
      try {
        await currentUser.save();
        alert('Dados atualizados!');
      } catch (error) {
        alert('Erro ao salvar: ' + error.message);
      }
    });

    window.removerItem = async (produtoId) => {
      const novoCarrinho = currentUser.get('carrinho').filter(id => id !== produtoId);
      currentUser.set('carrinho', novoCarrinho);
      await currentUser.save();
      loadCarrinho();
    };

    // Inicialização
    initApp();
  </script>
</body>
</html>
