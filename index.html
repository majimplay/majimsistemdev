<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Minha Loja Virtual</title>
<!-- Substitua a meta tag CSP por: -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self' https://*.back4app.com;
  script-src 'self' https://unpkg.com https://cdnjs.cloudflare.com https://*.back4app.com 'unsafe-eval';
  style-src 'self' 'unsafe-inline' https://*.back4app.com;
  img-src 'self' data: https://*.back4app.com;
  connect-src 'self' https://*.back4app.com;
  font-src 'self' https://*.back4app.com;
  frame-src 'none';
  object-src 'none';
">
  
  <style>
    /* Estilos gerais */
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }
    
    header {
      background: #007BFF;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Área do painel admin */
    #adminPanel {
      width: 100%;
      text-align: center;
      padding: 10px 0;
      background: rgba(0,0,0,0.1);
      display: none;
      order: 1;
    }

    .admin-panel-btn {
      background: #ffd700 !important;
      color: #000 !important;
      padding: 8px 20px;
      border-radius: 5px;
      font-weight: bold;
      border: 2px solid #000 !important;
    }

    /* Outros estilos mantidos */
    .auth-area {
      display: flex;
      align-items: center;
    }
    
    /* ... (mantenha todos os outros estilos originais) ... */

  </style>
  <!-- SDK do Parse -->
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
  <!-- DOMPurify para sanitização -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.5/purify.min.js"></script>
</head>
<body>
  <header>
    <div class="logo">
      <h2>Minha Loja🎁</h2>
    </div>
    
    <div id="adminPanel">
      <a href="painelcompleto.html" class="admin-panel-btn" rel="noopener noreferrer">Painel de Controle 👑</a>
    </div>

    <div class="auth-area">
      <!-- Área de login -->
      <div id="loginArea" class="login-form">
        <input type="text" id="usernameInput" placeholder="Nome" required>
        <input type="password" id="passwordInput" placeholder="Senha" required>
        <button id="loginBtn">Entrar 🔑</button>
        <a href="#" id="forgotPasswordLink" rel="noopener noreferrer">Esqueci a senha 🤦‍♀️</a>
        <a href="registro.html" id="registerLink" rel="noopener noreferrer">Registrar 🎫</a>
      </div>

      <!-- Área do usuário -->
      <div id="userArea" class="user-info" style="display:none;">
        <span id="welcomeUser"></span>
        <a href="minhaconta.html" id="minhaContaLink" rel="noopener noreferrer">Minha Conta 🛒</a>
        <button id="logoutBtn">Sair 🚘</button>
      </div>
    </div>
  </header>

  <div class="container">
    <h1>Produtos à Venda</h1>
    <div id="productGrid" class="product-grid">
      <!-- Produtos carregados dinamicamente -->
    </div>
  </div>

  <script>
    // Inicialização segura do Parse
    (function initParse() {
      Parse.initialize("TYP8SUA8qxmHIRs1mHbiFalgRxCEf51sOiSWmNEY", "n4Gfko9sO7jiAUnWX5U5GGCDQ5QtPWX97K4TzB8I");
      Parse.serverURL = "https://parseapi.back4app.com/";
      Parse.enableLocalDatastore();
    })();

    // Controle de autenticação
    async function updateAuthUI() {
      const currentUser = Parse.User.current();
      const adminPanel = document.getElementById('adminPanel');
      
      if (currentUser) {
        // Verificação de admin no Cloud Code
        try {
          const isAdmin = await Parse.Cloud.run('isAdmin');
          adminPanel.style.display = isAdmin ? 'block' : 'none';
          
          document.getElementById("loginArea").style.display = "none";
          document.getElementById("userArea").style.display = "flex";
          document.getElementById("welcomeUser").textContent = 
            `Bem-vindo ${DOMPurify.sanitize(currentUser.get('username'))}! 👋`;
            
        } catch (error) {
          console.error('Verificação de admin falhou:', error);
          await Parse.User.logOut();
          window.location.reload();
        }
      } else {
        adminPanel.style.display = 'none';
        document.getElementById("loginArea").style.display = "flex";
        document.getElementById("userArea").style.display = "none";
      }
    }

    // Carregamento seguro de produtos
    async function loadProducts() {
      const Produto = Parse.Object.extend("Produto");
      const query = new Parse.Query(Produto);

      try {
        const results = await query.find();
        const grid = document.getElementById("productGrid");
        grid.innerHTML = "";

        results.forEach(produto => {
          const card = document.createElement("div");
          card.className = "product-card";
          
          // Sanitização de conteúdo
          const nome = DOMPurify.sanitize(produto.get('nome'));
          const descricao = produto.get('descricao') 
            ? DOMPurify.sanitize(produto.get('descricao'))
            : "";

          card.innerHTML = `
            <!-- Carrossel mantido -->
            <h3>${nome}</h3>
            ${descricao ? `<p>${descricao}</p>` : ""}
            <p>R$ ${parseFloat(produto.get('preco')).toFixed(2)}</p>
            <button onclick="addToCart('${produto.id}')">Comprar</button>
          `;
          
          grid.appendChild(card);
        });

      } catch (error) {
        console.error("Erro ao carregar produtos: ", error);
      }
    }

    // Event Listeners
    document.getElementById("loginBtn").addEventListener("click", async function() {
      try {
        await Parse.User.logIn(
          DOMPurify.sanitize(document.getElementById("usernameInput").value),
          DOMPurify.sanitize(document.getElementById("passwordInput").value)
        );
        await updateAuthUI();
        await loadProducts();
      } catch (error) {
        alert(`Erro: ${error.message}`);
      }
    });

    document.getElementById("logoutBtn").addEventListener("click", async function() {
      try {
        await Parse.User.logOut();
        await updateAuthUI();
        document.getElementById("productGrid").innerHTML = "";
      } catch (error) {
        alert(`Erro: ${error.message}`);
      }
    });

    // Inicialização
    (async () => {
      await updateAuthUI();
      await loadProducts();
    })();
  </script>
</body>
</html>
