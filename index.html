<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Minha Loja Virtual</title>
  <style>
    /* Estilos permanecem os mesmos */
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }
    header {
      background: #007BFF;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header .logo h2 {
      margin: 0;
    }
    .auth-area {
      display: flex;
      align-items: center;
    }
    .login-form, .user-info {
      display: flex;
      align-items: center;
    }
    .login-form p {
      margin-right: 10px;
      font-weight: bold;
    }
    .login-form button,
    .user-info button {
      padding: 5px 10px;
      border: 2px solid transparent;
      border-radius: 3px;
      cursor: pointer;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .login-form button {
      background: #28a745;
      color: white;
    }
    .login-form button:hover {
      background: #218838;
      border-color: #1e7e34;
    }
    .login-form a {
      margin-left: 10px;
      color: white;
      text-decoration: none;
      padding: 5px 10px;
      border: 2px solid transparent;
      border-radius: 3px;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .login-form a:hover {
      background-color: rgba(255,255,255,0.2);
      border-color: #fff;
    }
    .user-info a {
      margin-left: 10px;
      color: white;
      text-decoration: none;
      padding: 5px 10px;
      border: 2px solid transparent;
      border-radius: 3px;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .user-info a:hover {
      background-color: rgba(255,255,255,0.2);
      border-color: #fff;
    }
    .user-info button {
      margin-left: 10px;
      background: #dc3545;
      color: white;
    }
    .user-info button:hover {
      background: #c82333;
      border-color: #bd2130;
    }
    .user-info img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-left: 8px;
      vertical-align: middle; /* Alinha a imagem verticalmente */
    }
    .admin-panel {
      display: none;
      justify-content: center;
      margin: 10px 0;
      padding: 10px;
      background: rgba(0,123,255,0.1);
    }
    .admin-panel-btn {
      padding: 8px 15px;
      background: #007BFF;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
      font-weight: bold;
    }
    .admin-panel-btn:hover {
      background: #0056b3;
      border-color: #004085;
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .google-btn {
      background: white;
      color: #757575;
      border: 2px solid #ddd;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
      margin-left: 10px;
    }
    .google-btn:hover {
      background: #f8f8f8;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .google-icon {
      width: 16px;
      height: 16px;
      margin-right: 8px;
    }
    iframe {
      width: 100%;
      height: calc(100vh - 120px); /* Ajustar altura conforme necess치rio */
      border: none;
    }
    .user-info a.minha-loja-btn {
      margin-left: 10px;
      color: white;
      text-decoration: none;
      padding: 5px 10px;
      border: 2px solid transparent;
      border-radius: 3px;
      transition: background-color 0.3s, border-color 0.3s;
      background: #ffc107; /* Cor amarela para destaque */
    }
    .user-info a.minha-loja-btn:hover {
      background-color: #e0a800;
      border-color: #d39e00;
    }
  </style>
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
  <header>
    <div class="logo">
      <h2>Minha Loja游꾸</h2>
    </div>
    <div class="auth-area">
      <div id="loginArea" class="login-form">
        <p>S칩 aceitamos login por rede social</p>
        <button id="googleLoginBtn" class="google-btn">
          <svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="18px" height="18px"><path fill="#EA4335" d="M24 9.5c3.46 0 6.3 1.18 8.4 3.19l6.4-6.4C34.8 2.5 30 .5 24 .5 14.9.5 7.2 5.8 4 13.6l7.2 5.6C12.8 13.4 18 9.5 24 9.5z"/><path fill="#4285F4" d="M46.5 24.8c0-1.6-.14-3.2-.4-4.8H24v9.1h12.8c-.6 3-2.2 5.5-4.6 7.2l7.2 5.6c4.2-3.8 6.7-9.4 6.7-16.1z"/><path fill="#FBBC05" d="M11.2 19.2c-.4 1.2-.6 2.5-.6 3.8s.2 2.6.6 3.8l-7.2 5.6C2.5 30.2.5 27.2.5 24s2-6.2 4.5-8.4l7.2 5.6z"/><path fill="#34A853" d="M24 47.5c5.9 0 10.9-1.9 14.6-5.2l-7.2-5.6c-2 1.3-4.5 2.1-7.4 2.1-6 0-11.2-3.9-13-9.2L4 32.8C7.2 40.6 14.9 47.5 24 47.5z"/><path fill="none" d="M.5.5h47v47H.5z"/></svg>
          Entrar com Google
        </button>
      </div>
      <div id="userArea" class="user-info" style="display:none;">
        <span id="welcomeUser"></span>
        <a href="minhaconta.html" id="minhaContaLink" rel="noopener noreferrer">Minha Conta 游</a>
        <a href="minhaloja.html" id="minhaLojaBtn" rel="noopener noreferrer" class="minha-loja-btn">游낅 Minha Loja</a>
        <button id="logoutBtn">Sair 游뚲</button>
      </div>
    </div>
  </header>

  <div id="adminPanel" class="admin-panel">
    <a href="painelcompleto.html" class="admin-panel-btn" rel="noopener noreferrer">Painel de Controle 游녬</a>
  </div>

  <iframe id="mainContent" src="produtosoff.html"></iframe>

  <script>
    // --- Configura칞칚o Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyDlUQbbTP29VqBVmzOGHhfc67R1DTRPwxg", // Substitua pela sua chave real
      authDomain: "gitautenticatio.firebaseapp.com",
      projectId: "gitautenticatio",
      storageBucket: "gitautenticatio.appspot.com",
      messagingSenderId: "21514234895",
      appId: "1:21514234895:web:d34dc4c44baf586d2cc77a",
      databaseURL: "https://gitautenticatio-default-rtdb.firebaseio.com" // Adicione se usar Realtime DB
    };

    // --- Inicializa칞칚o Firebase ---
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database(); // Inicializa Realtime Database se necess치rio
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    // --- Configura칞칚o Parse/Back4App ---
    Parse.initialize("TYP8SUA8qxmHIRs1mHbiFalgRxCEf51sOiSWmNEY", "n4Gfko9sO7jiAUnWX5U5GGCDQ5QtPWX97K4TzB8I"); // Substitua pelas suas chaves
    Parse.serverURL = "https://parseapi.back4app.com/";

    // --- Fun칞칫es ---

    /**
     * Sincroniza o usu치rio Firebase com o Parse.
     * Tenta logar no Parse com o UID do Firebase. Se n칚o existir,
     * cria um novo usu치rio Parse com o UID como username e senha,
     * e o email do Firebase.
     * @param {firebase.User} user - O objeto de usu치rio do Firebase.
     */
    async function syncFirebaseUserToParse(user) {
      if (!user) return; // Sai se n칚o houver usu치rio Firebase

      const firebaseUID = user.uid;
      const firebaseEmail = user.email;

      console.log(`[Parse Sync] Iniciando para Firebase UID: ${firebaseUID}`);

      try {
        // Tenta fazer login no Parse usando o UID do Firebase como username e senha
        await Parse.User.logIn(firebaseUID, firebaseUID);
        console.log(`[Parse Sync] Usu치rio ${firebaseUID} logado com sucesso no Parse.`);
      } catch (error) {
        // Se o erro for "objeto n칚o encontrado" (usu치rio n칚o existe no Parse)
        if (error.code === Parse.Error.OBJECT_NOT_FOUND) {
          console.log(`[Parse Sync] Usu치rio ${firebaseUID} n칚o encontrado no Parse. Criando...`);
          const parseUser = new Parse.User();
          parseUser.set("username", firebaseUID); // Define username como UID
          parseUser.set("password", firebaseUID); // Define senha como UID (IMPORTANTE: considere uma estrat칠gia mais segura)
          parseUser.set("email", firebaseEmail);    // Define o email
          parseUser.set("firebaseUID", firebaseUID); // Link expl칤cito (opcional, mas 칰til)

          try {
            // Tenta registrar o novo usu치rio no Parse
            await parseUser.signUp();
            console.log(`[Parse Sync] Novo usu치rio ${firebaseUID} criado e logado no Parse.`);
          } catch (signUpError) {
            console.error(`[Parse Sync] Erro ao criar usu치rio ${firebaseUID} no Parse:`, signUpError);
            // Considerar o que fazer em caso de falha no signUp (ex: alertar usu치rio, tentar novamente?)
            alert(`Erro ao sincronizar sua conta (${signUpError.code}). Tente recarregar a p치gina.`);
          }
        } else {
          // Outro erro durante o login no Parse
          console.error(`[Parse Sync] Erro ao logar usu치rio ${firebaseUID} no Parse:`, error);
          // Considerar o que fazer aqui (ex: alertar usu치rio)
           alert(`Erro ao acessar sua conta (${error.code}). Tente recarregar a p치gina.`);
        }
      }
    }

    /**
     * Monitora o estado de autentica칞칚o do Firebase.
     * Quando o usu치rio faz login, sincroniza com o Parse.
     * Atualiza a UI e o conte칰do do iframe.
     */
    auth.onAuthStateChanged(async (user) => {
      console.log("[Auth State] Mudan칞a detectada. Usu치rio:", user ? user.uid : "Nenhum");
      if (user) {
        // **PONTO PRINCIPAL: Sincroniza com Parse AQUI**
        await syncFirebaseUserToParse(user);
        // Verifica se 칠 admin (se necess치rio)
        checkAdminStatus(user.uid);
      } else {
         // Se o usu치rio deslogou do Firebase, desloga do Parse tamb칠m
         if (Parse.User.current()) {
            console.log("[Auth State] Deslogando usu치rio Parse...");
            try {
                await Parse.User.logOut();
                console.log("[Auth State] Usu치rio Parse deslogado.");
            } catch (parseLogoutError) {
                console.error("[Auth State] Erro ao deslogar do Parse:", parseLogoutError);
            }
         }
      }
      // Atualiza a interface de login/usu치rio
      updateAuthUI(user);
      // Atualiza o conte칰do do iframe (produtos logado vs offline)
      updateIframeContent(user);
    });

    /**
     * Manipula o clique no bot칚o de login com Google.
     */
    document.getElementById('googleLoginBtn').addEventListener('click', async () => {
      console.log("[Login] Bot칚o Google clicado.");
      try {
        const result = await auth.signInWithPopup(googleProvider);
        // O onAuthStateChanged ser치 disparado automaticamente ap칩s o sucesso,
        // ent칚o a sincroniza칞칚o com o Parse ocorrer치 l치.
        console.log(`[Login] Sucesso! Usu치rio: ${result.user.displayName}`);
        // alert(`Bem-vindo ${result.user.displayName}!`); // Opcional: pode remover se a UI j치 atualiza
      } catch (error) {
        console.error('[Login] Erro no login com Google:', error);
        alert('Erro no login com Google: ' + error.message);
      }
    });

    /**
     * Manipula o clique no bot칚o de logout.
     */
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      console.log("[Logout] Bot칚o Sair clicado.");
      try {
        await auth.signOut(); // Desloga do Firebase
        // O onAuthStateChanged cuidar치 do logout do Parse.
        console.log('[Logout] Firebase signOut conclu칤do.');
        // alert('Logout realizado com sucesso!'); // Opcional: pode remover se a UI j치 atualiza
      } catch (error) {
        console.error('[Logout] Erro ao sair:', error);
        alert('Erro ao sair: ' + error.message);
      }
    });

    /**
     * Verifica se o UID do usu치rio existe no n칩 'admins' do Firebase Realtime DB.
     * Mostra ou esconde o painel de administra칞칚o baseado no resultado.
     * @param {string} uid - O UID do usu치rio Firebase.
     */
    async function checkAdminStatus(uid) {
      if (!uid) return; // Sai se n칚o houver UID
      console.log(`[Admin Check] Verificando status para UID: ${uid}`);
      try {
        const snapshot = await database.ref('admins/' + uid).once('value');
        const isAdmin = snapshot.exists();
        console.log(`[Admin Check] UID ${uid} 칠 admin? ${isAdmin}`);
        document.getElementById('adminPanel').style.display = isAdmin ? 'flex' : 'none';
      } catch (error) {
        console.error('[Admin Check] Erro ao verificar admin:', error);
        // Esconder o painel por seguran칞a em caso de erro
        document.getElementById('adminPanel').style.display = 'none';
      }
    }

    /**
     * Atualiza a interface do cabe칞alho (치rea de login vs 치rea do usu치rio).
     * @param {firebase.User | null} user - O objeto de usu치rio do Firebase ou null.
     */
    function updateAuthUI(user) {
      const loginArea = document.getElementById('loginArea');
      const userArea = document.getElementById('userArea');
      const welcomeUser = document.getElementById('welcomeUser');
      const adminPanel = document.getElementById('adminPanel');

      if (user) {
        // Usu치rio logado
        loginArea.style.display = 'none';
        userArea.style.display = 'flex';
        let welcomeMessage = `Bem-vindo, ${user.displayName || user.email.split('@')[0]}!`;
        if (user.photoURL) {
          // Adiciona a imagem AP칍S o texto, garantindo que o texto sempre apare칞a
           welcomeMessage += ` <img src="${user.photoURL}" alt="Foto" style="width: 30px; height: 30px; border-radius: 50%; margin-left: 8px; vertical-align: middle;">`;
        }
         welcomeUser.innerHTML = welcomeMessage;

      } else {
        // Usu치rio deslogado
        loginArea.style.display = 'flex';
        userArea.style.display = 'none';
        welcomeUser.innerHTML = ''; // Limpa a mensagem de boas-vindas
        adminPanel.style.display = 'none'; // Esconde painel admin ao deslogar
      }
       console.log("[UI Update] Interface de autentica칞칚o atualizada. Logado:", !!user);
    }

    /**
     * Atualiza o atributo 'src' do iframe principal.
     * Carrega 'produtos.html' se logado, 'produtosoff.html' caso contr치rio.
     * @param {firebase.User | null} user - O objeto de usu치rio do Firebase ou null.
     */
    function updateIframeContent(user) {
      const iframe = document.getElementById('mainContent');
      const targetSrc = user ? 'produtos.html' : 'produtosoff.html';
       if (iframe.src.endsWith(targetSrc)) {
           console.log(`[Iframe Update] Iframe j치 est치 em ${targetSrc}. Nenhuma altera칞칚o.`);
           return; // Evita recarregamento desnecess치rio
       }
      iframe.src = targetSrc;
      console.log(`[Iframe Update] Iframe atualizado para: ${targetSrc}`);
    }

  </script>
</body>
</html>
