<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Minha Loja Virtual</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }
    header {
      background: #007BFF;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header .logo h2 {
      margin: 0;
    }
    .auth-area {
      display: flex;
      align-items: center;
    }
    .login-form, .user-info {
      display: flex;
      align-items: center;
    }
    .login-form p {
      margin-right: 10px;
      font-weight: bold;
    }
    .login-form button,
    .user-info button {
      padding: 5px 10px;
      border: 2px solid transparent;
      border-radius: 3px;
      cursor: pointer;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .login-form button {
      background: #28a745;
      color: white;
    }
    .login-form button:hover {
      background: #218838;
      border-color: #1e7e34;
    }
    .login-form a {
      margin-left: 10px;
      color: white;
      text-decoration: none;
      padding: 5px 10px;
      border: 2px solid transparent;
      border-radius: 3px;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .login-form a:hover {
      background-color: rgba(255,255,255,0.2);
      border-color: #fff;
    }
    .user-info a {
      margin-left: 10px;
      color: white;
      text-decoration: none;
      padding: 5px 10px;
      border: 2px solid transparent;
      border-radius: 3px;
      transition: background-color 0.3s, border-color 0.3s;
    }
    .user-info a:hover {
      background-color: rgba(255,255,255,0.2);
      border-color: #fff;
    }
    .user-info button {
      margin-left: 10px;
      background: #dc3545;
      color: white;
    }
    .user-info button:hover {
      background: #c82333;
      border-color: #bd2130;
    }
    .user-info img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-left: 8px;
      vertical-align: middle; /* Alinha a imagem verticalmente */
    }
    .admin-panel {
      display: none;
      justify-content: center;
      margin: 10px 0;
      padding: 10px;
      background: rgba(0,123,255,0.1);
    }
    .admin-panel-btn {
      padding: 8px 15px;
      background: #007BFF;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
      font-weight: bold;
    }
    .admin-panel-btn:hover {
      background: #0056b3;
      border-color: #004085;
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .google-btn {
      background: white;
      color: #757575;
      border: 2px solid #ddd;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
      margin-left: 10px;
    }
    .google-btn:hover {
      background: #f8f8f8;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .google-icon {
      width: 16px;
      height: 16px;
      margin-right: 8px;
    }
    iframe {
      width: 100%;
      height: calc(100vh - 120px); /* Ajustar altura conforme necess√°rio */
      border: none;
    }
    .user-info a.minha-loja-btn {
      margin-left: 10px;
      color: white;
      text-decoration: none;
      padding: 5px 10px;
      border: 2px solid transparent;
      border-radius: 3px;
      transition: background-color 0.3s, border-color 0.3s;
      background: #ffc107; /* Cor amarela para destaque */
    }
    .user-info a.minha-loja-btn:hover {
      background-color: #e0a800;
      border-color: #d39e00;
    }
     .cart-button {
        transition: background-color 0.3s, border-color 0.3s;
    }
    .cart-button:hover {
        background-color: rgba(255, 255, 255, 0.2);
        border-color: #fff;
    }
    #clearCartBtn:hover {
        opacity: 0.8;
    }
  </style>
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
  <header>
    <div class="logo">
      <h2>Minha LojaüéÅ</h2>
    </div>
    <div class="auth-area">
      <div id="loginArea" class="login-form">
        <p>S√≥ aceitamos login por rede social</p>
        <button id="googleLoginBtn" class="google-btn">
          <svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="18px" height="18px"><path fill="#EA4335" d="M24 9.5c3.46 0 6.3 1.18 8.4 3.19l6.4-6.4C34.8 2.5 30 .5 24 .5 14.9.5 7.2 5.8 4 13.6l7.2 5.6C12.8 13.4 18 9.5 24 9.5z"/><path fill="#4285F4" d="M46.5 24.8c0-1.6-.14-3.2-.4-4.8H24v9.1h12.8c-.6 3-2.2 5.5-4.6 7.2l7.2 5.6c4.2-3.8 6.7-9.4 6.7-16.1z"/><path fill="#FBBC05" d="M11.2 19.2c-.4 1.2-.6 2.5-.6 3.8s.2 2.6.6 3.8l-7.2 5.6C2.5 30.2.5 27.2.5 24s2-6.2 4.5-8.4l7.2 5.6z"/><path fill="#34A853" d="M24 47.5c5.9 0 10.9-1.9 14.6-5.2l-7.2-5.6c-2 1.3-4.5 2.1-7.4 2.1-6 0-11.2-3.9-13-9.2L4 32.8C7.2 40.6 14.9 47.5 24 47.5z"/><path fill="none" d="M.5.5h47v47H.5z"/></svg>
          Entrar com Google
        </button>
      </div>
      <div id="userArea" class="user-info" style="display:none;">
        <span id="welcomeUser"></span>
        <a href="minhaconta.html" id="minhaContaLink" rel="noopener noreferrer">Minha Conta  ‚ô•üßë </a>
        <a href="minhaloja.html" id="minhaLojaBtn" rel="noopener noreferrer" class="minha-loja-btn">üè™ Minha Loja</a>
        <a href="carrinhodecompra.html" id="meuCarrinhoBtn" class="cart-button" style="margin-left: 10px; color: white; text-decoration: none; padding: 5px 10px; border: 1px solid white; border-radius: 3px; display: inline-flex; align-items: center;" rel="noopener noreferrer">
    Meu Carrinho üõí (<span id="cart-count">0</span>)
</a>
<button id="clearCartBtn" title="Limpar Carrinho" style="background: none; border: none; color: white; font-size: 1.2em; cursor: pointer; margin-left: 5px; padding: 0 5px;">üóëÔ∏è</button>
        <button id="logoutBtn">Sair üöò</button>
      </div>
    </div>
  </header>

  <div id="adminPanel" class="admin-panel">
    <a href="painelcompleto.html" class="admin-panel-btn" rel="noopener noreferrer">Painel de Controle üëë</a>
  </div>

  <iframe id="mainContent" src="produtosoff.html"></iframe>

  <script>
    // --- Configura√ß√£o Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyDlUQbbTP29VqBVmzOGHhfc67R1DTRPwxg", // Substitua pela sua chave real
      authDomain: "gitautenticatio.firebaseapp.com",
      projectId: "gitautenticatio",
      storageBucket: "gitautenticatio.appspot.com",
      messagingSenderId: "21514234895",
      appId: "1:21514234895:web:d34dc4c44baf586d2cc77a",
      databaseURL: "https://gitautenticatio-default-rtdb.firebaseio.com" // Adicione se usar Realtime DB
    };

    // --- Inicializa√ß√£o Firebase ---
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database(); // Inicializa Realtime Database se necess√°rio
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    // --- Configura√ß√£o Parse/Back4App ---
    Parse.initialize("TYP8SUA8qxmHIRs1mHbiFalgRxCEf51sOiSWmNEY", "n4Gfko9sO7jiAUnWX5U5GGCDQ5QtPWX97K4TzB8I"); // Substitua pelas suas chaves
    Parse.serverURL = "https://parseapi.back4app.com/";

    // --- Fun√ß√µes ---

    /**
     * Sincroniza o usu√°rio Firebase com o Parse.
     * Tenta logar no Parse com o UID do Firebase. Se n√£o existir,
     * cria um novo usu√°rio Parse com o UID como username e senha,
     * e o email do Firebase.
     * @param {firebase.User} user - O objeto de usu√°rio do Firebase.
     */
    async function syncFirebaseUserToParse(user) {
      if (!user) return; // Sai se n√£o houver usu√°rio Firebase

      const firebaseUID = user.uid;
      const firebaseEmail = user.email;

      console.log(`[Parse Sync] Iniciando para Firebase UID: ${firebaseUID}`);

      try {
        // Tenta fazer login no Parse usando o UID do Firebase como username e senha
        await Parse.User.logIn(firebaseUID, firebaseUID);
        console.log(`[Parse Sync] Usu√°rio ${firebaseUID} logado com sucesso no Parse.`);
      } catch (error) {
        // Se o erro for "objeto n√£o encontrado" (usu√°rio n√£o existe no Parse)
        if (error.code === Parse.Error.OBJECT_NOT_FOUND) {
          console.log(`[Parse Sync] Usu√°rio ${firebaseUID} n√£o encontrado no Parse. Criando...`);
          const parseUser = new Parse.User();
          parseUser.set("username", firebaseUID); // Define username como UID
          parseUser.set("password", firebaseUID); // Define senha como UID (IMPORTANTE: considere uma estrat√©gia mais segura)
          parseUser.set("email", firebaseEmail);    // Define o email
           parseUser.set("carrinho", []); // carrinho vasiu)
          parseUser.set("firebaseUID", firebaseUID); // Link expl√≠cito (opcional, mas √∫til)

          try {
            // Tenta registrar o novo usu√°rio no Parse
            await parseUser.signUp();
            console.log(`[Parse Sync] Novo usu√°rio ${firebaseUID} criado e logado no Parse.`);
          } catch (signUpError) {
            console.error(`[Parse Sync] Erro ao criar usu√°rio ${firebaseUID} no Parse:`, signUpError);
            // Considerar o que fazer em caso de falha no signUp (ex: alertar usu√°rio, tentar novamente?)
            alert(`Erro ao sincronizar sua conta (${signUpError.code}). Tente recarregar a p√°gina.`);
          }
        } else {
          // Outro erro durante o login no Parse
          console.error(`[Parse Sync] Erro ao logar usu√°rio ${firebaseUID} no Parse:`, error);
          // Considerar o que fazer aqui (ex: alertar usu√°rio)
           alert(`Erro ao acessar sua conta (${error.code}). Tente recarregar a p√°gina.`);
        }
      }
    }

    /**
     * Monitora o estado de autentica√ß√£o do Firebase.
     * Quando o usu√°rio faz login, sincroniza com o Parse.
     * Atualiza a UI e o conte√∫do do iframe.
     */
   auth.onAuthStateChanged(async (user) => {
      console.log("[Auth State] Mudan√ßa detectada. Usu√°rio:", user ? user.uid : "Nenhum");
      if (user) {
        await syncFirebaseUserToParse(user);
        // **NOVO: Carrega contagem inicial do carrinho ap√≥s sincronizar/logar Parse**
        await loadInitialCartCount();
        checkAdminStatus(user.uid);
      } else {
         // Se deslogou, zera a contagem do carrinho na UI
         updateCartCount(0);
         if (Parse.User.current()) {
            console.log("[Auth State] Deslogando usu√°rio Parse...");
            try {
                await Parse.User.logOut();
                console.log("[Auth State] Usu√°rio Parse deslogado.");
            } catch (parseLogoutError) {
                console.error("[Auth State] Erro ao deslogar do Parse:", parseLogoutError);
            }
         }
      }
      updateAuthUI(user);
      updateIframeContent(user);
    });

    function updateAuthUI(user) {
      const loginArea = document.getElementById('loginArea');
      const userArea = document.getElementById('userArea');
      const welcomeUser = document.getElementById('welcomeUser');
      const adminPanel = document.getElementById('adminPanel');
      // **NOVO: Seleciona os elementos do carrinho**
      const cartButton = document.getElementById('meuCarrinhoBtn');
      const clearCartButton = document.getElementById('clearCartBtn');


      if (user) {
        // ... (c√≥digo existente para mostrar userArea)
        // **NOVO: Mostra bot√µes do carrinho**
        if(cartButton) cartButton.style.display = 'inline-flex';
        if(clearCartButton) clearCartButton.style.display = 'inline-block'; // ou 'inline-flex'

      } else {
        // ... (c√≥digo existente para mostrar loginArea)
         // **NOVO: Esconde bot√µes do carrinho**
        if(cartButton) cartButton.style.display = 'none';
        if(clearCartButton) clearCartButton.style.display = 'none';
        // ... (c√≥digo existente para esconder adminPanel)
      }
       console.log("[UI Update] Interface de autentica√ß√£o atualizada. Logado:", !!user);
    }

    // **NOVO: Listener para limpar carrinho**
    const clearCartButton = document.getElementById('clearCartBtn');
    if (clearCartButton) {
        clearCartButton.addEventListener('click', clearCart);
    }

     // **NOVO: Listener para mensagens do iframe (atualiza√ß√£o de contagem)**
     window.addEventListener('message', (event) => {
         // IMPORTANTE: Verifique a origem em produ√ß√£o!
         // if (event.origin !== 'URL_ESPERADA_DO_IFRAME') return;

         if (event.data && event.data.type === 'cartUpdate') {
             console.log("[Message Listener] Recebido 'cartUpdate' do iframe. Nova contagem:", event.data.count);
             updateCartCount(event.data.count);
         }
     });

    /**
     * Manipula o clique no bot√£o de login com Google.
     */
    document.getElementById('googleLoginBtn').addEventListener('click', async () => {
      console.log("[Login] Bot√£o Google clicado.");
      try {
        const result = await auth.signInWithPopup(googleProvider);
        // O onAuthStateChanged ser√° disparado automaticamente ap√≥s o sucesso,
        // ent√£o a sincroniza√ß√£o com o Parse ocorrer√° l√°.
        console.log(`[Login] Sucesso! Usu√°rio: ${result.user.displayName}`);
        // alert(`Bem-vindo ${result.user.displayName}!`); // Opcional: pode remover se a UI j√° atualiza
      } catch (error) {
        console.error('[Login] Erro no login com Google:', error);
        alert('Erro no login com Google: ' + error.message);
      }
    });

    /**
     * Manipula o clique no bot√£o de logout.
     */
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      console.log("[Logout] Bot√£o Sair clicado.");
      try {
        await auth.signOut(); // Desloga do Firebase
        // O onAuthStateChanged cuidar√° do logout do Parse.
        console.log('[Logout] Firebase signOut conclu√≠do.');
        // alert('Logout realizado com sucesso!'); // Opcional: pode remover se a UI j√° atualiza
      } catch (error) {
        console.error('[Logout] Erro ao sair:', error);
        alert('Erro ao sair: ' + error.message);
      }
    });

    /**
     * Verifica se o UID do usu√°rio existe no n√≥ 'admins' do Firebase Realtime DB.
     * Mostra ou esconde o painel de administra√ß√£o baseado no resultado.
     * @param {string} uid - O UID do usu√°rio Firebase.
     */
    async function checkAdminStatus(uid) {
      if (!uid) return; // Sai se n√£o houver UID
      console.log(`[Admin Check] Verificando status para UID: ${uid}`);
      try {
        const snapshot = await database.ref('admins/' + uid).once('value');
        const isAdmin = snapshot.exists();
        console.log(`[Admin Check] UID ${uid} √© admin? ${isAdmin}`);
        document.getElementById('adminPanel').style.display = isAdmin ? 'flex' : 'none';
      } catch (error) {
        console.error('[Admin Check] Erro ao verificar admin:', error);
        // Esconder o painel por seguran√ßa em caso de erro
        document.getElementById('adminPanel').style.display = 'none';
      }
    }

    /**
     * Atualiza a interface do cabe√ßalho (√°rea de login vs √°rea do usu√°rio).
     * @param {firebase.User | null} user - O objeto de usu√°rio do Firebase ou null.
     */
    function updateAuthUI(user) {
      const loginArea = document.getElementById('loginArea');
      const userArea = document.getElementById('userArea');
      const welcomeUser = document.getElementById('welcomeUser');
      const adminPanel = document.getElementById('adminPanel');

      if (user) {
        // Usu√°rio logado
        loginArea.style.display = 'none';
        userArea.style.display = 'flex';
        let welcomeMessage = `Bem-vindo, ${user.displayName || user.email.split('@')[0]}!`;
        if (user.photoURL) {
          // Adiciona a imagem AP√ìS o texto, garantindo que o texto sempre apare√ßa
           welcomeMessage += ` <img src="${user.photoURL}" alt="Foto" style="width: 30px; height: 30px; border-radius: 50%; margin-left: 8px; vertical-align: middle;">`;
        }
         welcomeUser.innerHTML = welcomeMessage;

      } else {
        // Usu√°rio deslogado
        loginArea.style.display = 'flex';
        userArea.style.display = 'none';
        welcomeUser.innerHTML = ''; // Limpa a mensagem de boas-vindas
        adminPanel.style.display = 'none'; // Esconde painel admin ao deslogar
      }
       console.log("[UI Update] Interface de autentica√ß√£o atualizada. Logado:", !!user);
    }

    /**
     * Atualiza o atributo 'src' do iframe principal.
     * Carrega 'produtos.html' se logado, 'produtosoff.html' caso contr√°rio.
     * @param {firebase.User | null} user - O objeto de usu√°rio do Firebase ou null.
     */
    function updateIframeContent(user) {
      const iframe = document.getElementById('mainContent');
      const targetSrc = user ? 'produtos.html' : 'produtosoff.html';
       if (iframe.src.endsWith(targetSrc)) {
           console.log(`[Iframe Update] Iframe j√° est√° em ${targetSrc}. Nenhuma altera√ß√£o.`);
           return; // Evita recarregamento desnecess√°rio
       }
      iframe.src = targetSrc;
      console.log(`[Iframe Update] Iframe atualizado para: ${targetSrc}`);
    }



    /**
     * Atualiza o contador de itens no bot√£o do carrinho.
     * @param {number} count - O n√∫mero de itens no carrinho.
     */
    function updateCartCount(count) {
        const cartCountSpan = document.getElementById('cart-count');
        if (cartCountSpan) {
            cartCountSpan.textContent = count;
            console.log(`[Cart Count] Atualizado para: ${count}`);
        }
    }

    /**
     * Carrega a contagem inicial do carrinho do usu√°rio Parse logado.
     */
    async function loadInitialCartCount() {
        const parseUser = Parse.User.current();
        if (parseUser) {
            const cart = parseUser.get('carrinho') || [];
            updateCartCount(cart.length);
        } else {
            updateCartCount(0); // Zera se n√£o houver usu√°rio Parse
        }
    }

    /**
     * Limpa o carrinho do usu√°rio Parse logado.
     */
    async function clearCart() {
        const parseUser = Parse.User.current();
        if (!parseUser) {
            alert("Voc√™ precisa estar logado para limpar o carrinho.");
            return;
        }
        if (!confirm("Tem certeza que deseja esvaziar seu carrinho?")) {
            return;
        }

        console.log("[Cart Clear] Tentando limpar carrinho...");
        parseUser.set('carrinho', []); // Define como array vazio
        try {
            await parseUser.save();
            updateCartCount(0); // Atualiza a contagem na UI
            alert("Carrinho esvaziado com sucesso!");
            console.log("[Cart Clear] Carrinho limpo no Parse.");
            // Opcional: Enviar mensagem para o iframe atualizar, se necess√°rio
            const iframe = document.getElementById('mainContent');
             if (iframe && iframe.contentWindow) {
                 iframe.contentWindow.postMessage({ type: 'cartCleared' }, '*'); // Use origem espec√≠fica em prod
             }

        } catch (error) {
            console.error("[Cart Clear] Erro ao limpar carrinho:", error);
            alert("Erro ao limpar o carrinho: " + error.message);
        }
    }


  </script>
</body>
</html>
