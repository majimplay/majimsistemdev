<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minha Loja Virtual</title>
  <style>
    /* Estilos CSS permanecem os mesmos */
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f4;
    }
    header {
      background: #007BFF;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap; /* Allow wrapping on smaller screens */
    }
    header .logo h2 {
      margin: 0;
      margin-bottom: 5px; /* Add some space below logo on wrap */
    }
    .auth-area {
      display: flex;
      align-items: center;
       flex-wrap: wrap; /* Allow wrapping */
    }
    .login-form, .user-info {
      display: flex;
      align-items: center;
      flex-wrap: wrap; /* Allow buttons/links to wrap */
      margin-top: 5px; /* Spacing when wrapped */
    }
    .login-form p {
      margin-right: 10px;
      font-weight: bold;
      margin-bottom: 5px; /* Spacing */
    }
    .login-form button,
    .user-info button,
    .user-info a { /* Apply common styles to links too */
      padding: 5px 10px;
      border: 2px solid transparent;
      border-radius: 3px;
      cursor: pointer;
      transition: background-color 0.3s, border-color 0.3s, transform 0.2s;
      margin: 2px; /* Spacing between elements */
      text-decoration: none; /* Ensure links look like buttons */
      color: white; /* Default color for user area links/buttons */
      display: inline-flex; /* Align icons and text */
      align-items: center; /* Align icons and text */
      justify-content: center; /* Center content */
      font-size: 0.9em; /* Adjust font size slightly */
    }

    .login-form button {
      background: #28a745;
      color: white;
    }
    .login-form button:hover {
      background: #218838;
      border-color: #1e7e34;
       transform: translateY(-1px);
    }
    .login-form a {
      margin-left: 10px;
      color: white;
      background-color: rgba(255,255,255,0.1); /* Subtle background */
    }
    .login-form a:hover {
      background-color: rgba(255,255,255,0.2);
      border-color: #fff;
       transform: translateY(-1px);
    }

    .user-info a, .user-info button { /* Common styles for user area */
        margin-left: 5px;
    }

    .user-info a:hover, .user-info button:hover {
        background-color: rgba(255,255,255,0.2);
        border-color: #fff;
        transform: translateY(-1px);
    }

    /* Specific button styles */
     .user-info button#logoutBtn {
      background: #dc3545;
    }
     .user-info button#logoutBtn:hover {
      background: #c82333;
      border-color: #bd2130;
    }
     .user-info a.minha-loja-btn {
      background: #ffc107; /* Cor amarela para destaque */
      color: #333; /* Darker text for yellow */
    }
     .user-info a.minha-loja-btn:hover {
      background-color: #e0a800;
      border-color: #d39e00;
    }
    .user-info a#meuCarrinhoBtn {
        border: 1px solid white; /* Keep border for cart */
    }
    .user-info button#clearCartBtn {
      background: none;
      border: none;
      color: white;
      font-size: 1.2em; /* Make icon slightly larger */
      padding: 0 5px;
      margin-left: 0; /* Adjust spacing */
    }
    .user-info button#clearCartBtn:hover {
      opacity: 0.8;
      background: none; /* Ensure no background on hover */
      border: none;
      transform: scale(1.1); /* Slightly enlarge trash icon on hover */
    }

    .user-info img {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-left: 8px;
      vertical-align: middle; /* Alinha a imagem verticalmente */
    }
    .admin-panel {
      display: none;
      justify-content: center;
      margin: 10px 0;
      padding: 10px;
      background: rgba(0,123,255,0.1);
    }
    .admin-panel-btn {
      padding: 8px 15px;
      background: #007BFF;
      color: white;
      text-decoration: none;
      border-radius: 5px;
      border: 2px solid transparent;
      transition: all 0.3s ease;
      font-weight: bold;
    }
    .admin-panel-btn:hover {
      background: #0056b3;
      border-color: #004085;
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .google-btn {
      background: white;
      color: #757575;
      border: 2px solid #ddd;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      display: flex;
      align-items: center;
      transition: all 0.3s ease;
      margin-left: 10px;
    }
    .google-btn:hover {
      background: #f8f8f8;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
       transform: translateY(-1px);
    }
    .google-icon {
      width: 16px;
      height: 16px;
      margin-right: 8px;
    }
    iframe {
      width: 100%;
      /* Calculate height considering header potentially wrapping */
      height: calc(100vh - 150px); /* Adjusted height, test this value */
      border: none;
      display: block; /* Ensure iframe takes block space */
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        header {
            flex-direction: column; /* Stack logo and auth area */
            align-items: flex-start; /* Align items to the start */
        }
        .auth-area {
            width: 100%; /* Take full width */
            justify-content: flex-start; /* Align items to start */
            margin-top: 10px;
        }
        .login-form, .user-info {
            justify-content: flex-start; /* Align items to start */
            width: 100%; /* Take full width */
        }
        .user-info span#welcomeUser {
            width: 100%; /* Make welcome message take full width */
            margin-bottom: 5px; /* Add space below welcome message */
        }
         iframe {
             height: calc(100vh - 180px); /* Further adjust iframe height */
         }
    }
     @media (max-width: 480px) {
        .login-form p {
            width: 100%; /* Make text take full width */
            margin-bottom: 10px;
        }
        .google-btn {
             width: calc(100% - 20px); /* Make button wider */
             justify-content: center;
             margin-left: 0; /* Remove left margin */
        }
        .user-info a, .user-info button {
             font-size: 0.85em; /* Slightly smaller font on very small screens */
             padding: 4px 8px;
        }
        iframe {
             height: calc(100vh - 200px); /* Adjust iframe height again */
         }
     }

  </style>
  <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
  <header>
    <div class="logo">
      <h2>Minha LojaüéÅ</h2>
    </div>
    <div class="auth-area">
      <div id="loginArea" class="login-form">
        <p>S√≥ aceitamos login por rede social</p>
           <button id="googleLoginBtn" class="google-btn">
          <svg class="google-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="18px" height="18px"><path fill="#EA4335" d="M24 9.5c3.46 0 6.3 1.18 8.4 3.19l6.4-6.4C34.8 2.5 30 .5 24 .5 14.9.5 7.2 5.8 4 13.6l7.2 5.6C12.8 13.4 18 9.5 24 9.5z"/><path fill="#4285F4" d="M46.5 24.8c0-1.6-.14-3.2-.4-4.8H24v9.1h12.8c-.6 3-2.2 5.5-4.6 7.2l7.2 5.6c4.2-3.8 6.7-9.4 6.7-16.1z"/><path fill="#FBBC05" d="M11.2 19.2c-.4 1.2-.6 2.5-.6 3.8s.2 2.6.6 3.8l-7.2 5.6C2.5 30.2.5 27.2.5 24s2-6.2 4.5-8.4l7.2 5.6z"/><path fill="#34A853" d="M24 47.5c5.9 0 10.9-1.9 14.6-5.2l-7.2-5.6c-2 1.3-4.5 2.1-7.4 2.1-6 0-11.2-3.9-13-9.2L4 32.8C7.2 40.6 14.9 47.5 24 47.5z"/><path fill="none" d="M.5.5h47v47H.5z"/></svg>
          Entrar com Google
        </button>
        </button>
      </div>
      <div id="userArea" class="user-info" style="display:none;">
        <span id="welcomeUser"></span>
        <a href="minhaconta.html" id="minhaContaLink" rel="noopener noreferrer">Minha Conta ‚ô•üßë</a>
        <a href="minhaloja.html" id="minhaLojaBtn" rel="noopener noreferrer" class="minha-loja-btn">üè™ Minha Loja</a>
        <a href="carrinhodecompra.html" id="meuCarrinhoBtn" class="cart-button" style="margin-left: 10px; color: white; text-decoration: none; padding: 5px 10px; border: 1px solid white; border-radius: 3px; display: inline-flex; align-items: center;" rel="noopener noreferrer">
          Meu Carrinho üõí (<span id="cart-count">0</span>)
        </a>
        <button id="clearCartBtn" title="Limpar Carrinho" >üóëÔ∏è</button>
        <button id="logoutBtn">Sair üöò</button>
      </div>
    </div>
  </header>

  <div id="adminPanel" class="admin-panel">
    <a href="painelcompleto.html" class="admin-panel-btn" rel="noopener noreferrer">Painel de Controle üëë</a>
  </div>

  <iframe id="mainContent" src="produtosoff.html"></iframe>

  <script>
     // --- Configura√ß√£o Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyDlUQbbTP29VqBVmzOGHhfc67R1DTRPwxg", // Substitua pela sua chave real
      authDomain: "gitautenticatio.firebaseapp.com",
      projectId: "gitautenticatio",
      storageBucket: "gitautenticatio.appspot.com",
      messagingSenderId: "21514234895",
      appId: "1:21514234895:web:d34dc4c44baf586d2cc77a",
      databaseURL: "https://gitautenticatio-default-rtdb.firebaseio.com" // Adicione se usar Realtime DB
    };

    // --- Inicializa√ß√£o Firebase ---
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database(); // Inicializa Realtime Database se necess√°rio
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    // --- Configura√ß√£o Parse/Back4App ---
    Parse.initialize("TYP8SUA8qxmHIRs1mHbiFalgRxCEf51sOiSWmNEY", "n4Gfko9sO7jiAUnWX5U5GGCDQ5QtPWX97K4TzB8I"); // Substitua pelas suas chaves
    Parse.serverURL = "https://parseapi.back4app.com/";

    // --- Constantes ---
    const SESSION_TOKEN_KEY = 'parseSessionToken'; // Chave para localStorage

    // --- Elementos DOM ---
    const loginArea = document.getElementById('loginArea');
    const userArea = document.getElementById('userArea');
    const welcomeUser = document.getElementById('welcomeUser');
    const adminPanel = document.getElementById('adminPanel');
    const cartButton = document.getElementById('meuCarrinhoBtn');
    const clearCartButton = document.getElementById('clearCartBtn');
    const cartCountSpan = document.getElementById('cart-count');
    const iframe = document.getElementById('mainContent');
    const googleLoginBtn = document.getElementById('googleLoginBtn');
    const logoutBtn = document.getElementById('logoutBtn');


    // --- Fun√ß√µes ---

    /**
     * Tenta retomar a sess√£o Parse usando o token do localStorage.
     * Verifica a correspond√™ncia do Firebase UID se ambos estiverem logados.
     * Atualiza a UI inicial.
     */
    async function checkSessionOnLoad() {
        console.log("[Session Check] Verificando sess√£o Parse no carregamento...");
        const sessionToken = localStorage.getItem(SESSION_TOKEN_KEY);

        if (sessionToken) {
            console.log("[Session Check] Token encontrado no localStorage. Tentando Parse.User.become().");
            try {
                // Tenta se tornar o usu√°rio com o token salvo
                const parseUser = await Parse.User.become(sessionToken);
                console.log("[Session Check] Parse.User.become() bem-sucedido. Usu√°rio Parse:", parseUser.id);

                // Atualiza a UI com base no usu√°rio Parse logado
                updateAuthUI(null, parseUser); // Passa parseUser para UI inicial
                await loadInitialCartCount(); // Carrega contagem do carrinho
                checkAdminStatus(null, parseUser); // Verifica admin (pode usar parseUser se firebase ainda n√£o carregou)

                // Verifica o estado do Firebase para poss√≠vel valida√ß√£o cruzada
                const firebaseUser = auth.currentUser;
                if (firebaseUser) {
                    console.log("[Session Check] Usu√°rio Firebase tamb√©m detectado:", firebaseUser.uid);
                    verifyFirebaseUIDMatch(firebaseUser, parseUser); // Verifica se UIDs correspondem
                } else {
                    console.log("[Session Check] Aguardando estado do Firebase auth...");
                    // onAuthStateChanged cuidar√° da verifica√ß√£o quando o Firebase carregar
                }

            } catch (error) {
                console.warn("[Session Check] Falha ao usar Parse.User.become() (token inv√°lido/expirado?):", error.message);
                localStorage.removeItem(SESSION_TOKEN_KEY); // Remove token inv√°lido
                updateAuthUI(null, null); // Garante UI de deslogado
                updateIframeContent(null); // Garante iframe de deslogado
            }
        } else {
            console.log("[Session Check] Nenhum token encontrado no localStorage.");
            // Garante que a UI e o iframe estejam no estado deslogado se n√£o houver token
            updateAuthUI(null, null);
            updateIframeContent(null);
        }
    }


    /**
     * Sincroniza o usu√°rio Firebase com o Parse.
     * Tenta logar no Parse com o UID do Firebase (m√©todo inseguro, idealmente usar Cloud Code).
     * Se n√£o existir, cria um novo usu√°rio Parse.
     * Salva APENAS o sessionToken no localStorage.
     * Cria um objeto Cliente associado se necess√°rio.
     * @param {firebase.User} firebaseUser - O objeto de usu√°rio do Firebase.
     * @returns {Promise<Parse.User|null>} O usu√°rio Parse logado/criado ou null em caso de erro grave.
     */
    async function syncFirebaseUserToParse(firebaseUser) {
      if (!firebaseUser) return null;

      const firebaseUID = firebaseUser.uid;
      const firebaseEmail = firebaseUser.email;
      const Cliente = Parse.Object.extend("Cliente");

      console.log(`[Parse Sync] Iniciando para Firebase UID: ${firebaseUID}`);

      try {
        // !!! ATEN√á√ÉO: Usar UID como username/senha √© INSEGURO para produ√ß√£o. !!!
        // !!! Idealmente, use Firebase ID Token e valide em Cloud Code para obter/criar usu√°rio Parse e retornar sessionToken !!!
        console.log(`[Parse Sync] Tentando logar no Parse com username/senha = ${firebaseUID} (m√©todo inseguro)`);
        let parseUser = await Parse.User.logIn(firebaseUID, firebaseUID);
        console.log(`[Parse Sync] Usu√°rio ${firebaseUID} logado com sucesso no Parse.`);

        // Verifica se o Cliente existe ap√≥s o login
        const queryCliente = new Parse.Query(Cliente);
        queryCliente.equalTo("usuario", parseUser);
        let currentCliente = await queryCliente.first();

        if (!currentCliente) {
          console.warn(`[Parse Sync] Usu√°rio ${firebaseUID} logado, mas objeto Cliente n√£o encontrado. Criando...`);
          currentCliente = new Cliente();
          currentCliente.set("usuario", parseUser);
          currentCliente.set("carrinhoclient", []);
          try {
            await currentCliente.save();
            console.log("[Cliente Check] Parse ClienteClass criado com sucesso ap√≥s login:", currentCliente.id);
          } catch (saveError) {
            console.error("[Cliente Check] Erro ao criar Cliente ap√≥s login:", saveError);
            // N√£o impede o login, mas avisa o usu√°rio
            alert(`Aviso: N√£o foi poss√≠vel inicializar completamente sua conta de cliente (${saveError.code}). Funcionalidades podem ser limitadas.`);
          }
        } else {
          console.log("[Cliente Check] Objeto Cliente encontrado para o usu√°rio:", currentCliente.id);
        }

        // Salva o session token no localStorage
        const sessionToken = parseUser.getSessionToken();
        localStorage.setItem(SESSION_TOKEN_KEY, sessionToken);
        console.log("[Parse Sync] SessionToken salvo no localStorage.");

        return parseUser; // Retorna o usu√°rio Parse logado

      } catch (error) {
        // Se o erro for "objeto n√£o encontrado" (usu√°rio n√£o existe no Parse)
        if (error.code === Parse.Error.OBJECT_NOT_FOUND) {
          console.log(`[Parse Sync] Usu√°rio ${firebaseUID} n√£o encontrado no Parse. Criando...`);
          const newParseUser = new Parse.User();
          newParseUser.set("username", firebaseUID); // INSEGURO
          newParseUser.set("password", firebaseUID); // INSEGURO
          newParseUser.set("email", firebaseEmail);
          newParseUser.set("firebaseUID", firebaseUID); // **IMPORTANTE: Armazena o UID do Firebase**

          try {
            // Tenta registrar o novo usu√°rio no Parse
            const signedUpUser = await newParseUser.signUp();
            console.log(`[Parse Sync] Novo usu√°rio ${firebaseUID} criado e logado no Parse.`);

            // Cria o objeto Cliente associado
            const newCliente = new Cliente();
            newCliente.set("usuario", signedUpUser);
            newCliente.set("carrinhoclient", []);
            await newCliente.save();
            console.log("[Cliente Check] Parse ClienteClass criado com sucesso para novo usu√°rio:", newCliente.id);

            // Salva o session token no localStorage
            const sessionToken = signedUpUser.getSessionToken();
            localStorage.setItem(SESSION_TOKEN_KEY, sessionToken);
            console.log("[Parse Sync] SessionToken do novo usu√°rio salvo no localStorage.");

            return signedUpUser; // Retorna o novo usu√°rio Parse

          } catch (signUpError) {
            console.error(`[Parse Sync] Erro ao criar usu√°rio ${firebaseUID} no Parse:`, signUpError);
            alert(`Erro Cr√≠tico: N√£o foi poss√≠vel criar sua conta (${signUpError.code}). Tente recarregar a p√°gina ou contate o suporte.`);
            return null; // Indica falha na cria√ß√£o/login
          }
        } else {
          // Outro erro durante o login no Parse
          console.error(`[Parse Sync] Erro ao logar usu√°rio ${firebaseUID} no Parse:`, error);
           // Tenta limpar token antigo se houver falha de login (ex: senha inv√°lida se foi alterada)
           localStorage.removeItem(SESSION_TOKEN_KEY);
           updateAuthUI(null, null); // Atualiza UI para deslogado
           updateIframeContent(null);
           alert(`Erro ao acessar sua conta (${error.code}). Sua sess√£o foi encerrada. Tente logar novamente.`);
           return null; // Indica falha no login
        }
      }
    }

     /**
      * Verifica se o firebaseUID no Parse User corresponde ao Firebase Auth User UID.
      * Desloga o usu√°rio Parse se houver incompatibilidade.
      * @param {firebase.User} firebaseUser - Usu√°rio Firebase autenticado.
      * @param {Parse.User} parseUser - Usu√°rio Parse autenticado.
      */
     async function verifyFirebaseUIDMatch(firebaseUser, parseUser) {
        if (!firebaseUser || !parseUser) return; // Nada a fazer se um deles n√£o existe

        const parseFirebaseUID = parseUser.get('firebaseUID');
        const authFirebaseUID = firebaseUser.uid;

        console.log(`[UID Check] Verificando correspond√™ncia: Parse UID (${parseFirebaseUID}) vs Firebase Auth UID (${authFirebaseUID})`);

        if (!parseFirebaseUID) {
            console.warn(`[UID Check] O usu√°rio Parse ${parseUser.id} n√£o tem um firebaseUID associado.`);
            // Opcional: Poderia tentar atualizar o firebaseUID aqui se for a primeira vez
            // parseUser.set('firebaseUID', authFirebaseUID);
            // await parseUser.save();
            return; // Ou tratar como erro dependendo da pol√≠tica
        }

        if (parseFirebaseUID !== authFirebaseUID) {
            console.error(`[UID Check] INCOMPATIBILIDADE DETECTADA! Parse UID (${parseFirebaseUID}) !== Firebase Auth UID (${authFirebaseUID}). Deslogando Parse.`);
            alert("Erro de seguran√ßa detectado. Sua sess√£o foi encerrada. Por favor, fa√ßa login novamente.");
            await handleLogout(); // Chama a fun√ß√£o de logout completa
        } else {
            console.log("[UID Check] UIDs correspondem. Verifica√ß√£o de seguran√ßa OK.");
        }
    }


    /**
     * Monitora o estado de autentica√ß√£o do Firebase.
     * Quando o usu√°rio faz login, sincroniza com o Parse, salva o token, carrega dados e atualiza UI.
     * Quando desloga, limpa a sess√£o Parse e o token.
     */
    auth.onAuthStateChanged(async (firebaseUser) => {
      console.log("[Auth State] Mudan√ßa detectada. Usu√°rio Firebase:", firebaseUser ? firebaseUser.uid : "Nenhum");

      if (firebaseUser) {
        // Usu√°rio logado no Firebase
        let parseUser = Parse.User.current(); // Verifica se j√° existe uma sess√£o Parse (ex: via 'become')

        if (parseUser) {
            console.log("[Auth State] Sess√£o Parse j√° ativa. Verificando correspond√™ncia de UID...");
            await verifyFirebaseUIDMatch(firebaseUser, parseUser);
            // Se verifyFirebaseUIDMatch deslogar, parseUser ser√° null na pr√≥xima checagem
            parseUser = Parse.User.current(); // Re-verifica caso tenha sido deslogado
        }

         // Se n√£o h√° usu√°rio Parse logado OU se a verifica√ß√£o falhou e deslogou
        if (!parseUser) {
             console.log("[Auth State] Nenhuma sess√£o Parse ativa ou UID mismatch. Tentando sincronizar/logar no Parse...");
             parseUser = await syncFirebaseUserToParse(firebaseUser); // Tenta logar/criar no Parse e obter usu√°rio
        }


        // Se syncFirebaseUserToParse foi bem-sucedido (ou j√° estava logado e verificado)
        if (parseUser) {
            console.log("[Auth State] Usu√°rio Parse OK:", parseUser.id);
            await loadInitialCartCount(); // Carrega contagem do Cliente associado
            checkAdminStatus(firebaseUser, parseUser); // Verifica admin
            updateAuthUI(firebaseUser, parseUser); // Atualiza UI com ambos os usu√°rios
            updateIframeContent(firebaseUser); // Atualiza iframe para logado
        } else {
             console.error("[Auth State] Falha ao obter/validar usu√°rio Parse ap√≥s login Firebase.");
             // syncFirebaseUserToParse j√° deve ter limpado o token e mostrado erro.
             // Garante UI de deslogado como fallback.
             updateAuthUI(null, null);
             updateIframeContent(null);
        }

      } else {
        // Usu√°rio deslogado do Firebase
        console.log("[Auth State] Usu√°rio Firebase deslogado. Limpando sess√£o Parse e localStorage.");
        if (Parse.User.current()) {
          try {
            await Parse.User.logOut();
            console.log("[Auth State] Usu√°rio Parse deslogado.");
          } catch (parseLogoutError) {
            console.error("[Auth State] Erro ao deslogar do Parse:", parseLogoutError);
          }
        }
        localStorage.removeItem(SESSION_TOKEN_KEY); // Remove o token
        updateCartCount(0); // Zera contagem na UI
        updateAuthUI(null, null); // Atualiza UI para deslogado
        updateIframeContent(null); // Atualiza iframe para deslogado
      }
    });

    /**
     * Atualiza a interface de autentica√ß√£o (mostra/esconde √°reas, bot√µes).
     * @param {firebase.User | null} firebaseUser - O objeto de usu√°rio do Firebase ou null.
     * @param {Parse.User | null} parseUser - O objeto de usu√°rio do Parse ou null (opcional, usado para UI inicial).
     */
    function updateAuthUI(firebaseUser, parseUser = Parse.User.current()) {
      const userForDisplay = firebaseUser || (parseUser ? { // Cria um objeto simulado para display se s√≥ Parse estiver logado
          displayName: parseUser.get('username'), // Ou outro campo se preferir
          email: parseUser.get('email'),
          photoURL: null // Parse n√£o tem photoURL por padr√£o aqui
      } : null);

      if (userForDisplay) {
        // Usu√°rio logado (Firebase ou Parse via 'become')
        loginArea.style.display = 'none';
        userArea.style.display = 'flex';
        let welcomeMessage = `Bem-vindo, ${userForDisplay.displayName || userForDisplay.email?.split('@')[0]}!`;
        // Tenta pegar foto do Firebase se dispon√≠vel
        if (firebaseUser && firebaseUser.photoURL) {
          welcomeMessage += ` <img src="${firebaseUser.photoURL}" alt="Foto" style="width: 30px; height: 30px; border-radius: 50%; margin-left: 8px; vertical-align: middle;">`;
        }
        welcomeUser.innerHTML = welcomeMessage;

        // Mostra bot√µes do carrinho e outros de usu√°rio
        if(cartButton) cartButton.style.display = 'inline-flex';
        if(clearCartButton) clearCartButton.style.display = 'inline-block'; // ou 'inline-flex'

      } else {
        // Usu√°rio deslogado
        loginArea.style.display = 'flex';
        userArea.style.display = 'none';
        welcomeUser.innerHTML = '';
        adminPanel.style.display = 'none'; // Esconde painel admin

        // Esconde bot√µes do carrinho
        if(cartButton) cartButton.style.display = 'none';
        if(clearCartButton) clearCartButton.style.display = 'none';
      }
      console.log("[UI Update] Interface de autentica√ß√£o atualizada. Logado:", !!userForDisplay);
    }


    /**
     * Manipula o clique no bot√£o de login com Google.
     */
    googleLoginBtn.addEventListener('click', async () => {
      console.log("[Login] Bot√£o Google clicado.");
      // Limpa token antigo antes de tentar novo login, caso exista e esteja inv√°lido
      localStorage.removeItem(SESSION_TOKEN_KEY);
      if (Parse.User.current()) {
          await Parse.User.logOut(); // Garante que n√£o haja sess√£o Parse conflitante
      }
      try {
        const result = await auth.signInWithPopup(googleProvider);
        // O onAuthStateChanged ser√° disparado, cuidando da sincroniza√ß√£o e UI.
        console.log(`[Login] Sucesso Firebase! Usu√°rio: ${result.user.displayName}. Aguardando onAuthStateChanged...`);
      } catch (error) {
        console.error('[Login] Erro no login com Google:', error);
        alert('Erro no login com Google: ' + error.message);
         updateAuthUI(null, null); // Garante UI deslogada em caso de erro
         updateIframeContent(null);
      }
    });

    /**
     * Fun√ß√£o unificada para lidar com o processo de logout.
     */
    async function handleLogout() {
        console.log("[Logout] Iniciando processo de logout...");
        try {
            await auth.signOut(); // Desloga do Firebase (dispara onAuthStateChanged)
            console.log('[Logout] Firebase signOut conclu√≠do.');
            // onAuthStateChanged cuidar√° do logout do Parse e limpeza do token.
        } catch (error) {
            console.error('[Logout] Erro ao sair do Firebase:', error);
            // Mesmo com erro no Firebase, tenta limpar Parse e localStorage como fallback
            if (Parse.User.current()) {
                try {
                    await Parse.User.logOut();
                    console.log("[Logout Fallback] Usu√°rio Parse deslogado.");
                } catch (parseLogoutError) {
                    console.error("[Logout Fallback] Erro ao deslogar do Parse:", parseLogoutError);
                }
            }
            localStorage.removeItem(SESSION_TOKEN_KEY);
            updateAuthUI(null, null); // Atualiza UI
            updateIframeContent(null); // Atualiza iframe
            alert('Erro ao sair completamente: ' + error.message);
        }
    }

    /**
     * Manipula o clique no bot√£o de logout.
     */
    logoutBtn.addEventListener('click', handleLogout);


    /**
     * Verifica se o UID do usu√°rio existe no n√≥ 'admins' do Firebase Realtime DB.
     * Mostra ou esconde o painel de administra√ß√£o.
     * @param {firebase.User | null} firebaseUser - O objeto de usu√°rio do Firebase.
     * @param {Parse.User | null} parseUser - O objeto de usu√°rio do Parse.
     */
    async function checkAdminStatus(firebaseUser, parseUser = Parse.User.current()) {
      const uidToCheck = firebaseUser?.uid || parseUser?.get('firebaseUID'); // Prioriza Firebase UID, usa Parse como fallback

      if (!uidToCheck) {
          adminPanel.style.display = 'none'; // Esconde se n√£o tem UID
          return;
      }

      console.log(`[Admin Check] Verificando status para UID: ${uidToCheck}`);
      try {
        // Usa o UID para checar no Firebase Realtime DB
        const snapshot = await database.ref('admins/' + uidToCheck).once('value');
        const isAdmin = snapshot.exists();
        console.log(`[Admin Check] UID ${uidToCheck} √© admin? ${isAdmin}`);
        adminPanel.style.display = isAdmin ? 'flex' : 'none';
      } catch (error) {
        console.error('[Admin Check] Erro ao verificar admin:', error);
        adminPanel.style.display = 'none'; // Esconde em caso de erro
      }
    }

    /**
     * Atualiza o atributo 'src' do iframe principal.
     * @param {firebase.User | Parse.User | null} user - Um objeto de usu√°rio (Firebase ou Parse) ou null.
     */
    function updateIframeContent(user) {
      const targetSrc = user ? 'produtos.html' : 'produtosoff.html';
       // Check if the iframe exists and if its src needs updating
       if (iframe && !iframe.src.includes(targetSrc)) {
           iframe.src = targetSrc;
           console.log(`[Iframe Update] Iframe atualizado para: ${targetSrc}`);
       } else if (iframe) {
            console.log(`[Iframe Update] Iframe j√° est√° em ${targetSrc}. Nenhuma altera√ß√£o.`);
       } else {
           console.warn("[Iframe Update] Elemento iframe n√£o encontrado.");
       }
    }

    /**
     * Atualiza o contador de itens no bot√£o do carrinho na UI.
     * @param {number} count - O n√∫mero de itens no carrinho.
     */
    function updateCartCount(count) {
        if (cartCountSpan) {
            cartCountSpan.textContent = count;
            console.log(`[Cart Count UI] Atualizado para: ${count}`);
        } else {
            console.warn("[Cart Count UI] Span do contador n√£o encontrado.");
        }
    }

    /**
     * Carrega a contagem inicial do carrinho buscando o objeto Cliente
     * associado ao usu√°rio Parse logado.
     */
    async function loadInitialCartCount() {
        const parseUser = Parse.User.current();
        if (parseUser) {
            console.log("[Load Cart Count] Usu√°rio Parse logado:", parseUser.id);
            const Cliente = Parse.Object.extend("Cliente");
            const query = new Parse.Query(Cliente);
            query.equalTo("usuario", parseUser); // Busca o Cliente ligado a este usu√°rio
            query.select("carrinhoclient"); // Otimiza√ß√£o: seleciona apenas o campo necess√°rio

            try {
                const cliente = await query.first();
                if (cliente) {
                    const cart = cliente.get('carrinhoclient') || [];
                    console.log("[Load Cart Count] Cliente encontrado. Itens no carrinho:", cart.length);
                    updateCartCount(cart.length);
                } else {
                    console.warn("[Load Cart Count] Usu√°rio logado, mas nenhum objeto Cliente encontrado. Contagem zerada.");
                    updateCartCount(0);
                    // Considerar criar o Cliente aqui se for uma condi√ß√£o inesperada,
                    // mas syncFirebaseUserToParse deve ter cuidado disso.
                }
            } catch (error) {
                console.error("[Load Cart Count] Erro ao buscar Cliente:", error);
                updateCartCount(0); // Zera em caso de erro
            }
        } else {
            console.log("[Load Cart Count] Nenhum usu√°rio Parse logado. Contagem zerada.");
            updateCartCount(0); // Zera se n√£o houver usu√°rio Parse
        }
    }

    /**
     * Limpa o carrinho buscando o objeto Cliente associado
     * ao usu√°rio Parse logado e zerando o array 'carrinhoclient'.
     */
    async function clearCart() {
        const parseUser = Parse.User.current();
        if (!parseUser) {
            alert("Voc√™ precisa estar logado para limpar o carrinho.");
            return;
        }
        if (!confirm("Tem certeza que deseja esvaziar seu carrinho?")) {
            return;
        }

        console.log("[Cart Clear] Tentando limpar carrinho do Cliente...");
        const Cliente = Parse.Object.extend("Cliente");
        const query = new Parse.Query(Cliente);
        query.equalTo("usuario", parseUser);

        try {
            const cliente = await query.first();
            if (cliente) {
                cliente.set('carrinhoclient', []); // Zera o array
                await cliente.save(); // Salva a altera√ß√£o
                updateCartCount(0); // Atualiza a UI
                alert("Carrinho esvaziado com sucesso!");
                console.log("[Cart Clear] Carrinho do Cliente limpo no Parse.");

                // Envia mensagem para o iframe (produtos.html)
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.postMessage({ type: 'cartCleared' }, '*'); // Use origem espec√≠fica em prod
                    console.log("[Cart Clear] Mensagem 'cartCleared' enviada para o iframe.");
                }
            } else {
                console.warn("[Cart Clear] Cliente n√£o encontrado para o usu√°rio. N√£o foi poss√≠vel limpar.");
                alert("Erro: N√£o foi poss√≠vel encontrar os dados do seu carrinho.");
                updateCartCount(0); // Zera UI para consist√™ncia
            }
        } catch (error) {
            console.error("[Cart Clear] Erro ao limpar carrinho do Cliente:", error);
            alert("Erro ao limpar o carrinho: " + error.message);
        }
    }

    // --- Event Listeners ---

    // Listener para limpar carrinho
    if (clearCartButton) {
        clearCartButton.addEventListener('click', clearCart);
    } else {
        console.error("Bot√£o Limpar Carrinho n√£o encontrado!");
    }

    // Listener para mensagens do iframe
    window.addEventListener('message', (event) => {
        // IMPORTANTE: Verifique a origem em produ√ß√£o!
        // Ex: if (event.origin !== 'https://sua-pagina-principal.com') return;

        if (event.data && event.data.type === 'cartUpdate') {
            console.log("[Message Listener] Recebido 'cartUpdate' do iframe. Nova contagem:", event.data.count);
            updateCartCount(event.data.count); // Atualiza o n√∫mero no bot√£o
        }
    });

    // --- Inicializa√ß√£o ---
    // Verifica a sess√£o Parse existente ao carregar a p√°gina ANTES de configurar o listener do Firebase Auth
    // para que a UI possa ser atualizada corretamente o mais cedo poss√≠vel.
    checkSessionOnLoad();

  </script>
</body>
</html>
