<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>üõí Carrinho de Compras - Multi-Loja</title>
    <style>
        /* Estilos CSS (mantidos, com pequenas adi√ß√µes/ajustes) */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        .profile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid #eee;
        }
        .profile-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #007BFF;
            margin-right: 2rem;
        }
        .profile-info h1 { margin: 0; color: #333; }
        .profile-info p { color: #666; margin: 0.5rem 0; }
        .carrinho { margin: 40px 0; }
        .produto {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 10px;
            border-bottom: 1px solid #eee;
            gap: 15px;
        }
        .produto-info { flex-grow: 1; }
        .produto-info h4 { margin: 0 0 5px 0; color: #333; }
        .produto-info p { margin: 3px 0; font-size: 0.9em; color: #555; }
        .produto-info .subtotal-item { font-weight: bold; color: #007BFF; margin-top: 8px; }
        .total {
            margin-top: 20px; font-size: 1.2em; font-weight: bold;
            text-align: right; padding: 15px; background: #f8f9fa; border-radius: 4px;
        }
        .btn {
            padding: 0.8rem 1.5rem; border: none; border-radius: 6px; cursor: pointer;
            font-weight: 600; transition: all 0.3s ease; white-space: nowrap;
        }
        .btn-primary { background: #007BFF; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-danger { background: #dc3545; color: white; padding: 0.5rem 1rem; font-size: 0.9em; }
        .btn-danger:hover { background: #c82333; }
        .form-section { margin: 25px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 15px 0; }
        label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em; color: #555; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 1em; box-sizing: border-box; }
        input:read-only { background-color: #e9ecef; cursor: not-allowed; }
        .result-card {
            background: #fff; padding: 15px; border-radius: 6px; margin: 10px 0;
            border: 1px solid #eee; border-left: 4px solid #17a2b8; transition: box-shadow 0.2s ease;
        }
        .result-card:hover { box-shadow: 0 2px 5px rgba(0,0,0,0.08); }
        .result-card p { margin: 5px 0; font-size: 0.95em; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%;
            width: 30px; height: 30px; animation: spin 1s linear infinite; display: none; margin: 20px auto;
        }
        .selected-shipping { background: #e3f2fd; border-left-color: #2196F3; box-shadow: 0 0 8px rgba(33, 150, 243, 0.3); }
        .btn-select {
            background: #28a745; color: white; padding: 8px 16px; margin-top: 10px;
            border: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s ease;
        }
        .btn-select:hover { background: #218838; }
        .final-price {
            font-size: 1.4em; color: #28a745; margin: 20px 0; padding: 15px;
            background: #f8f9fa; border-radius: 8px; text-align: right;
        }
        .checkout-btn {
            background: #28a745; margin-top: 20px; display: none; /* Come√ßa escondido */
            width: 100%; font-size: 1.1em; padding: 1rem;
        }
        .checkout-btn:hover { background: #218838; }
        .emoji { margin-right: 8px; }
        .store-shipping-group {
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 8px;
            background-color: #fdfdfd;
        }
        .store-shipping-group h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #555;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://unpkg.com/parse/dist/parse.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="profile-header">
            <div style="display: flex; align-items: center;">
                <img id="profilePhoto" class="profile-photo" src="https://placehold.co/120x120/eee/ccc?text=User" alt="Foto do Perfil">
                <div class="profile-info">
                    <h1 id="userName"><span class="emoji">üì±</span> Carregando...</h1>
                    <p id="userEmail"></p>
                </div>
            </div>
            <button id="logoutBtn" class="btn btn-secondary"><span class="emoji">üö™</span> Sair</button>
        </div>

        <div class="carrinho">
            <h2><span class="emoji">üõí</span> Meu Carrinho</h2>
            <div id="carrinhoItens"><p>Carregando itens...</p></div>
            <div class="total"><span class="emoji">üì¶</span> Subtotal: R$ <span id="carrinhoTotal">0.00</span></div>
        </div>

        <div class="form-section">
            <h3><span class="emoji">üöö</span> Calcular Frete</h3>
            <div class="form-row">
                <div>
                    <label for="cep_destino">üìÆ Seu CEP (Destino)</label>
                    <input type="text" id="cep_destino" placeholder="Digite seu CEP"
                           oninput="formatarCEP(this)" onblur="buscarEndereco(this.value)">
                </div>
                <div>
                    <label for="logradouro">üè† Logradouro</label>
                    <input type="text" id="logradouro" readonly>
                </div>
                <div>
                    <label for="bairro">üèòÔ∏è Bairro</label>
                    <input type="text" id="bairro" readonly>
                </div>
                <div>
                    <label for="cidade">üåÜ Cidade</label>
                    <input type="text" id="cidade" readonly>
                </div>
                <div>
                    <label for="uf">üè≥Ô∏è Estado</label>
                    <input type="text" id="uf" readonly>
                </div>
            </div>
            <button class="btn btn-primary" onclick="calcularFreteMultiLoja()" style="margin-top: 15px;">
                <span class="emoji">üì¶</span> Calcular Frete (Todas as Lojas)
            </button>
            <div class="loader" id="mainLoader"></div>
            <div id="result" style="margin-top: 15px;"></div>
        </div>

        <div class="final-price" id="finalPriceContainer" style="display: none;">
            <span class="emoji">üí∞</span> Pre√ßo Final (Subtotal + Frete Total): R$ <span id="precoFinal">0.00</span>
        </div>

        <button id="checkoutBtn" class="btn checkout-btn" onclick="prosseguirCheckout()">
            <span class="emoji">‚úÖ</span> Prosseguir para Checkout
        </button>

        <button class="btn btn-secondary" onclick="voltarParaIndex()" style="margin-top: 15px; float: right;">
             <span class="emoji">üè†</span> Voltar para Loja
        </button>
    </div>

    <script>
        // --- Configurations ---
        const firebaseConfig = {
            apiKey: "AIzaSyDlUQbbTP29VqBVmzOGHhfc67R1DTRPwxg", // Sua chave
            authDomain: "gitautenticatio.firebaseapp.com",
            databaseURL: "https://gitautenticatio-default-rtdb.firebaseio.com", // Mantido para CEP
            projectId: "gitautenticatio",
            storageBucket: "gitautenticatio.appspot.com",
            messagingSenderId: "21514234895",
            appId: "1:21514234895:web:d34dc4c44baf586d2cc77a"
        };

        // Initialize Firebase (Auth and DB for user CEP)
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // Initialize Parse
        Parse.initialize("TYP8SUA8qxmHIRs1mHbiFalgRxCEf51sOiSWmNEY", "n4Gfko9sO7jiAUnWX5U5GGCDQ5QtPWX97K4TzB8I"); // Suas chaves
        Parse.serverURL = "https://parseapi.back4app.com/";


        // --- Global Variables ---
        let firebaseUser = null; // Firebase user object
        let totalCarrinho = 0; // Subtotal of products
        let produtosPorLoja = {}; // Object to group products by store { lojaId: { nome: 'Loja A', cepOrigem: '...', produtos: [...] } }
        let fretesSelecionados = {}; // Object to store selected shipping cost per store { lojaId: 0 }
        let totalFreteSelecionado = 0; // Total selected shipping cost
        let detalhesFretesSelecionados = {}; // Object to store full shipping details per store { lojaId: { custo: ..., metodo: ..., prazo: ... } }
        let lojasCalculadas = 0; // Counter for completed shipping calculations
        let totalLojas = 0; // Total number of stores in the cart

        // --- Event Listeners and Initialization ---

        // Monitor Firebase auth state
        auth.onAuthStateChanged(async user => {
            if (user) {
                firebaseUser = user;
                console.log("Firebase user logged in:", firebaseUser.uid);
                atualizarCabecalho();

                const parseUser = Parse.User.current();
                if (parseUser) {
                     console.log("Parse user logged in:", parseUser.id);
                     await carregarCarrinho(); // Load cart from Parse
                     await carregarCEPSalvo(); // Load user's destination CEP from Firebase
                } else {
                     console.error("Firebase user logged in, but Parse.User.current() is null!");
                     alert("Erro ao carregar dados da conta. Tente recarregar ou voltar √† p√°gina inicial.");
                     document.getElementById('carrinhoItens').innerHTML = '<p style="color: red;">Erro ao carregar carrinho. Verifique seu login.</p>';
                }

            } else {
                console.log("No Firebase user logged in. Redirecting...");
                window.location.href = 'index.html'; // Or login page
            }
        });

        // Logout Button
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await auth.signOut(); // Logout Firebase
                await Parse.User.logOut(); // Logout Parse
                console.log("Logout successful.");
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error during logout:', error);
                alert('‚ùå Error logging out: ' + error.message);
            }
        });

        // --- UI and Helper Functions ---

        // Update profile header (uses Firebase data)
        function atualizarCabecalho() {
            if (!firebaseUser) return;
            document.getElementById('profilePhoto').src = firebaseUser.photoURL || 'https://placehold.co/120x120/eee/ccc?text=:)';
            document.getElementById('userName').textContent = 'üë§ ' + (firebaseUser.displayName || 'Usu√°rio');
            document.getElementById('userEmail').textContent = 'üìß ' + firebaseUser.email;
        }

        // Format CEP input
        function formatarCEP(input) {
            let cep = input.value.replace(/\D/g, '');
            if (cep.length > 5) cep = cep.replace(/^(\d{5})(\d)/, '$1-$2');
            if (cep.length > 9) cep = cep.substring(0, 9);
            input.value = cep;
        }

        // Go back to index page
        function voltarParaIndex() {
            window.location.href = 'index.html';
        }

        // --- Cart Functions (Using Parse) ---

        /**
         * Loads cart items from the Cliente class in Parse, grouping them by store.
         */
        async function carregarCarrinho() {
            const container = document.getElementById('carrinhoItens');
            container.innerHTML = '<p>üîÑ Carregando itens...</p>';
            totalCarrinho = 0;
            produtosPorLoja = {}; // Reset store grouping
            fretesSelecionados = {}; // Reset selected shipping
            totalFreteSelecionado = 0;
            detalhesFretesSelecionados = {};
            document.getElementById('carrinhoTotal').textContent = '0.00';
            atualizarPrecoFinal();

            const parseUser = Parse.User.current();
            if (!parseUser) {
                console.error("carregarCarrinho: Parse User not found.");
                container.innerHTML = '<p style="color: red;">‚ö†Ô∏è Erro: Usu√°rio n√£o logado no sistema.</p>';
                return;
            }

            const Cliente = Parse.Object.extend("Cliente");
            const queryCliente = new Parse.Query(Cliente);
            queryCliente.equalTo("usuario", parseUser);

            try {
                const cliente = await queryCliente.first();
                if (!cliente) {
                    console.warn("No Cliente object found for user:", parseUser.id);
                    container.innerHTML = '<p>üõçÔ∏è Seu carrinho est√° vazio.</p>';
                    return;
                }

                const productIds = cliente.get('carrinhoclient') || [];
                if (productIds.length === 0) {
                    container.innerHTML = '<p>üõçÔ∏è Seu carrinho est√° vazio.</p>';
                    return;
                }

                const quantityMap = productIds.reduce((map, id) => {
                    map[id] = (map[id] || 0) + 1;
                    return map;
                }, {});
                const uniqueProductIds = Object.keys(quantityMap);

                // Fetch product details including dimensions, weight, and store pointer
                const Produto = Parse.Object.extend("Produto");
                const queryProduto = new Parse.Query(Produto);
                queryProduto.containedIn("objectId", uniqueProductIds);
                queryProduto.include("loja"); // Include the Loja object data
                queryProduto.select(
                    "nome", "preco", "imagens", "loja",
                    "altura", "largura", "comprimento", "peso" // Add dimensions and weight
                );
                const produtos = await queryProduto.find();

                // Map product details and group by store
                let html = '';
                totalCarrinho = 0;

                produtos.forEach(p => {
                    const produtoId = p.id;
                    const quantidade = quantityMap[produtoId];
                    const loja = p.get('loja'); // Get the related Loja object
                    const lojaId = loja ? loja.id : 'sem_loja'; // Use loja ID or a default key
                    const lojaNome = loja ? loja.get('nome') : 'Loja Desconhecida';
                    const lojaCep = loja ? loja.get('cepOrigem') : null; // Assuming 'cepOrigem' field exists in Loja

                    const details = {
                        id: produtoId,
                        nome: p.get('nome') || "Produto sem nome",
                        preco: p.get('preco') || 0,
                        imagemUrl: (p.get('imagens') && p.get('imagens').length > 0) ? p.get('imagens')[0] : 'https://placehold.co/60x60/eee/ccc?text=Img',
                        altura: p.get('altura') || 1, // Default dimension if missing
                        largura: p.get('largura') || 10,
                        comprimento: p.get('comprimento') || 10,
                        peso: p.get('peso') || 0.1, // Default weight if missing
                        quantidade: quantidade,
                        lojaId: lojaId,
                        lojaNome: lojaNome,
                        lojaCep: lojaCep
                    };

                    // Add to the store group
                    if (!produtosPorLoja[lojaId]) {
                        produtosPorLoja[lojaId] = {
                            nome: lojaNome,
                            cepOrigem: lojaCep,
                            produtos: []
                        };
                        fretesSelecionados[lojaId] = 0; // Initialize shipping cost for this store
                        detalhesFretesSelecionados[lojaId] = null; // Initialize shipping details
                    }
                    produtosPorLoja[lojaId].produtos.push(details);

                    // Calculate subtotal and generate HTML
                    const precoUnitario = details.preco;
                    const subtotalItem = precoUnitario * quantidade;
                    totalCarrinho += subtotalItem;

                    html += `
                        <div class="produto" id="item-${produtoId}">
                            <img src="${details.imagemUrl}" alt="${details.nome}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 15px;">
                            <div class="produto-info">
                                <h4>${details.nome} <small>(${lojaNome})</small></h4>
                                <p>üî¢ Quantidade: ${quantidade}</p>
                                <p>üí≤ Pre√ßo unit√°rio: R$ ${precoUnitario.toFixed(2)}</p>
                                <p class="subtotal-item">üí∞ Subtotal: R$ ${subtotalItem.toFixed(2)}</p>
                                <p style="font-size: 0.8em; color: #777;">Dim: ${details.altura}x${details.largura}x${details.comprimento}cm, ${details.peso}kg</p>
                            </div>
                            <button onclick="removerDoCarrinho('${produtoId}')" class="btn btn-danger">
                                <span class="emoji">‚ùå</span> Remover 1
                            </button>
                        </div>
                    `;
                });

                container.innerHTML = html || '<p>üõçÔ∏è Seu carrinho est√° vazio.</p>';
                document.getElementById('carrinhoTotal').textContent = totalCarrinho.toFixed(2);
                atualizarPrecoFinal();
                console.log("Produtos agrupados por loja:", produtosPorLoja);

            } catch (error) {
                console.error('Erro ao carregar carrinho do Parse:', error);
                container.innerHTML = `<p style="color: red;">‚ùå Erro ao carregar o carrinho: ${error.message}</p>`;
            }
        }

        /**
         * Removes ONE unit of the specified product from the cart in the Cliente class.
         * @param {string} produtoId - The objectId of the product to be removed.
         */
        window.removerDoCarrinho = async (produtoId) => {
             console.log("Attempting to remove product:", produtoId);
             const parseUser = Parse.User.current();
             if (!parseUser) { alert("‚ö†Ô∏è Error: User not logged in."); return; }

             const Cliente = Parse.Object.extend("Cliente");
             const query = new Parse.Query(Cliente);
             query.equalTo("usuario", parseUser);

             try {
                 const cliente = await query.first();
                 if (!cliente) { alert("‚ö†Ô∏è Error: Could not find your cart data."); return; }

                 let productIds = cliente.get('carrinhoclient') || [];
                 const indexToRemove = productIds.indexOf(produtoId);

                 if (indexToRemove > -1) {
                     productIds.splice(indexToRemove, 1);
                     cliente.set('carrinhoclient', productIds);
                     await cliente.save();
                     console.log("Product removed. Remaining IDs:", productIds);
                     await carregarCarrinho(); // Reload cart UI
                     alert('üóëÔ∏è One unit of the item was removed from the cart!');
                 } else {
                     console.warn("Product ID not found in carrinhoclient array:", produtoId);
                     alert("‚ö†Ô∏è Item not found in cart.");
                     await carregarCarrinho(); // Reload in case of inconsistency
                 }

             } catch (error) {
                 console.error("Error removing item from Parse:", error);
                 alert('‚ùå Error removing item: ' + error.message);
             }
         };

        // --- CEP and Shipping Functions ---

        /**
         * Loads the saved destination CEP from Firebase Realtime Database.
         */
        async function carregarCEPSalvo() {
            if (!firebaseUser) return;
            try {
                const cepSnapshot = await database.ref(`users/${firebaseUser.uid}/cepuser`).once('value');
                const cepSalvo = cepSnapshot.val();
                if (cepSalvo) {
                    const cepInput = document.getElementById('cep_destino');
                    cepInput.value = cepSalvo;
                    formatarCEP(cepInput);
                    await buscarEndereco(cepSalvo); // Fetch address automatically
                    console.log("Destination CEP loaded from Firebase:", cepSalvo);
                } else {
                     console.log("No saved destination CEP found in Firebase.");
                }
            } catch (error) {
                console.error("Error loading saved CEP:", error);
            }
        }

        /**
         * Fetches the address using ViaCEP API and fills the fields.
         * Saves the valid CEP to Firebase.
         * @param {string} cep - The destination CEP to search (with or without hyphen).
         */
        async function buscarEndereco(cep) {
            cep = cep.replace(/\D/g, '');
            const logradouroInput = document.getElementById('logradouro');
            const bairroInput = document.getElementById('bairro');
            const cidadeInput = document.getElementById('cidade');
            const ufInput = document.getElementById('uf');

            // Clear fields if CEP is invalid or incomplete
            if (cep.length !== 8) {
                logradouroInput.value = ''; bairroInput.value = '';
                cidadeInput.value = ''; ufInput.value = '';
                return;
            }

            console.log("Fetching address for destination CEP:", cep);
            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();

                if (data.erro) {
                    console.warn('ViaCEP returned error for CEP:', cep);
                    alert('‚ùå CEP de destino n√£o encontrado!');
                    logradouroInput.value = ''; bairroInput.value = '';
                    cidadeInput.value = ''; ufInput.value = '';
                    return;
                }

                // Fill form fields
                logradouroInput.value = data.logradouro || '';
                bairroInput.value = data.bairro || '';
                cidadeInput.value = data.localidade || '';
                ufInput.value = data.uf || '';
                console.log("Address found:", data);

                // Save valid CEP to Firebase (if user is logged in)
                if (firebaseUser) {
                    await database.ref(`users/${firebaseUser.uid}/cepuser`).set(cep);
                    console.log("Destination CEP saved to Firebase:", cep);
                }

            } catch (error) {
                console.error('Error fetching CEP via ViaCEP:', error);
                alert('‚ùå Erro ao buscar endere√ßo de destino. Verifique sua conex√£o ou o CEP digitado.');
            }
        }

        /**
         * Calculates shipping costs for each store in the cart by calling the Cloud Function.
         */
        async function calcularFreteMultiLoja() {
            const cepDestino = document.getElementById('cep_destino').value.replace(/\D/g, '');
            if (cepDestino.length !== 8) {
                alert("‚ö†Ô∏è Por favor, preencha um CEP de destino v√°lido (8 d√≠gitos).");
                return;
            }
            if (Object.keys(produtosPorLoja).length === 0) {
                 alert("‚ö†Ô∏è Seu carrinho est√° vazio ou os produtos n√£o puderam ser agrupados por loja.");
                 return;
            }

            const loader = document.getElementById('mainLoader');
            const resultDiv = document.getElementById('result');
            loader.style.display = 'block';
            resultDiv.innerHTML = ''; // Clear previous results
            fretesSelecionados = {}; // Reset selections
            totalFreteSelecionado = 0;
            detalhesFretesSelecionados = {};
            lojasCalculadas = 0; // Reset counter
            totalLojas = Object.keys(produtosPorLoja).length; // Set total stores for this calculation
            document.getElementById('finalPriceContainer').style.display = 'none';
            document.getElementById('checkoutBtn').style.display = 'none';
            atualizarPrecoFinal();

            console.log(`Calculando frete para ${totalLojas} loja(s)...`);

            // Iterate through each store group
            for (const lojaId in produtosPorLoja) {
                const lojaInfo = produtosPorLoja[lojaId];
                const cepOrigem = lojaInfo.cepOrigem;

                if (!cepOrigem || cepOrigem.replace(/\D/g, '').length !== 8) {
                    console.warn(`CEP de origem inv√°lido ou ausente para a loja ${lojaInfo.nome} (${lojaId}). Pulando c√°lculo.`);
                    // Display error for this store in the results
                     resultDiv.innerHTML += `
                        <div class="store-shipping-group">
                            <h4><span class="emoji">üè™</span> Frete para: ${lojaInfo.nome}</h4>
                            <p style="color: red;">‚ùå N√£o foi poss√≠vel calcular o frete: CEP de origem da loja inv√°lido ou n√£o cadastrado.</p>
                        </div>`;
                    lojasCalculadas++; // Increment counter even if skipped
                    if (lojasCalculadas === totalLojas) loader.style.display = 'none'; // Hide loader if all done
                    continue; // Skip to the next store
                }

                // Calculate package dimensions and weight for this store's items
                let pesoTotalLoja = 0;
                let alturaMax = 0;
                let larguraMax = 0;
                let comprimentoMax = 0;

                lojaInfo.produtos.forEach(p => {
                    pesoTotalLoja += (p.peso * p.quantidade);
                    alturaMax = Math.max(alturaMax, p.altura);
                    larguraMax = Math.max(larguraMax, p.largura);
                    comprimentoMax = Math.max(comprimentoMax, p.comprimento);
                });

                // Ensure minimum dimensions required by Correios/carriers if needed
                // alturaMax = Math.max(alturaMax, 2); // Exemplo: m√≠nimo 2cm
                // larguraMax = Math.max(larguraMax, 11); // Exemplo: m√≠nimo 11cm
                // comprimentoMax = Math.max(comprimentoMax, 16); // Exemplo: m√≠nimo 16cm
                // pesoTotalLoja = Math.max(pesoTotalLoja, 0.1); // Exemplo: m√≠nimo 0.1kg

                const params = {
                    cepOrigem: cepOrigem.replace(/\D/g, ''),
                    cepDestino: cepDestino,
                    package: {
                        height: alturaMax,
                        width: larguraMax,
                        length: comprimentoMax,
                        weight: pesoTotalLoja
                    },
                    lojaId: lojaId // Pass lojaId to identify results later
                };
                console.log(`Calculando frete para Loja ${lojaInfo.nome} (${lojaId}) com par√¢metros:`, params);

                // Call Cloud Function asynchronously for each store
                Parse.Cloud.run("calcularFrete", params)
                    .then(response => {
                        console.log(`Resposta da Cloud Function para Loja ${lojaId}:`, response);
                        exibirFretePorLoja(response.data || response, lojaId, lojaInfo.nome);
                    })
                    .catch(error => {
                        console.error(`Erro ao chamar Cloud Function para Loja ${lojaId}:`, error);
                        resultDiv.innerHTML += `
                            <div class="store-shipping-group">
                                <h4><span class="emoji">üè™</span> Frete para: ${lojaInfo.nome}</h4>
                                <p style="color: red;">‚ùå Erro ao calcular frete: ${error.message}</p>
                            </div>`;
                    })
                    .finally(() => {
                        lojasCalculadas++;
                        if (lojasCalculadas === totalLojas) {
                            loader.style.display = 'none'; // Hide loader when all calls are finished
                            console.log("Todos os c√°lculos de frete conclu√≠dos.");
                        }
                    });
            } // End of loop through stores
        }

        /**
         * Displays shipping options for a specific store.
         * @param {Array} servicos - Array of shipping service objects.
         * @param {string} lojaId - The ID of the store.
         * @param {string} lojaNome - The name of the store.
         */
        function exibirFretePorLoja(servicos, lojaId, lojaNome) {
            const resultDiv = document.getElementById('result');
            let storeHtml = `<div class="store-shipping-group" id="store-group-${lojaId}">
                                <h4><span class="emoji">üè™</span> Frete para: ${lojaNome}</h4>`;

            if (!Array.isArray(servicos) || servicos.length === 0) {
                 storeHtml += '<p>Nenhuma op√ß√£o de frete encontrada para este CEP.</p>';
            } else {
                // Sort by price (cheapest first) - optional
                servicos.sort((a, b) => parseFloat(a.preco) - parseFloat(b.preco));

                storeHtml += '<h5>Selecione uma op√ß√£o:</h5>' + servicos.map((servico, index) => {
                    const nomeServico = `${servico.empresa || 'Empresa'} - ${servico.metodo || 'M√©todo'}`;
                    const prazo = servico.prazo ? `${servico.prazo} dias √∫teis` : 'Prazo indispon√≠vel';
                    const preco = parseFloat(servico.preco);
                    const precoFormatado = !isNaN(preco) ? `R$ ${preco.toFixed(2)}` : 'Pre√ßo indispon√≠vel';

                    return `
                        <div class="result-card" id="frete-opcao-${lojaId}-${index}">
                            <p><strong><span class="emoji">üöö</span> ${nomeServico}</strong></p>
                            <p><span class="emoji">üìÖ</span> Prazo estimado: ${prazo}</p>
                            <p><strong><span class="emoji">üí≤</span> Pre√ßo: ${precoFormatado}</strong></p>
                            ${!isNaN(preco) ?
                                `<button class="btn-select"
                                        onclick="selecionarFrete('${lojaId}', ${preco}, '${nomeServico}', '${prazo}', this)">
                                    <span class="emoji">‚úÖ</span> Selecionar
                                </button>`
                                : '<p style="color: #888;">Op√ß√£o indispon√≠vel</p>'
                            }
                        </div>
                    `;
                }).join('');
            }
            storeHtml += `</div>`;
            resultDiv.innerHTML += storeHtml; // Append this store's results
        }

        /**
         * Updates the selected shipping cost for a specific store and the UI.
         * @param {string} lojaId - The ID of the store for which shipping is selected.
         * @param {number} preco - The price of the selected shipping.
         * @param {string} metodo - The name/method of the shipping service.
         * @param {string} prazo - The estimated delivery time.
         * @param {HTMLElement} element - The button that was clicked.
         */
        function selecionarFrete(lojaId, preco, metodo, prazo, element) {
            // Remove selection highlight from other options within the SAME store group
            const storeGroup = document.getElementById(`store-group-${lojaId}`);
            if (storeGroup) {
                storeGroup.querySelectorAll('.result-card').forEach(card => {
                    card.classList.remove('selected-shipping');
                });
            }
            // Add highlight to the selected card
            element.closest('.result-card').classList.add('selected-shipping');

            // Store the selected cost and details for this store
            fretesSelecionados[lojaId] = preco;
            detalhesFretesSelecionados[lojaId] = { custo: preco, metodo: metodo, prazo: prazo };
            console.log(`Frete selecionado para Loja ${lojaId}: R$ ${preco.toFixed(2)}`);

            // Recalculate total shipping cost
            totalFreteSelecionado = Object.values(fretesSelecionados).reduce((sum, cost) => sum + cost, 0);
            console.log("Frete total selecionado atualizado:", totalFreteSelecionado.toFixed(2));

            // Update the final price display
            atualizarPrecoFinal();

            // Check if all stores have a selection (or calculation failed) to show checkout button
            const allStoresHandled = Object.keys(produtosPorLoja).every(id => fretesSelecionados[id] !== undefined); // Check if entry exists
            if (allStoresHandled) {
                document.getElementById('finalPriceContainer').style.display = 'block';
                document.getElementById('checkoutBtn').style.display = 'block';
            } else {
                 document.getElementById('finalPriceContainer').style.display = 'none';
                 document.getElementById('checkoutBtn').style.display = 'none';
            }
        }

        /**
         * Updates the calculation and display of the final price (Subtotal + Total Shipping).
         */
        function atualizarPrecoFinal() {
            const precoFinal = totalCarrinho + totalFreteSelecionado;
            const finalPriceSpan = document.getElementById('precoFinal');
            if (finalPriceSpan) {
                finalPriceSpan.textContent = precoFinal.toFixed(2);
            }
             console.log(`Pre√ßo final atualizado: Subtotal(${totalCarrinho.toFixed(2)}) + Frete Total(${totalFreteSelecionado.toFixed(2)}) = ${precoFinal.toFixed(2)}`);
        }

        /**
         * Proceeds to checkout: Saves selected shipping details and totals to Parse Cliente object.
         */
        async function prosseguirCheckout() {
            // Check if shipping has been calculated and selected for all stores
            const allStoresSelected = Object.keys(produtosPorLoja).every(id => detalhesFretesSelecionados[id] !== null || !produtosPorLoja[id].cepOrigem); // Allow skipping if CEP was invalid
            if (!allStoresSelected) {
                alert("‚ö†Ô∏è Por favor, calcule e selecione uma op√ß√£o de frete para cada loja antes de prosseguir.");
                return;
            }
            if (totalCarrinho <= 0) {
                 alert("‚ö†Ô∏è Seu carrinho est√° vazio. Adicione produtos antes de prosseguir.");
                 return;
            }

            console.log("Prosseguindo para checkout... Salvando dados no Parse.");
            const checkoutButton = document.getElementById('checkoutBtn');
            checkoutButton.disabled = true;
            checkoutButton.innerHTML = '<span class="emoji">‚è≥</span> Salvando...';

            const parseUser = Parse.User.current();
            if (!parseUser) {
                 alert("‚ö†Ô∏è Erro: Usu√°rio n√£o logado. N√£o √© poss√≠vel salvar.");
                 checkoutButton.disabled = false;
                 checkoutButton.innerHTML = '<span class="emoji">‚úÖ</span> Prosseguir para Checkout';
                 return;
            }

            const Cliente = Parse.Object.extend("Cliente");
            const query = new Parse.Query(Cliente);
            query.equalTo("usuario", parseUser);

            try {
                const cliente = await query.first();
                if (!cliente) {
                    throw new Error("Objeto Cliente n√£o encontrado para este usu√°rio.");
                }

                // Prepare shipping details array
                const shippingDetailsArray = Object.entries(detalhesFretesSelecionados)
                    .filter(([lojaId, details]) => details !== null) // Only include selected ones
                    .map(([lojaId, details]) => ({
                        lojaId: lojaId,
                        lojaNome: produtosPorLoja[lojaId]?.nome || 'Desconhecida', // Add store name for clarity
                        custo: details.custo,
                        metodo: details.metodo,
                        prazo: details.prazo
                    }));

                // Data to save
                const finalTotal = totalCarrinho + totalFreteSelecionado;
                cliente.set("freteDetalhes", shippingDetailsArray); // Array of selected shipping details per store
                cliente.set("freteTotal", totalFreteSelecionado); // Total shipping cost
                cliente.set("subtotalProdutos", totalCarrinho); // Subtotal of products
                cliente.set("precoFinalTotal", finalTotal); // Grand total
                cliente.set("cepDestinoCheckout", document.getElementById('cep_destino').value); // Save destination CEP used
                cliente.set("enderecoDestinoCheckout", { // Save destination address used
                         logradouro: document.getElementById('logradouro').value,
                         bairro: document.getElementById('bairro').value,
                         cidade: document.getElementById('cidade').value,
                         uf: document.getElementById('uf').value
                     });

                await cliente.save();
                console.log("Dados do checkout salvos no objeto Cliente:", cliente.id);

                // Clear localStorage if previously used (optional cleanup)
                // localStorage.removeItem('checkoutData');

                alert("‚úÖ Dados do pedido salvos! Redirecionando para o checkout...");
                window.location.href = 'checkout.html'; // Redirect to checkout page

            } catch (error) {
                console.error("Erro ao salvar dados do checkout no Parse:", error);
                alert("‚ùå Ocorreu um erro ao salvar os dados do pedido: " + error.message + "\nTente novamente.");
                checkoutButton.disabled = false;
                checkoutButton.innerHTML = '<span class="emoji">‚úÖ</span> Prosseguir para Checkout';
            }
        }

    </script>
</body>
</html>
